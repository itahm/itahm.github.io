<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM</title>
		
		<style>
@import "css/itahm.css";

body {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	display: flex;
	flex-direction: column;
}

header img {
	float: right;
	cursor: pointer;
}

ul {
	margin: 0;
	padding: 0;
	list-style: none;
	display: flex;
}

select {
	padding: .5em;
}

section.information {
	overflow: hidden;
}

section.information li {
	flex: 1;
	min-width: 120px;
	padding: 10px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

section.information ul:first-child {
	background-color: #0084ff;
	color: #fff;
}

section.information ul:first-child li {
	text-align: center;
	font-weight: bold;
}

section.select {
	padding: 10px;
}

section.select label,
section.select select {
	margin: 0 5px;
	display: inline-block;
	padding: .3em 1em;
	border-radius: 1em;
	border: 1px solid #07f;
	/*background: linear-gradient(#7af, #0084ff);
	color: #fff;*/
}

label input {
	vertical-align: middle;
	margin: 0;
}

nav {
	margin: 10px 10px 0 10px;
	display: flex;
	justify-content: space-between;
}

#legend:not(.responsetime) .responsetime,
#legend:not(.processor) .processor,
#legend:not(.memory) .memory,
#legend:not(.storage) .storage,
#legend:not(.throughput) .throughput {
	display: none;
}

#legend span.legend {
	display: inline-block;
	width: 16px; height: 16px;
}

#legend span.ifInOctets {
	background-color: #7d7;
}

#legend span.ifOutOctets {
	background-color: #ffb347;
}

#status {
	font-weight: bold;
	color: #0f0;
}

#status:not(.shutdown):after {
	content: "up";
}

#status.shutdown:after {
	color: #f00;
	content: "down";
}

/* svg */
section.chart {
	background: #fff url(img/chart.png) no-repeat center;
	flex: 1;
	position: relative;
}

#chart {
	position: absolute; top: 0; right: 0; bottom: 0; left: 0;
	margin: 0;
	padding: 0;
	border: 0;
	width: 100%;
	height: 100%;
}

#grid path {
	stroke: #ddd;
	stroke-width: .5;
	fill: none;
}

#graph path {
	stroke: /*#e0ffff*/#fc0;
	stroke-width: 2;
	fill: none;
}

#axis_left text {
	text-anchor: end;
}

#axis_right text {
	text-anchor: start;
}

#end_label text {
	text-anchor: end;
}

body.start #start_fixed,
body.end #end_fixed,
body:not(.start) #start_move,
body:not(.end) #end_move {
	display: none;
}

option[value="ifInOctets"] {
	padding: 4px 4px 4px 20px;
}
		</style>
		
	</head>
	
	<body>
		
		<section class="select">
			<a href="map.html">Map</a>
			<a href="status.html">Status</a>
			
			<label>
				<input type="radio" id="select_response" name="resource" checked>Response time
			</label>

			<label>
				<input type="radio" id="select_processor" name="resource">Processor load
			</label>

			<label>
				<input type="radio" id="select_memory" name="resource">physical memory
			</label>

			<label>
				<input type="radio" id="select_storage" name="resource">Storage usage
			</label>

			<select id="select_iface">
				<option value="-1" selected>Interface throughput
			</select>
		</section>
		
		<nav>
			<select id="mode">
				<option selected>max
				<option>avg
				<option>min
			</select>
			<div id="legend">
				<div class="processor">
					<span id="processor">100%</span>
				</div>
				<div class="memory">
					<span id="memory">memory</span>
				</div>
				<div class="throughput">
					<span id="bandwidth">bandwidth</span>
					<span class="ifInOctets legend"></span>
					<span>in</span>
					<span class="ifOutOctets legend"></span>
					<span>out</span>
				</div>
			</div>
		</nav>
		
		<section class="chart">
			<iframe id="chart"></iframe>
		</section>
		
		<div class="bg_loading"></div>
		
		<script src="js/ITAhM.js"></script>
		<script src="js/object.js"></script>
		<script src="js/snmp.js"></script>
		<script src="js/Draggable.js"></script>
		<script>

// 공통
var svgNS = "http://www.w3.org/2000/svg",
	xlinkNS = "http://www.w3.org/1999/xlink",
	// agent timeout 값과 맞춰줘야함.
	RESPONSE_TIMEOUT = 5000;

var elements = {
		
	};
	
// 공통
(function (window, undefined) {
	
	var name = document.getElementById("name"),
		chart = document.getElementById("chart"),
		mode = document.getElementById("mode"),
		chartData;
	
	mode.onchange = function () {
		chart.contentWindow.mode(this.value);
	};
	
	top.sendRequest({
			command: "select",
			ip: top.databases.local.selected
		}, function (response) {
			initialize(device, response);
		});
	
	function sendRequest(database, index, start, end, callback, summary) {
		var request = {
				command: "query",
				ip: top.databases.local.selected,
				summary: summary,
				database: database,
				index: index,
				start: start,
				end: end
			};
		
		top.sendRequest(request, callback);
	}
	
	function initialize (device, snmp) {				
		initProcessor(snmp);
		initStorage(snmp);
		initThroughput(snmp);
		
		chart.onload = function () {
			chart.contentWindow.onDrawDetailGraph = function (start, end) {
				drawDetailGraph(start, end);
			}
			
			onSelectResponseTime();
		};
		
		chart.src = "chart.html";
	};
	
	window.getDetailData = function (database, index, start, end, callback) {
		sendRequest(database, index, start, end, callback, false);
	};
	
	window.getSummaryData = function (database, index, callback) {
		var date = new Date(),
			end = date.setDate(date.getDate() +1),
			start = date.setFullYear(date.getFullYear() -1);
		
		sendRequest(database, index, start, end, callback, true);
	};
	
	window.initChart = function (origin, capacity, valueToString) {		
		chart.contentWindow.initChart(origin, mode.value, capacity, valueToString);
		
		document.body.classList.remove("loading");
	};
	
	window.updateChart = function (data) {
		chartData = chart.contentWindow.updateChart(data);
	};
	
}) (window);

// response time
(function (window, undefined) {
	
	var legend = document.getElementById("legend"),
		summary, start, end;
	
	document.getElementById("select_response").onchange = onSelectResponseTime;
	
	window.onSelectResponseTime = onSelectResponseTime;
	
	function onSelectResponseTime() {
		document.body.classList.add("loading");
		
		disableThroughput();
		
		selectResponseTime();
	}
	
	function valueToString(value) {
		return value.toFixed(2) + "ms";
	}
	
	function onResponse(data) {		
		if (summary) {
			window.drawDetailGraph = sendDetailRequest;
			
			initChart({
				0: new ITAhM.ChartSummaryData(data)
			}, RESPONSE_TIMEOUT, valueToString);
		}
		else {
			updateChart({
				0: new ITAhM.ChartData(data)
			});
		}
	}
	
	function selectResponseTime() {
		legend.className = "responsetime";
		
		summary = true;
		
		getSummaryData("responseTime", 0, onResponse);
	}
	
	function sendDetailRequest(s, e) {
		summary = false;
		start = s;
		end = e;
		
		getDetailData("responseTime", 0, start, end, onResponse);
	}
	
}) (window);

// processor
(function (window, undefined) {
	
	var legend = document.getElementById("legend"),
		summary, start, end,
		indexArray = [], indexPos,
		origin = {}, detail = {};
	
	document.getElementById("select_processor").onchange = function () {
		document.body.classList.add("loading");
		
		disableThroughput();
		
		selectProcessorLoad();
	};
	
	function valueToString(value) {
		return value.toFixed(2) + "%";
	}
	
	function onResponse(data) {
		if (summary) {
			origin[indexArray[indexPos++]] = new ITAhM.ChartSummaryData(data);
		}
		else {
			detail[indexArray[indexPos++]] = new ITAhM.ChartData(data);
		}
		
		tryRequest();
	}
	
	function tryRequest() {
		if (indexPos < indexArray.length) {
			if (summary) {
				getSummaryData("hrProcessorLoad", indexArray[indexPos], onResponse);
			}
			else {
				getDetailData("hrProcessorLoad", indexArray[indexPos], start, end, onResponse);
			}
		}
		else {
			if (summary) {
				window.drawDetailGraph = sendDetailRequest;
				
				initChart(origin, 100, valueToString);
			}
			else {
				updateChart(detail);
			}
		}
	}
	
	function selectProcessorLoad() {
		legend.className = "processor";
		
		summary = true;
		
		indexPos = 0;
		
		tryRequest();
	};
	
	function sendDetailRequest(s, e) {
		summary = false;
		start = s;
		end = e;
		
		indexPos = 0;
		
		tryRequest();
	}
	
	window.initProcessor = function (snmp) {
		for (var index in snmp.hrProcessorEntry) {
			indexArray[indexArray.length] = index;
		}
	};
	
}) (window);

// storage
(function (window, undefined) {
	
	var legend = document.getElementById("legend"),
		summary, start, end,
		indexArray = [], indexPos,
		origin = {}, detail = {},
		capacity;
	
	document.getElementById("select_storage").onchange = function () {
		document.body.classList.add("loading");
			
		disableThroughput();
		
		selectStorageUsage();
	};
	
	function valueToString(value) {
		return ITAhM.util.toBytesString(value).replace("ytes", "");
	}
	
	function onResponse(data) {
		if (summary) {
			origin[indexArray[indexPos++]] = new ITAhM.ChartSummaryData(data);
		}
		else {
			detail[indexArray[indexPos++]] = new ITAhM.ChartData(data);
		}
		
		tryRequest();
	}
	
	function tryRequest() {
		if (indexPos < indexArray.length) {
			if (summary) {
				getSummaryData("hrStorageUsed", indexArray[indexPos], onResponse);
			}
			else {
				getDetailData("hrStorageUsed", indexArray[indexPos], start, end, onResponse);
			}
		}
		else {
			if (summary) {
				window.drawDetailGraph = sendDetailRequest;
				
				initChart(origin, capacity, valueToString);	
			}
			else {
				updateChart(detail);
			}
		}
	}
	
	function selectStorageUsage() {
		legend.className = "storage";
		
		summary = true;
		
		indexPos = 0;
		
		tryRequest();
	};
	
	function sendDetailRequest(s, e) {
		summary = false;
		start = s;
		end = e;
		
		indexPos = 0;
		
		tryRequest();
	}
	
	window.initStorage = function (snmp) {
		var storage,
			capacityArray = [];
		
		for (var index in snmp.hrStorageEntry) {
			storage = snmp.hrStorageEntry[index];
			
			// size가 0인 것 제외.
			if (storage.hrStorageSize > 0) {
				// hrStorageFixedDisk 
				if (storage.hrStorageType === 4) {
					capacityArray[capacityArray.length] = storage.hrStorageSize * storage.hrStorageAllocationUnits;
					
					indexArray[indexArray.length] = index;
				}
				// hrStorageRam
				else if (storage.hrStorageType === 2) {
					initMemory(index, storage);
				}
			}
		}
		//storage는 각 디스크마다 용량이 다르므로 표시할 수 없음
		//capacity = Math.max.apply(undefined, capacityArray);
	};
	
}) (window);

// memory
(function (window, undefined) {
	
	var legend = document.getElementById("legend"),
		summary, start, end,
		indexArray = [], indexPos,	
		origin = {}, detail = {},
		capacity;	

	document.getElementById("select_memory").onchange = function () {
		document.body.classList.add("loading");
			
		disableThroughput();
		
		selectMemoryUsage();
	};

	
	function valueToString(value) {
		return ITAhM.util.toBytesString(value).replace("ytes", "");
	}
	
	function onResponse(data) {
		if (summary) {
			origin[indexArray[indexPos++]] = new ITAhM.ChartSummaryData(data);
		}
		else {
			detail[indexArray[indexPos++]] = new ITAhM.ChartData(data);
		}
		
		tryRequest();
	}
	
	function tryRequest() {
		if (indexPos < indexArray.length) {
			if (summary) {
				getSummaryData("hrStorageUsed", indexArray[indexPos], onResponse);
			}
			else {
				getDetailData("hrStorageUsed", indexArray[indexPos], start, end, onResponse);
			}
		}
		else {
			if (summary) {
				window.drawDetailGraph = sendDetailRequest;
				
				initChart(origin, capacity, valueToString);	
			}
			else {
				updateChart(detail);
			}
		}
	}
	
	function selectMemoryUsage() {
		legend.className = "memory";
		
		summary = true;
		
		indexPos = 0;
		
		tryRequest();
	};
	
	function sendDetailRequest(s, e) {
		summary = false;
		start = s;
		end = e;
		
		indexPos = 0;
		
		tryRequest();
	}
	
	window.initMemory = function (index, m) {
		indexArray[0] = index;
		
		capacity = m.hrStorageSize * m.hrStorageAllocationUnits;

		document.getElementById("memory").textContent = ITAhM.util.toBytesString(capacity);
	};
	
}) (window);

// throughput
(function (window, undefined) {
	
	var legend = document.getElementById("legend"),
		summary, start, end,
		ifEntry,
		list = document.getElementById("select_iface"),
		bandwidth = document.getElementById("bandwidth"),
		databaseArray = [], indexPos,
		origin = {}, detail = {};
		
	list.onchange = function () {
		document.body.classList.add("loading");
		
		selectThroughput();
	};
	
	function valueToString(value) {
		return ITAhM.util.toBPSString(value);
	}
	
	function onResponse(data) {
		if (summary) {
			origin[databaseArray[indexPos++]] = new ITAhM.ChartSummaryData(data);
		}
		else {
			detail[databaseArray[indexPos++]] = new ITAhM.ChartData(data);
		}
		
		tryRequest();
	}
	
	function tryRequest() {
		if (indexPos < databaseArray.length) {
			if (summary) {
				getSummaryData(databaseArray[indexPos], list.value, onResponse);
			}
			else {
				getDetailData(databaseArray[indexPos], list.value, start, end, onResponse);
			}
		}
		else {
			if (summary) {
				window.drawDetailGraph = sendDetailRequest;
				
				initChart(origin, list.options[list.selectedIndex].dataset.speed, valueToString);	
			}
			else {
				updateChart(detail);
			}
		}
	}
	
	function selectThroughput() {
		legend.className = "throughput";
		
		summary = true;
		
		indexPos = 0;
		
		// bandwidth set
		bandwidth.textContent = ITAhM.util.toBPSString(ifEntry[list.value].ifSpeed);
		
		tryRequest();
	};
	
	function sendDetailRequest(s, e) {
		summary = false;
		start = s;
		end = e;
		
		indexPos = 0;
		
		tryRequest();
	}
	
	window.disableThroughput = function () {
		list.value = "-1";
	};
	
	window.initThroughput = function (snmp) {
		var t;
		
		ifEntry = snmp.ifEntry;
		
		for (index in snmp.ifEntry) {
			t = ifEntry[index];
			
			if (t.ifSpeed === 0) {
				continue;
			}
			
			option = document.createElement("option");
			option.value = index;
			option.dataset.speed = t.ifSpeed;
			option.text = t.ifName;
			option.title = t.ifDescr;
			
			list.appendChild(option);
		}
		
		databaseArray = ["ifInOctets", "ifOutOctets"];
		
		//disableThroughput();
	};
	
}) (window);

function onSelectDevice(ip) {
	top.databases.device.selected = ip;
	
	location.reload();
}

		</script>
	
	</body>
	
</html>