<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM</title>
		
		<style>
		
@import "css/itahm.css";

body {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	margin: 0; padding: 0;
	display: flex;
	flex-direction: column;
}

#chart {
	display: flex;
	flex: 1;
	flex-direction: column;
}

body.row #chart {
	flex-direction: row;
}

.chart {
	flex: 1;
	display: flex;
	flex-direction: column;
}

iframe {
	flex: 1;
	border: none;
	width: 100%; height: 100%;
}

nav {
	text-align: right;
}

h1 {
	font-size: 16px;
	margin: .5em;
	padding: .5em 1em;
	background-color: #0084ff;
	color: #fff;
	display: inline-block;
	border-radius: 1em;
}

h2 {
	text-align: center;
}

#legend {
	text-align: right;
}

#if_name {
	margin: 0;
}

h3 {
	margin: 0;
	padding: 0 20px;
}

h3.input {
	color: #7d7;
}

h3.output {
	color: #f60;
}

		</style>
		
	</head>
	
	<body>
		<header>
			<h1>통신 사용 @ <span id="host"></span></h1>
			<h2 id="if_name"></h2>
			<div id="legend"></div>
		</header>
		
		<nav>
			<select id="view">
				<option value="add">가로 보기
				<option value="remove" selected>세로 보기
			</select>
		</nav>
		<div id="chart">
			<div class="chart">
				<h3 class="input">Input</h3>
				<iframe id="chart_in" src="chart_base.html"></iframe>
			</div>
			<div class="chart">
				<h3 class="output">Output</h3>
				<iframe id="chart_out" src="chart_base.html"></iframe>
			</div>
		</div>
		
		<script src="js/ITAhM.js"></script>	
		<script src="js/object.js"></script>
		<script>

var chartIn = document.getElementById("chart_in"),
	chartInWindow = chartIn.contentWindow,
	chartOut = document.getElementById("chart_out"),
	chartOutWindow = chartOut.contentWindow,
	deviceIP = top.databases.local.selected,
	resourceIndex = top.databases.local.resourceIndex,
	node = top.databases.local.node;

if(!deviceIP || !window.resourceIndex || !window.node) {
	throw "!";
}

document.getElementById("host").textContent = window.deviceIP;

document.getElementById("view").onchange = function () {
	document.body.classList[this.value]("row");
}

function initialize(from, to, start, end) {
	var entry = window.node.ifEntry[window.resourceIndex],
		request = {
			command: "query",
			ip: window.deviceIP,
			summary: true,
			index: window.resourceIndex,
			start: from,
			end: to
		};
	
	window.max = entry.ifSpeed;
	window.start = start;
	window.end = end;
	
	document.getElementById("if_name").textContent = entry.ifName;
	
	request.database = "ifInOctets";
	top.sendRequest(request, onSummaryInResponse);
	
	request.database = "ifOutOctets";
	top.sendRequest(request, onSummaryOutResponse);
	
	document.getElementById("legend").textContent = "bandwidth : "+ ITAhM.util.toBPSString(max);
}

function onSummaryInResponse(data) {
	window.chartInWindow.initialize(window.summaryInData = new ITAhM.ChartSummaryData(data), window.max, "#7d7", onValueToString);
	
	drawIn();
}

function onSummaryOutResponse(data) {
	window.chartOutWindow.initialize(window.summaryOutData = new ITAhM.ChartSummaryData(data), window.max, "#f60", onValueToString);
	
	drawOut();
}

function onValueToString(value) {
	return ITAhM.util.toBPSString(value);
}

/**
 * private
 */
function sendDetailRequest(database, callback) {
	var request = {
			command: "query",
			ip: window.deviceIP,
			summary: false,
			index: window.resourceIndex,
			start: window.start,
			end: window.end
		};
	
	request.database = database;
	
	top.sendRequest(request, callback);
}

/**
 * private
 */
function onDetailInResponse(data) {
	window.chartInWindow.detail(window.detailInData = new ITAhM.ChartData(data));
}

/**
 * private
 */
function onDetailOutResponse(data) {
	window.chartOutWindow.detail(window.detailOutData = new ITAhM.ChartData(data));
}

/**
 * private
 */
function drawIn() {
	var date = new Date(window.start);
	
	if (window.chartInWindow.draw(window.start, window.end) && date.setDate(date.getDate() +1) === window.end) {
		sendDetailRequest("ifInOctets", onDetailInResponse);
	}
	else {
		window.detailInData = undefined;
	}
}

/**
 * private
 */
function drawOut() {
	var date = new Date(window.start);
	
	if (window.chartOutWindow.draw(window.start, window.end) && date.setDate(date.getDate() +1) === window.end) {
		sendDetailRequest("ifOutOctets", onDetailOutResponse);
	}
	else {
		window.detailOutData = undefined;
	}
}

/**
 * public
 */
function draw(start, end) {
	window.start = start;
	window.end = end;
	
	drawIn();
	drawOut();
}

/**
 * public
 */
function getFile() {
	var buildFunc, dataIn, dataOut;
	
	if (window.detailInData) {
		buildFunc = buildDetailFile;
		dataIn = window.detailInData;
		dataOut = window.detailOutData;
	}
	else {
		buildFunc = buildSummaryFile;
		dataIn = window.summaryInData;
		dataOut = window.summaryOutData;
	}
	
	buildFunc(dataIn, window.chartInWindow.chartData, "chart_throughput_in.csv");
	buildFunc(dataOut, window.chartOutWindow.chartData, "chart_throughput_out.csv");
}

function buildDetailFile(detailData, chartData, fileName) {
	var blocks = chartData.keys,
		row = ["index,date,interface throughput(bps)"],
		block, date, mills, value, k = 0;
	
	if (chartData) {
		for (var i=0, _i=blocks.length; i<_i; i++) {
			block = blocks[i];
			
			for (var j=0, _j=block.length; j<_j; j++) {
				mills = block[j];
				
				date = new Date(mills);
				
				row[row.length] = [k++, ITAhM.util.toDateTimeString(date), detailData.get(mills)].join(",");
			}
		}
	}
	
	ITAhM.util.download(new Blob([row.join("\n")] ,{
		type: "text/csv;charset=utf-8;"
	}), fileName);
}

function buildSummaryFile(summaryData, chartData, fileName) {
	var blocks = chartData.keys,
		row = ["index,date,max,avg,min"], 
		block, date, mills, value, k = 0;
	
	if (chartData) {
		for (var i=0, _i=blocks.length; i<_i; i++) {
			block = blocks[i];
			
			for (var j=0, _j=block.length; j<_j; j++) {
				mills = block[j];
				value = summaryData.get(mills);
				
				date = new Date(mills);
				
				row[row.length] = [k++, ITAhM.util.toDateTimeString(date), value.max, value.avg, value.min].join(",");
			}
		}
	}
	
	ITAhM.util.download(new Blob([row.join("\n")] ,{
		type: "text/csv;charset=utf-8;"
	}), fileName);
}

		</script>
	
	</body>
	
</html>