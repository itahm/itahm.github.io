<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM</title>
		
		<style>
@import "css/itahm.css";

body, input, button {
	margin: 0;
	padding: 0; 
}

#map {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	width: 100%; height: 100%;
	animation-duration: .5s;
	animation-timing-function:  cubic-bezier(.9, .1, .9, .1);*/
}

/* svg*/

text::selection {
	background: none;
}

text {
	font-family: tahoma, arial, "맑은 고딕";
	font-size: 10px;
	fill: #000;
	text-anchor: middle;
}

#line line {
	stroke: #836953;
	stroke-width: 2;
}

body.extra #line line {
	stroke: #f5d04c;
}

#line text {
	font-size: 11px;
	fill: #333;
}

#link line {
	stroke: #800;
	stroke-width: 2;
	stroke-dasharray: 2, 2;
}

#device text {
	font-size: 12px;
	fill: #000;
}

body.extra #device text {
	fill: #fff;
}

#selection_mark {
	/*stroke: #fdd400;*/
	stroke: rgba(0, 132, 255, .5);
	stroke-width: 5px;
	fill: #fff;
}
/*
#tool circle {
	stroke: #800;
	stroke-width: 1px;
	fill: #f00;
}
*/
use.shutdown {
	stroke-width: 5;
	stroke: rgba(255, 0, 0, .5);
	fill: none;
	animation: alert 2s infinite;
}

use.critical {
	stroke-width: 5;
	stroke: rgba(255, 255, 0, .5);
	fill: none;
}

@keyframes initialize {
	from {
		transform: rotate(0) scale(.1);
	}
    to {
    	transform: rotate(360deg) scale(1);
    }
}

@keyframes alert {
    from {
    	opacity: 0;
    }
    to {
    	opacity: 1;
    }
}

body.loading g,
#anchor:not(.snmp) #chart_anchor,
#anchor:not(.snmp) #alarm_anchor {
	display: none;
}

/* dialog */
body:not(.dialog) #dialog {
	display: none;
}

/* chart */
#chart {
	background-color: #fff;
}
/*
body:not(.chart) #chart {
	display: none;
}*/

/* 공통 */
.fullscreen {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
}

body.name tspan:last-child,
body:not(.name) tspan:first-child,
body:not(.ifname) #line text {
	display: none;
}

		</style>
		
		<script>
		
function zoom(ratio) {
	window.scale = ratio;
	
	transform.getItem(1).setScale(ratio, ratio);
}
	
function resize() {
	rect = mapCanvas.getBoundingClientRect();
	
	transform.getItem(0).setTranslate(rect.width /2, rect.height /2);
}
	
function moveMap(x, y) {
	transform.getItem(2).setTranslate(x, y);
}
	
function restoreMap() {
	var matrix = transform.getItem(2).matrix;

	moveAllDevice(matrix.e, matrix.f);

	moveMap(0, 0);
}
	
function onDragStart(e) {
	var data = e.detail,
		target = data.target;
	
	if (window.selected) {
		//var selectedSvgDevice = window.iconData[window.selected];
		var pos = window.posData[window.selected];
		
		window.dragOrigin = {
			x: pos.x,
			y: pos.y
		};
		
		/*if (target === selectedSvgDevice) {
		}
		else*/ if (target === linkAnchor) {
			setLinkAnchor(window.dragOrigin.x, window.dragOrigin.y, window.dragOrigin.x, window.dragOrigin.y -34);
		}
	}
	
	window.cancelSelect = true;
}
	
function onDragMove(e) {
	var data = e.detail,
		target = data.target,
		selectedSvgDevice = window.iconData[window.selected];
	
	if (target === selectedSvgDevice) {
		var x = window.dragOrigin.x + Math.round(data.dragX / window.scale /10) *10,
			y = window.dragOrigin.y + Math.round(data.dragY / window.scale /10) *10;
		
		moveSelectionMark(x, y);
		
		moveDevice(window.selected, x, y);
	}
	else if (target === linkAnchor) {
		var destination = data.destination,
			x = window.dragOrigin.x + Math.round(data.dragX / window.scale),
			y = window.dragOrigin.y + Math.round(data.dragY / window.scale);
		
		if (isDevice(destination) &&  destination !== selectedSvgDevice) {
			moveLinkAnchor(Number(destination.getAttributeNS(null, "x")), Number(destination.getAttributeNS(null, "y")));
		}
		else {
			moveLinkAnchor(x, y - 34);
		}
	}
	else {
		var x = Math.round(data.dragX / window.scale /10) *10,
			y = Math.round(data.dragY / window.scale /10) *10;
		
		moveMap(x, y);
	}
}

function onDragEnd(e) {
	var data = e.detail,
		target = data.target,
		destination = data.destination,
		eventData = {},
		event = ITAhM.util.createCustomEvent("link", eventData),
		selectedSvgDevice = window.iconData[window.selected];
	
	if (target === selectedSvgDevice) {
	}
	else if (target === linkAnchor) {
		mapCanvas.appendChild(linkAnchor);
		
		restoreLinkAnchor();
		
		if (isDevice(destination) &&  destination !== selectedSvgDevice) {
			eventData.peer = window.selected;
			
			destination.dispatchEvent(event);
		}
	}
	else {
		restoreMap();
	}
}
	
function moveAllDevice(x, y) {
	var pos;
	
	if (window.selected) {
		pos = window.posData[window.selected];
		
		moveSelectionMark(pos.x + x, pos.y + y);
	}
	
	for (var ip in window.deviceData) {
		pos = window.posData[ip];
		
		moveDevice(ip, pos.x + x, pos.y + y);
	}
}
	
function onCancelSelect() {
	if (window.cancelSelect) {
		window.cancelSelect = false;
	}
	else {
		clearSelectionMark();
		
		window.selected = undefined;
	}
}
	
function selectDevice(ip) {
	if (window.cancelSelect) {
		window.cancelSelect = false;
	}
	else {
		var pos = window.posData[ip];
		
		window.selected = ip;
		
		showSelectionMark(pos.x, pos.y, window.monitorData[ip]);
		
		topDevice(window.iconData[ip]);
	}
}

function moveLine(x, y, data, direct) {
	var svgDevice, pos,
		x1, y1, x2, y2;

	svgDevice = data.svg;
	
	if (direct) {
		pos = window.posData[data.peer2];
		
		svgDevice.setAttributeNS(null, "x1", x);
		svgDevice.setAttributeNS(null, "y1", y);
		
		x1 = x;
		y1 = y;
		x2 = pos.x;
		y2 = pos.y;
	}
	else {
		pos = window.posData[data.peer1];
		
		svgDevice.setAttributeNS(null, "x2", x);
		svgDevice.setAttributeNS(null, "y2", y);
		
		x1 = pos.x;
		y1 = pos.y;
		x2 = x;
		y2 = y;
	}
	
	data.name1.setAttributeNS(null, "x", (x1 *2 + x2) /3);
	data.name1.setAttributeNS(null, "y", (y1 *2 + y2) /3);
	
	data.name2.setAttributeNS(null, "x", (x2 *2 + x1) /3);
	data.name2.setAttributeNS(null, "y", (y2 *2 + y1) /3);
}

function addDevice(ip) {
	var device = window.deviceData[ip],
		pos = window.posData[ip],
		svgDevice = document.createElementNS(svgNS, "image"),
		svgLabel = document.createElementNS(svgNS, "text"),
		svgAddr = document.createElementNS(svgNS, "tspan"),
		svgName = document.createElementNS(svgNS, "tspan");

	svgDevice.setAttributeNS(null, "x", pos.x);
	svgDevice.setAttributeNS(null, "y", pos.y);
	svgDevice.setAttributeNS(null, "width", "40px");
	svgDevice.setAttributeNS(null, "height", "40px");
	svgDevice.setAttributeNS(null, "transform", "translate(-20, -20)");
	
	svgDevice.onclick = onSelectDevice.bind(undefined, ip);
	svgDevice.addEventListener("link", onLink.bind(undefined, ip));
	
	window.deviceCanvas.appendChild(svgDevice);
	
	svgName.textContent = device.name;
	svgAddr.textContent = device.ip;
	
	svgLabel.appendChild(svgName);
	svgLabel.appendChild(svgAddr);
	
	svgLabel.setAttributeNS(null, "x", pos.x);
	svgLabel.setAttributeNS(null, "y", pos.y);
	// text baseline이 글자의 밑을 기준으로 하므로 글자 크기만큼 내려준다.
	// 아이콘 크기 + 글자 크기 = 20 + 16 = 36
	svgLabel.setAttributeNS(null, "transform", "translate(0, 36)");
	
	window.deviceCanvas.appendChild(svgLabel);
	
	window.iconData[ip] = svgDevice;
	window.labelMap[ip] = svgLabel;
	
	resetDevice(ip);
}

function resetDevice(ip, reset) {
	var device = window.deviceData[ip],
		svgDevice = window.iconData[ip],
		svgAlert = window.alertData[ip],
		pos = window.posData[ip],
		icon = getIcon(device.type || "unknown"),
		monitor;
	
	if (reset) {
		window.monitorData = top.databases.monitor;
	}
	
	monitor = window.monitorData[ip];
	
	if (!monitor) {
		svgDevice.setAttributeNS(xlinkNS, "xlink:href", icon.disabled);
		
		return;
	}
	
	svgDevice.setAttributeNS(xlinkNS, "xlink:href", icon.src);
	
	if (monitor.shutdown || monitor.critical) {
		if (!svgAlert) {
			svgAlert = document.createElementNS(svgNS, "use");
			
			svgAlert.setAttributeNS(xlinkNS, "xlink:href", "#circle");
			svgAlert.setAttributeNS(null, "x", pos.x);
			svgAlert.setAttributeNS(null, "y", pos.y);
			
			window.deviceCanvas.appendChild(svgAlert);
			
			window.alertData[ip] = svgAlert;
		}
		
		svgAlert.setAttributeNS(null, "class", monitor.shutdown? "shutdown": "critical");
	}
	else {
		if (svgAlert) {
			delete window.alertData[ip];
			
			window.deviceCanvas.removeChild(svgAlert);
		}
	}
}

function isDevice(node) {
	return node.parentNode === window.deviceCanvas && node.tagName === "image";
}

function moveDevice(ip, x, y) {
	var device = window.deviceData[ip],
		pos = window.posData[ip],
		link = window.linkData[ip],
		data;
			
	pos.x = x;
	pos.y = y;		

	var svgDevice = window.iconData[ip],
		svgLabel = window.labelMap[ip],
		svgAlert = window.alertData[ip];
	
	svgDevice.setAttributeNS(null, "x", x);
	svgDevice.setAttributeNS(null, "y", y);
	
	svgLabel.setAttributeNS(null, "x", x);
	svgLabel.setAttributeNS(null, "y", y);
	
	if (svgAlert) {
		svgAlert.setAttributeNS(null, "x", x);
		svgAlert.setAttributeNS(null, "y", y);
	}
	
	for (var peerIP in link) {
		data = link[peerIP];
	
		moveLine(x, y, data, data.peer1 === ip);
	}
}

function onSelectDevice(ip, e) {
	e.stopPropagation();
	
	selectDevice(ip);
}

function topDevice(svgDevice) {
	window.deviceCanvas.appendChild(svgDevice);
}

function moveSelectionMark(x, y) {
	window.selectionMark.setAttributeNS(null, "cx", x);
	window.selectionMark.setAttributeNS(null, "cy", y);
	
	moveAnchor(x, y);
}

function showSelectionMark(x, y, monitor) {
	window.deviceCanvas.appendChild(window.selectionMark);
	
	showTool(x, y, monitor);
	
	moveSelectionMark(x, y);
}

function clearSelectionMark() {
	document.createDocumentFragment().appendChild(window.selectionMark);
	
	hideAnchor();
}

function moveAnchor(x, y) {
	anchor.transform.baseVal.getItem(0).setTranslate(x, y);
}

function showTool(x, y, monitor) {
	anchor.setAttributeNS(null, "class", monitor? monitor.protocol: "none");
	
	toolCanvas.appendChild(anchor);
	
	moveAnchor(x, y);
}

function hideAnchor() {
	fragment.appendChild(anchor);
}

function setLinkAnchor(x1, y1, x2, y2) {
	link.appendChild(linkSVG);
	
	link.appendChild(linkAnchor);
	
	linkDrag.setTranslate(0, 0);
	
	linkAnchor.setAttributeNS(null, "x", x2);
	linkAnchor.setAttributeNS(null, "y", y2);
	
	linkSVG.setAttributeNS(null, "x1", x1);
	linkSVG.setAttributeNS(null, "y1", y1);
	linkSVG.setAttributeNS(null, "x2", x2);
	linkSVG.setAttributeNS(null, "y2", y2);
}

function moveLinkAnchor(x, y) {
	linkAnchor.setAttributeNS(null, "x", x);
	linkAnchor.setAttributeNS(null, "y", y);
	
	linkSVG.setAttributeNS(null, "x2", x);
	linkSVG.setAttributeNS(null, "y2", y);
}

function restoreLinkAnchor() {
	anchor.appendChild(linkAnchor);
	
	linkDrag.setTranslate(0, -34);
	
	linkAnchor.setAttributeNS(null, "x", 0);
	linkAnchor.setAttributeNS(null, "y", 0);
	
	fragment.appendChild(linkSVG);
}
	
function createLabel(name, x1, y1, x2, y2) {
	var labelSvg = document.createElementNS(svgNS, "text");
	
	labelSvg.textContent = name;
	
	moveLabel(labelSvg, x1, y1, x2, y2);
	
	return labelSvg;
}
	
function moveLabel(labelSvg, x1, y1, x2, y2) {
	labelSvg.setAttributeNS(null, "x", (x1 *2 + x2) /3);
	labelSvg.setAttributeNS(null, "y", (y1 *2 + y2) /3);
}
	
function addLine(ip) {
	var device = window.deviceData[ip],
		pos = window.posData[ip],
		ifEntry = device.ifEntry,
		peerList = {},
		peer, peerPos, peerIP, link, lineSvg,
		labelSvg;
	
	window.linkData[ip] = peerList;
	
	for (var peerIP in ifEntry) {
		peer = window.deviceData[peerIP];
		
		if (!peer) {
			delete ifEntry[peerIP];
			
			continue;
		}
		
		peerPos = window.posData[peerIP];
		
		labelSvg = createLabel(ifEntry[peerIP], pos.x, pos.y, peerPos.x, peerPos.y);
		
		// peer가 먼저 svg 만들었다면 공유
		if (window.linkData[peerIP]) {
			link = linkData[peerIP][ip];
			
			link.name2 = labelSvg;
		}
		else {
			lineSvg = document.createElementNS(svgNS, "line");
			
			lineSvg.setAttributeNS(null, "x1", pos.x);
			lineSvg.setAttributeNS(null, "y1", pos.y);
			lineSvg.setAttributeNS(null, "x2", peerPos.x);
			lineSvg.setAttributeNS(null, "y2", peerPos.y);
			
			link = {
				peer1: ip,
				name1: labelSvg,
				peer2: peerIP,
				svg: lineCanvas.appendChild(lineSvg)
			};
		}
		
		// label이 선보다 위에 그려지도록 나중에 붙여줌
		lineCanvas.appendChild(labelSvg);
		
		peerList[peerIP] = link;
	}
}

function initialize(extra) {
	if (extra) {
		document.body.classList.add("extra");
	}
	
	for (var ip in window.deviceData) {
		addDevice(ip);
		addLine(ip);
	}
}

function onLink(ip, e) {
	var peerIP = e.detail.peer;
	
	document.body.classList.add("loading");	
	
	top.sendRequest({
			command: "link",
			peer1: ip,
			peer2: peerIP,
			link: peerIP in window.deviceData[ip].ifEntry? false: true
		}, function (data) {
			top.databases.device = data;
			
			location.reload();
		});
}

function displayIPAddress(show) {
	document.body.classList[show? "remove": "add"]("name");
}

function displayIFName(show) {
	document.body.classList[show? "add": "remove"]("ifname");
}

function getIcon(type) {
	return window.top.databases.icon[type] || window.top.databases.local.icon[type];
}

//abstract
function onEditDevice(ip) {	
}

//abstract
function onShowChart(ip) {
}

//abstract
function onShowAlarm(ip) {
}
		
		</script>
	</head>
	
	<body class="loading name ifname">

		<svg id="map">
			<defs>
				<circle r="35" id="circle"></circle>
			</defs>
			<g id="transform" transform="translate(0, 0) scale(1, 1) translate(0, 0)">
				<g id="line"></g>
				<g id="link"></g>
				<g id="device">
					<circle r="30" id="selection_mark"></circle>
				</g>
				<g id="tool">
					<g id="anchor" transform="translate(0, 0)">
						<image xlink:href="img/svg/chart.svg" id="chart_anchor"
							transform="translate(-34, -0) translate(-8, -8)" width="16" height="16" cursor="pointer">
							<title>이 장비의 차트를 봅니다.</title>
						</image>
						<image xlink:href="img/svg/information.svg" id="edit_anchor"
							transform="translate(34, 0) translate(-8, -8)" width="16" height="16" cursor="pointer">
							<title>이 장비의 정보를 수정합니다.</title>
						</image>
						<image xlink:href="img/svg/anchor.svg" id="link_anchor"
							transform="translate(0, -34) translate(-8, -8)" width="16" height="16" cursor="pointer">
							<title>이 앵커를 드래그하여 다른 장비와 연결합니다.</title>
						</image>
						<image xlink:href="img/svg/alarm.svg" id="alarm_anchor"
							transform="translate(0, 34) translate(-8, -8)" width="16" height="16" cursor="pointer">
							<title>성능의 임계값을 설정합니다.</title>
						</image>
					</g>
				</g>
			</g>
		</svg>
		
		<script src="js/ITAhM.js"></script>
		<script src="js/Draggable.js"></script>
		<script src="js/Communicator.js"></script>
		<script>

var svgNS = "http://www.w3.org/2000/svg",
	xlinkNS = "http://www.w3.org/1999/xlink";

var mapCanvas = document.getElementById("map"),
	deviceCanvas = document.getElementById("device"),
	toolCanvas = document.getElementById("tool"),
	lineCanvas = document.getElementById("line"),
	deviceData = top.databases.device,
	posData = top.databases.position,
	monitorData = top.databases.monitor,
	selectionMark = document.getElementById("selection_mark"),
	linkAnchor = document.getElementById("link_anchor"),
	transform = document.getElementById("transform").transform.baseVal,
	link = document.getElementById("link"),
	anchor = document.getElementById("anchor"),
	chartAnchor = document.getElementById("chart_anchor"),
	alarmAnchor = document.getElementById("alarm_anchor"),
	editAnchor = document.getElementById("edit_anchor"),
	linkDrag = linkAnchor.transform.baseVal.getItem(0),
	linkSVG = document.createElementNS(svgNS, "line"),
	fragment = document.createDocumentFragment(),
	linkData = {},
	iconData = {},
	labelMap = {},
	alertData = {},
	scale = 1,
	cancelSelect = false,
	dragOrigin;

new Draggable(mapCanvas);

mapCanvas.addEventListener("click", onCancelSelect);
mapCanvas.addEventListener("dragon", onDragStart);
mapCanvas.addEventListener("drag", onDragMove);
mapCanvas.addEventListener("dragoff", onDragEnd);

document.onselectstart = function () {
	return false;
}
	
chartAnchor.onclick = function (e) {
	onShowChart(window.selected);
	
	e.stopPropagation();
};

alarmAnchor.onclick = function (e) {
	onShowAlarm(window.selected);
	
	e.stopPropagation();
};

editAnchor.onclick = function (e) {
	onEditDevice(window.selected);
	
	e.stopPropagation();
};

resize();

clearSelectionMark();

document.body.classList.remove("loading");

mapCanvas.style.animationName = "initialize";

		</script>
	
	</body>
	
</html>