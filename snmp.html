<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>@ ITAhM</title>

		<style>
@import "css/itahm.css";

article,
.resource {
	display: flex;
	flex-wrap: wrap;
}

body.view_mode article {
	justify-content: space-around;
}

section {
	padding: 10px;
	margin: 10px;
	border: 1px solid #0084ff;
	border-radius: 5px;
}

.gauge {
	display: flex;
	width: 60px;
	height: 120px;
	justify-content: center;
	align-items: center;
	border: 1px solid #999;
	border-radius: 10px;
	position: relative;
	overflow: hidden;
}

.gauge> div {
	position: absolute;
	bottom: 0;
	left: 0;
	width: 100%;
	background-color: #7d7;
	z-index: -1;
}

.i_face .gauge:nth-child(even)> div {
	background-color: #f60;
}

.processor {
	margin: 1em;
}

.storage,
.i_face {
	display: flex;
	margin: 1em;
}

.storage ul ,
.i_face ul {
	list-style: none;
	padding: 0;
	margin: 3px;
}

.label {
	margin: 3px 0 0 3px;
	box-sizing: border-box;
	display: inline-block;
	width: 120px;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
}

.layout {
	display: none;
}

#status {
	color: #0084ff;
}

#status.down {
	color: #f00;
}

		</style>
	</head>

	<body class="loading">
		
		<nav>
			<a href="map.html">Map</a>
			<a href="performance.html">Chart</a>
			<button id="view">view</button>
		</nav>
		
		<header>
			<h1 id="node"></h1>
			<h3 id="status"></h3>
		</header>
		
		<article>
			<section>
				<h2>Processor load</h2>
				<div class="resource" id="processor"></div>
			</section>
			
			<section>
				<h2>Physical memory</h2>
				<div class="resource" id="memory"></div>
			</section>
			
			<section>
				<h2>Storage usage</h2>
				<div class="resource" id="disk"></div>
			</section>
			
			<section>
				<h2>Interface throughput</h2>
				<div class="resource" id="iFace"></div>
			</section>
		</article>
		
		<div class="layout">
			<div class="processor">
			</div>
			
			<div class="storage">
				<div>
					<h4 class="label"></h4>
					<ul>
						<li>capacity
						<li>value
					</ul>
					<ul>
						<li>used
						<li>value
					</ul>
				</div>
			</div>
			
			<div class="i_face">
				<div>
					<h4 class="label"></h4>
					<ul>
						<li>bandwidth
						<li>value
					</ul>
					<ul>
						<li>input
						<li>value
					</ul>
					<ul>
						<li>output
						<li>value
					</ul>
				</div>
			</div>
			
			<div class="gauge">
				<div></div>
				<span>50%</span>
			</div>
		</div>
		
		<div class="bg_loading"></div>
	</body>
	
	<script src="js/ITAhM.js"></script>
	<script>

	var processorArea = document.getElementById("processor"),
		diskArea = document.getElementById("disk"),
		memoryArea = document.getElementById("memory"),
		interfaceArea = document.getElementById("iFace"),
		gauge = document.querySelector(".gauge"),
		processorGauge = document.querySelector(".processor"),
		storageGauge = document.querySelector(".storage"),
		iFaceGauge = document.querySelector(".i_face");
	
	document.getElementById("view").onclick = function () {
		document.body.classList.toggle("view_mode");
	};
	
	(function () {
		var database = top.databases.device,
			device = database.data[database.selected];
		
		top.sendRequest({
			command: "select",
			ip: device.ip
		}, function (response) {			
			initialize(device, response);
		});
	}) ();
	
	function createGauge(value) {
		var clone = gauge.cloneNode(true);
		
		clone.children[0].style.height = value;
		clone.children[1].textContent = value;
		
		return clone;
	}
	
	function createProcGauge(value) {
		var clone = processorGauge.cloneNode(true),
			gauge = createGauge(value);
		
		clone.appendChild(gauge);
		
		return clone;
	}
	
	function createStrgGuage(value, used, size, label) {
		var clone = storageGauge.cloneNode(true),
			gauge = createGauge(value),
			div = clone.children[0];
		
		div.children[0].textContent = label;
		div.children[1].children[1].textContent = ITAhM.util.toBytesString(size);
		div.children[2].children[1].textContent = ITAhM.util.toBytesString(used);
		
		clone.insertBefore(gauge, div);
		
		return clone;
	}
	
	function createIFaceGuage(inValue, outValue, inBPS, outBPS, bandwidth, name) {
		var clone = iFaceGauge.cloneNode(true),
			inGauge = createGauge(inValue),
			outGauge = createGauge(outValue),
			div = clone.children[0];
		
		div.children[0].textContent = name;
		div.children[1].children[1].textContent = ITAhM.util.toBPSString(bandwidth);
		div.children[2].children[1].textContent = ITAhM.util.toBPSString(inBPS);
		div.children[3].children[1].textContent = ITAhM.util.toBPSString(outBPS);
		
		clone.insertBefore(inGauge, div);
		clone.insertBefore(outGauge, div);
		
		return clone;
	}
	
	function initialize(device, snmp) {
		var entry;
		
		entry = snmp.hrProcessorEntry;
		for (var index in entry) {
			initProcessor(entry[index]);
		}
		
		entry = snmp.hrStorageEntry;
		for (var index in entry) {
			initStorage(entry[index]);
		}
		
		entry = snmp.ifEntry;
		for (var index in entry) {
			initIFace(entry[index]);
		}
		
		document.getElementById("node").textContent = device.ip;
		if (device.shutdown) {
			var status = document.getElementById("status");
			
			status.textContent
				= "Down. Last response "+ new Date(snmp.lastResponse).toLocaleString();
			status.className = "down";
		}
		else {
			document.getElementById("status").textContent
				= "Running. Response time "+ snmp.responseTime +"ms.";
		}
		
		document.body.classList.remove("loading");
	}
	
	function initProcessor(load) {
		processorArea.appendChild(createProcGauge(load +"%"));
	}
	
	function initStorage(storage) {
		switch(storage.hrStorageType) {
		case 4:
			if (storage.hrStorageSize > 0) {
				initDisk(storage);
			}
			
			break;
		case 2:
			initMemory(storage);
			
			break;
		}
	}
	
	function initDisk(disk) {
		var used = disk.hrStorageUsed * disk.hrStorageAllocationUnits,
			size = disk.hrStorageSize * disk.hrStorageAllocationUnits,
			percentage = Math.round(100* used / size);
		
		diskArea.appendChild(createStrgGuage(percentage +"%", used, size, disk.hrStorageDescr));
	}
	
	function initMemory(memory) {
		var used = memory.hrStorageUsed * memory.hrStorageAllocationUnits,
			size = memory.hrStorageSize * memory.hrStorageAllocationUnits,
			percentage = Math.round(100* used / size);
		
		memoryArea.appendChild(createStrgGuage(percentage +"%", used, size, "Physical memory"));
	}
	
	function initIFace(iFace) {
		var bandwidth = iFace.ifSpeed;
		
		if (bandwidth > 0) {
			var inBPS = iFace.ifInBPS || 0,
				outBPS = iFace.ifOutBPS || 0;
			
			interfaceArea.appendChild(createIFaceGuage(
					(100* inBPS / bandwidth).toFixed(2) +"%",
					(100* outBPS / bandwidth).toFixed(2)+"%",
					inBPS, outBPS, bandwidth, iFace.ifName));
		}
	}
	
	function onSelectDevice(ip) {
		top.databases.device.selected = ip;
		
		location.reload();
	}
	
	</script>
</html>