<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM</title>
		
		<style>
@import "css/itahm.css";

body {
	padding: 20px;
}

header {
	text-align: right;
}

#list {
	list-style: none;
	padding: 3px;
	margin: 0;
}

#list span {
	display: inline-block;
	padding: .5em .5em .5em 2.5em;
	background: none no-repeat left center;
	background-size: 2em;
}

#list span:hover {
	text-decoration: underline;
	cursor: pointer;
}

		</style>
		
	</head>
	
	<body class="loading content_width">
	
		<header>
			<button id="sync" class="r_button">Sync</button>
		</header>
		
		<ul id="list"></ul>
		
		<div class="bg_loading"></div>
		
		<script>

if (top === window) {
	location.href = "http://itahm.com";
}

(function (window, undefined) {
	
	var list = document.getElementById("list");
	
	document.getElementById("sync").onclick = onSync;
	
	initialize();
	
	function onSync() {
		if (!confirm("Synchronize icon database with agent now?")) {
			return;
		}
		
		top.sendRequest({
			command: "push",
			database: "icon",
			sequence: top.databases.icon.sequence,
			data: top.databases.icon.data
		}, function (response) {
			if (response) {
				top.databases.icon.sequence = response.sequence;
			}
			else {
				alert("synchronization failed.");
			}
		});
	}
	
	function onSelectIcon(type) {
		top.showDialog("icon_dialog.html",
			function (dialog) {
				dialog.initialize(type);
			},
			function () {
				location.reload();
			});
	}
	
	function initialize() {
		var iconData = {},
			data, type;
		
		data = top.databases.icon.origin;
		for (type in data) {
			iconData[type] = data[type];
		}
		
		data = top.databases.icon.data;
		for (type in data) {
			iconData[type] = data[type];
		}
		
		var df = document.createDocumentFragment(),
			icon, groupName, groupElement, labelElement,
			map = {}, span;
		
		
		for (type in iconData) {
			icon = iconData[type];
			
			groupName = icon.group;
			
			groupElement = map[groupName];
			
			if (!groupElement) {
				groupElement = document.createElement("ul");
				
				labelElement = document.createElement("li");
				labelElement.textContent = groupName;
				
				df.appendChild(labelElement)
				labelElement.appendChild(groupElement);
				
				map[groupName] = groupElement;
			}
			
			span = document.createElement("span");
			span.textContent = type;
			span.onclick = onSelectIcon.bind(undefined, type);
			span.style.backgroundImage = "url("+ icon.src +")";
			
			groupElement
				.appendChild(document.createElement("li"))
				.appendChild(span);
		}
		
		list.appendChild(df);
		
		setTimeout(function () {
			document.body.classList.remove("loading");
		}, 500);
	};
	
}) (window);

		</script>
	
	</body>
	
</html>