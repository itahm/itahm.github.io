<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM</title>
		
		<style>
@import url("css/itahm.css");

text {
	font-size: 10pt;
}

svg {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	width: 100%;
	height: 100%;
	min-width: 600px;
	min-height: 100px;
	background-color: #fff;
}

text {
	fill: #777;
}

#grid path {
	stroke: rgba(0, 0, 0, .2);
	stroke-width: .5;
	fill: none;
}

#graph path:hover {
	cursor: pointer;
}

#graph path.fill_min {
	fill: #fff;
}

#axis_left text {
	text-anchor: end;
}

#axis_date text {
	text-anchor: middle;
	/*alignment-baseline: text-after-edge;*/
}

#date_text tspan:first-child,
#date_text tspan:last-child {
	font-weight: bold;
	fill: #0084ff;
	cursor: pointer;
}

#date_text tspan:first-child:hover {
	cursor: pointer;
}

nav {
	position: fixed; right: 0; bottom: 0; left: 0;
	display: flex;
	justify-content: space-between;
}

nav img {
	background-color: #fff;
}

nav label {
	position:relative;
}

nav input[type="checkbox"] {
	position:absolute;
	visibility: hidden;
}
	
nav input[type="checkbox"]:not(:checked) ~img:not(.lock),
nav input[type="checkbox"]:checked ~img.lock {
	display: none;
}

		</style>
		
	</head>
	
	<body>
		
		<svg id="chart">
			<g transform="translate(20, 20)">
		        <g transform="translate(0, 0)" id="axis_date"></g>
		        <g transform="translate(0, 0) scale(1 -1)" id="graph" />
		        <g transform="translate(0, 0)" id="axis_left" />
				<g transform="translate(0, 0)" id="axis_right" />
		        <g transform="translate(0, 0)" id="grid" />
		    </g>
		</svg>
		
		<script src="js/ITAhM.js"></script>
		<script src="js/object.js"></script>
		<script>

var svgNS = "http://www.w3.org/2000/svg",
	xlinkNS = "http://www.w3.org/1999/xlink",
	MONTH_NAME = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
	MIN_AXIS_VSPACE = 50,
	MIN_AXIS_HSPACE = 60,
	DATE_AXIS_HEIGHT = 6,
	MARGIN = 20,
	MARGIN_BOTTOM = 20;

var chart = document.getElementById("chart"),
	leftAxis = document.getElementById("axis_left"),
	rightAxis = document.getElementById("axis_right"),
	dateAxis = document.getElementById("axis_date"),
	graph = document.getElementById("graph"),
	grid = document.getElementById("grid"),
	rect = {};

window.addEventListener("resize", function () {
	if (!window.summaryData) {
		return;
	}
	
	if (window.resizeTimer) {
		clearTimeout(window.resizeTimer);
	}
	
	window.resizeTimer = setTimeout(onResize, 300);
});

function onResize() {
	resize();
	
	draw(window.start, window.end);
}

function resize() {
	var rect = window.chart.getBoundingClientRect(),
		width = rect.width - MARGIN *2,
		height = rect.height - MARGIN *2 - DATE_AXIS_HEIGHT,
		reset = false;
	
	graph.transform.baseVal.getItem(0).setTranslate(0, height);
		
	window.rect.height = height;
	window.rect.width = width;
	
	drawGrid();
}

function drawGrid() {
	var path = new ITAhM.Path(window.grid),
		height = window.rect.height,
		width = window.rect.width;

	clear(window.grid);
	
	window.blockWidth = width / 24;
	
	while (blockWidth < MIN_AXIS_HSPACE) {
		blockWidth *= 2;
	}
	
	window.blockHeight = height / Math.round(height / MIN_AXIS_VSPACE);
	
	for (var x = 0, roundedX ; x <= width; x += blockWidth) {
		roundedX = Math.round(x) -.5;
		
		path.moveTo(x, 0).lineTo(roundedX, height);
	}
	
	for (var y = 0, roundedY ; y <= height; y += blockHeight) {
		roundedY = Math.round(y) -.5;
		
		path.moveTo(0, roundedY).lineTo(width, roundedY);
	}
	
	path.draw();
}

function clear(svgElement) {
	var element;
	
	while(element = svgElement.firstChild) {
		svgElement.removeChild(element);
	}
}

function createText(x, y, text) {
	var svgText = document.createElementNS(svgNS, "text");
	
	svgText.setAttributeNS(null, "x", x);
	svgText.setAttributeNS(null, "y", y);
	svgText.textContent = text;
	
	return svgText;
}

function createDateText(x, y, mills) {
	var date = new Date(mills),
		d = date.getDate(),
		h = date.getHours(),
		svgText;
	
	if (h > 0) {
		svgText = createText(x, y, d + "일"+ (h<9? "0": "") + h +"시");
	}
	else {
		svgText = createText(x, y, d +"일");
		svgText.setAttributeNS(null, "font-weight", "bold");
	}
	
	return svgText;
}

function onValueToString(value) {
	return value;
} 

function drawGraph() {
	if (!window.chartData) {
		return;
	}
	
	var fillMax = new ITAhM.Path(window.graph),
		fillMin = new ITAhM.Path(window.graph),
		strokeMax = new ITAhM.Path(window.graph),
		strokeAvg = new ITAhM.Path(window.graph),
		strokeMin = new ITAhM.Path(window.graph),
		high = window.chartData.high,
		blocks = window.chartData.keys,
		dateArray, mills;
	
	window.low = window.chartData.low,
	window.yRatio = window.rect.height / (high - window.low);
	
	strokeMax.set("stroke", window.color);
	strokeMax.set("stroke-opacity", .5);
	strokeMax.set("fill", "none");
	strokeAvg.set("stroke", window.color);
	strokeAvg.set("stroke-width", 2);
	strokeAvg.set("fill", "none");
	strokeMin.set("stroke", window.color);
	strokeMin.set("stroke-opacity", .5);
	strokeMin.set("fill", "none");
	
	fillMax.set("fill", window.color);
	fillMax.set("fill-opacity", .1);
	fillMin.set("class", "fill_min");
	
	strokeMax.beginPath();
	fillMax.beginPath();
	strokeAvg.beginPath();
	strokeMin.beginPath();
	fillMin.beginPath();
	
	for (var i=0, _i=blocks.length; i<_i; i++) {
		dateArray = blocks[i];
	
		mills = dateArray[0];
		
		x = (mills - start) / window.tpp;
		y = summaryData.get(mills);
	
		fillMax.moveTo(x, 0);
		fillMin.moveTo(x, 0);
		
		strokeAvg.moveTo(x, (y.avg - window.low) * window.yRatio);
		strokeMax.moveTo(x, (y.max - window.low) * window.yRatio);
		strokeMin.moveTo(x, (y.min - window.low) * window.yRatio);
		
		fillMax.lineTo(x, (y.max - window.low) * window.yRatio);
		fillMin.lineTo(x, (y.min - window.low) * window.yRatio);
	
		for (var j=1,_j=dateArray.length; j<_j; j++) {				
			mills = dateArray[j];
			
			x = (mills - start) / window.tpp;
			y = summaryData.get(mills);
			
			strokeMax.lineTo(x, (y.max - window.low) * window.yRatio);
			strokeAvg.lineTo(x, (y.avg - window.low) * window.yRatio);
			strokeMin.lineTo(x, (y.min - window.low) * window.yRatio);
			
			fillMax.lineTo(x, (y.max - window.low) * window.yRatio);
			fillMin.lineTo(x, (y.min - window.low) * window.yRatio);
		}
	
		fillMax.lineTo(x, 0);
		fillMin.lineTo(x, 0);
		
		fillMax.closePath();
		fillMin.closePath();
		
		fillMax.draw();
		fillMin.draw();
		
		strokeMax.draw();
		strokeAvg.draw();
		strokeMin.draw();
	}
}

function drawDateAxis() {
	var text, date, h;
	
	for (var x = 0, grow = 0; x <= window.rect.width; x += window.blockWidth ) {
		window.dateAxis.appendChild(createDateText(x, 0, window.start + x * window.tpp));
	}
	
	window.dateAxis.transform.baseVal.getItem(0).setTranslate(0, rect.height + MARGIN);
}

function drawValueAxis() {
	if (!window.chartData) {
		return;
	}
	
	var diff = (window.chartData.high - window.chartData.low) * window.blockHeight / window.rect.height,
		value;
	
	for (var y = 0, grow = 0; y <= window.rect.height; y += window.blockHeight, grow += diff) {
		value = window.chartData.high - grow;
		
		leftAxis.appendChild(createText(0, y, onValueToString(value)));
		rightAxis.appendChild(createText(0, y, (value *100 / max).toFixed(2) + "%"));
	}
	
	leftAxis.transform.baseVal.getItem(0).setTranslate(leftAxis.getBBox().width, 0);
	rightAxis.transform.baseVal.getItem(0).setTranslate(window.rect.width - rightAxis.getBBox().width, 0);
}

/**
 * public
 */
function draw(start, end) {
	var x, y, dateArray, date;

	window.chartData = window.summaryData.parseData(start, end);
	window.detailData = undefined;
	window.start = start;
	window.end = end;
	window.tpp = (window.end - window.start) / window.rect.width;
	
	clear(window.dateAxis);
	
	drawDateAxis();
	
	clear(window.graph);
	
	drawGraph();
	
	clear(window.leftAxis);
	clear(window.rightAxis);
	
	drawValueAxis();
}

/**
 * public
 */
function detail(detailData, start, end) {
	var path = new ITAhM.Path(window.graph),
		blocks, dateArray, mills;
	
	window.chartData = detailData.parseData(start, end);
	if (!window.chartData) {
		return;
	}
	
	blocks = window.chartData.keys;
	
	path.set("stroke", window.color);
	path.set("stroke-width", .5);
	path.set("fill", "none");
	path.beginPath();
	
	for (var i=0, _i=blocks.length; i<_i; i++) {
		dateArray = blocks[i];
	
		mills = dateArray[0];
		
		x = (mills - start) / window.tpp;
		y = detailData.get(mills);
		
		path.moveTo(x, (y - window.low) * window.yRatio);
	
		for (var j=1,_j=dateArray.length; j<_j; j++) {				
			mills = dateArray[j];
			
			x = (mills - start) / window.tpp;
			y = detailData.get(mills);
			
			path.lineTo(x, (y - window.low) * window.yRatio);
		}
	
		path.draw();
	}
}

/**
 * public
 */
function initialize(summaryData, max, color, drawDate) {
	window.summaryData = summaryData;
	window.max = max;
	window.color = color;
	
	if (!drawDate) {
		window.DATE_AXIS_HEIGHT = 0;
		
		window.drawDateAxis = function () {
		};
	}
	
	resize();
}

		</script>
	
	</body>
	
</html>