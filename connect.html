<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Connect @ ITAhM</title>
		
		<style>
@import "css/itahm.css";

body {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	display: flex;
	justify-content: center;
	align-items: center;
	background-color: #f9f9f9;
}

.content_width {
	width: 360px;
}

p, input {
	font-size: 13px;
}

h1 {
	text-align: center;
}

h1 img {
	vertical-align: middle;
}

form {
	padding: 20px;
	border: 1px solid #ddd;
	background-color: #fff;
}

p {
	/*margin: 0;*/
}

input {
	width: 100%;
	box-sizing: border-box;
	padding: 10px;
	border: 1px solid #ddd;
	border-radius: 3px 3px 3px 3px;
}

input[type="submit"] {
	margin-top: 20px;
	background-image: linear-gradient(#7af, #0084ff);
	border: 1px solid #07f;
	font-weight: bold;
	color: #fff;
}

#comment {
	color: #911;
}

#comment:empty {
	display: none;
}

.flex {
	display: flex;
}

.flex input:first-child {
	flex: 2;
}

.flex input:last-child {
	flex: 1;
}

input[name="host"] {
	background: url("img/home.png") no-repeat 10px center;
	padding-left: 36px;
}

input[name="port"] {
	background: transparent url("img/port.png") no-repeat 10px center;
	padding-left: 36px;
}

input[name="username"] {
	background: transparent url("img/user.png") no-repeat 10px center;
	padding-left: 36px;
}

input[name="password"] {
	background: transparent url("img/lock.png") no-repeat 10px center;
	padding-left: 36px;
}

		</style>
		
	</head>
	
	<body>
		<section class="content_width">
			<h1>Connect to agent</h1>
			<form id="form" class="rounded">
				<div id="agent">
					<p>Agent address</p>
					<div class="flex">
						<div>
							<input type="text" name="host" placeholder="IP address" required>
						</div>
						<div>
							<input type="text" name="port" value="2014" placeholder="TCP port" required>
						</div>
					</div>
				</div>
				<div id="account">
					<p>Username</p>
					<input type="text" name="username" required>
					<p id="comment"></p>
				</div>
				<div>
					<p>Password</p>
					<input type="password" name="password" required>
				</div>
				<input type="submit" value="Connect">
			</form>
			<h1>
				<a href="http://itahm.com">
					<img width="64" height="64" src="img/favicon.png">
				</a>
			</h1>
		</section>
		
		<script src="js/ITAhM.js"></script>
		<script src="js/object.js"></script>
		<script>

var MAJOR = 1,
	MINOR = 3,
	REVISION = 9;
		
(function (window, undefined){
	
	var form = document.getElementById("form"),
		comment = document.getElementById("comment"),
		agent = document.getElementById("agent"),
		account = document.getElementById("account");
	
	function initialize() {
		var value;
		
		if (value = sessionStorage.host) {
			form.elements.host.value = value;
		}
		
		if (value = sessionStorage.port) {
			form.elements.port.value = value;
		}
		
		form.addEventListener("submit", onConnect);
	}
	
	function onConnect(e) {
		e.preventDefault();
		
		var xhr = new ITAhM.Communicator(form.elements.host.value, form.elements.port.value, 3000),
			request = {
				command: "signin",
				username: form.elements.username.value,
				password: form.elements.password.value
			};
		
		xhr.sendRequest(request, function (status, response) {
			if (status === 200) {
				var version = response.version.split(".");
				
				if (parseInt(version[1]) < MINOR) {
					alert("에이전트의 최신 버전은 "+ [MAJOR, MINOR, 3, REVISION].join(".") +" 입니다.\n"
						+"에이전트의 업데이트가 필요합니다.\n"
						+"중요한 변화가 반영되었으니 반드시 에이전트를 업데이트 하십시오.\n"
						+"그렇지 않은 경우 오작동할 수 있습니다.");
				}
				else if (parseInt(version[3]) < REVISION) {
					alert("에이전트의 최신 버전은 "+ [MAJOR, MINOR, 3, REVISION].join(".") +" 입니다.\n"
						+"2017년 02월16일 일부 변경사항이 적용되었습니다.\n"
						+"SNMP v3를 지원합니다. 인증은 MD5만 지원합니다.\n"
						+"자세한 내용은 http://itahm.com/download.html 페이지를 참고하십시길 바랍니다.\n"
						+"에이전트를 업데이트하지 않으면 오작동 할 수 있습니다.");
				}
				
				sessionStorage.host = form.elements.host.value;
				sessionStorage.port = form.elements.port.value;
				sessionStorage.user = form.elements.username.value;
				sessionStorage.level = response.level;
				sessionStorage.version = response.version;
				
				location.href = "itahm.html";
			}
			else if (status === 401) {
				comment.textContent = "Incorrect username or password.";
				
				form.elements.username.select();
			}
			else {
				console.log(response);
			
				comment.textContent = "Agent is not responding.";
				
				form.elements.host.select();
			}
		});
	}
	
	initialize();
		
}) (window);
		</script>
	
	</body>
	
</html>