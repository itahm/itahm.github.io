<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM</title>
		
		<style>
body, input, button {
	font-family: tahoma, arial, "맑은 고딕";
	margin: 0;
	padding: 0; 
}

body, input, button {
	font-size: 12px;
}

aside {
	position: fixed; top: 0; left: 0;
	height: 0;
	width: 400px;
	background-color: #fff;
	transition: height .2s ease-in;
}

iframe {
	width: 100%; height: 100%;
	border: 0;
	margin: 0;
	padding: 0;
}

body.list aside {
	bottom: 0;
	height: 100%;
}

#frame_list {
	width: 500px;
}

#show_list {
	position: fixed; top: 10px; left: 10px;
	cursor: pointer;
}

#hide_list {
	position: absolute; top: 10px; right: 0;
	cursor: pointer;
}

nav {
	position: fixed; top: 10px; right: 10px;
}

nav input,
nav img {
	vertical-align: middle;
}

nav img {
	cursor: pointer;
}

body:not(.address) tspan:last-child,
body:not(.name) tspan:first-child,
body:not(.list) #hide_list {
	display: none;
}

/* svg*/
svg {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	width: 100%; height: 100%;
}
/*
image {
	fill: #f00;
}
*/
text {
	font-family: tahoma, arial, "맑은 고딕";
	font-size: 10px;
	fill: #000;
	text-anchor: middle;
}

#line line {
	stroke: #0f0;
	stroke-width: 2;
}

#line text {
	fill: #777;
}

#navigation line {
	stroke: #800;
	stroke-width: 2;
}

#device text {
	font-size: 12px;
	/*alignment-baseline: hanging;*/
	fill: #000;
}

#selection_mark {
	stroke: #fdd400;
	stroke-width: 5px;
	fill: #fff;
}

#navigation circle {
	stroke: #800;
	stroke-width: 1px;
	fill: #f00;
}

.alert {
	stroke-width: 5;
	stroke: #f00;
	fill: none;
	animation: alert 2s infinite;
}
 
@keyframes alert {
    from {
    	opacity: 0;
    }
    to {
    	opacity: 1;
    }
}

body.loading g,
body:not(.snmp) #chart_anchor {
	display: none;
}

/* dialog */
body:not(.dialog) #dialog {
	display: none;
}

/* chart */
#chart {
	background-color: #fff;
}

body:not(.chart) #chart {
	display: none;
}

/* 공통 */
.fullscreen {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
}

body.nolink #link_token,
#edit_anchor {
	display: none;
}

		</style>
		
	</head>
	
	<body class="loading nolink name">
	
		<svg id="stage">
			<defs>
				<circle r="35" id="circle"></circle>
			</defs>
			<g id="transform" transform="translate(0, 0) translate(0, 0) translate(0, 0) scale(1, 1)">
				<g id="line"></g>
				<g id="device">
					<circle r="30" id="selection_mark"></circle>
				</g>
				<g id="navigation">
					<g id="tool">
						<image xlink:href="img/svg/chart.svg" id="chart_anchor"
							transform="translate(-42, -8)" width="16" height="16" cursor="pointer">
						</image>
						<image xlink:href="img/svg/information.svg" id="edit_anchor"
							transform="translate(26, -8)" width="16" height="16" cursor="pointer">
						</image>
						<line id="link_line"></line>
						<circle id="link_token" r="5" cursor="crosshair"></circle>
					</g>
				</g>
				<g id="alert" transform="translate(20, 20)"></g>
			</g>
		</svg>
		
		<img src="img/list.png" id="show_list" title="show device list">
		
		<aside>
			<img src="img/close.png" id="hide_list" title="hide device list">
			<iframe id="device_list"></iframe>
		</aside>
		
		<nav>
			<img src="img/save.png" width="16px" height="16px" id="save">
			<input type="radio" name="option" id="option_name" checked>name
			<input type="radio" name="option" id="option_addr">ip address
		</nav>
		<iframe id="dialog" class="fullscreen"></iframe>
		
		<iframe id="chart" class="fullscreen"></iframe>
		
		<script src="js/Draggable.js"></script>
		<script>

if (!opener) throw "";

var svgNS = "http://www.w3.org/2000/svg",
	xlinkNS = "http://www.w3.org/1999/xlink";

//device list
(function (window, undefined){
	
	var frame = document.getElementById("device_list"),
		show = document.getElementById("show_list"),
		hide = document.getElementById("hide_list");
	
	function initialize() {
		show.onclick = function () {
			document.body.classList.add("list");
			
			frame.onload = onLoad;
			
			frame.src = "device_list.html";
		};
		
		hide.onclick = function () {
			document.body.classList.remove("list");
			
			frame.src = "about:blank";
		};
	}
	
	function onLoad() {
		
	}
	
	window.hideDeviceList = function () {
		document.body.classList.remove("list");
	};
	
	initialize();
	
}) (window);

//navigation
(function (window, undefined) {
	
	function initialize() {
		document.getElementById("option_name").onchange =
		document.getElementById("option_addr").onchange = function () {
			document.body.classList.toggle("name");
			document.body.classList.toggle("address");
		};
		
		document.getElementById("save").onclick = onSave;
	}
	
	function onSave() {
		var adjust = adjustStage(),
			x = adjust.x,
			y = adjust.y;
		
		forEachDevice(function (device) {
			getSvgDevice(device.id);
			//console.log(device);
		});
	}
	
	initialize();
	
}) (window);

// stage
(function (window, undefined) {
	var canvas = document.getElementById("stage"),
		base, translate, scale, ratio = 1,
		selectedDevice,
		deviceMap = {},
		dragOrigin;
	
	function initialize() {
		var transformList = document.getElementById("transform").transform.baseVal;
	
		new Draggable(canvas);
			
		base = transformList.getItem(0);
		translate = transformList.getItem(1);
		drag = transformList.getItem(2);
		scale = transformList.getItem(3);
		
		window.addEventListener("resize", function (e) {
			resetStage();
		});
		
		canvas.addEventListener("selectstart", function (e) {
			e.preventDefault();
		});
		
		canvas.addEventListener("wheel", onZoom);
		canvas.addEventListener("click", onClick);
		canvas.addEventListener("dragstart", onDragStart);
		canvas.addEventListener("dragmove", onDragMove);
		canvas.addEventListener("dragend", onDragEnd);
	}
	
	function onZoom(e) {
		if (e.deltaY < 0) {
			//확대
			ratio *= 1.1;
		}
		else {
			//축소
			ratio /= 1.1;
		}
		
		scale.setScale(ratio, ratio);
	}
	
	function onDragStart(e) {
		var data = e.detail,
			target = data.target;
		
		// drag 발생시 select 취소
		canvas.addEventListener("click", cancelClick);
		canvas.removeEventListener("click", onClick);
		
		if (target.tagName === "image") {
			dragOrigin = {
				x: Number(target.getAttributeNS(null, "x")),
				y: Number(target.getAttributeNS(null, "y"))
			};
		}/*
		else if (target.tagName === "circle") {
			dragOrigin = {
				x: Number(target.getAttributeNS(null, "cx")),
				y: Number(target.getAttributeNS(null, "cy"))
			};
		}*/
	}
	
	function onDragMove(e) {
		var data = e.detail,
			target = data.target;
	
		// selectedDevice 인 경우 move
		if (target === selectedDevice) {
			var x = dragOrigin.x + Math.round(data.dragX / ratio),
				y = dragOrigin.y + Math.round(data.dragY / ratio);
			
			moveSelectionMark(x, y);
			
			moveSelectedDevice(x, y);
		}/*
		// linkToken 인 경우 moveLinkToken
		else if (isLinkToken(target)){
			var destination = data.destination;
			
			if (destination !== target && destination.tagName === "image") {
				moveLinkToken(Number(destination.getAttributeNS(null, "x")), Number(destination.getAttributeNS(null, "y")));
			}
			else {
				moveLinkToken(dragOrigin.x + Math.round(data.dragX / ratio), dragOrigin.y + Math.round(data.dragY / ratio));
			}
		}*/
		// 그렇지 않은 모든 경우 moveStage
		else {
			drag.setTranslate(data.dragX, data.dragY);
		}
	}
	
	function onDragEnd(e) {
		var data = e.detail,
			target = data.target,
			destination = data.destination;
		
		if (target === selectedDevice) {
		}/*
		else if (isLinkToken(target)){
			if (destination.tagName === "image") {
				showLinkDialog(function (dialog) {
					dialog.setLink(deviceData[selectedDevice.getAttributeNS(null, "id")], deviceData[destination.getAttributeNS(null, "id")]);
				});
			}
			
			moveSelectionMark();
		}*/
		else {
			translate.matrix.e += drag.matrix.e;
			translate.matrix.f += drag.matrix.f;
			//translate.setMatrix(translate.matrix.translate(drag.matrix.e, drag.matrix.f));
			drag.setTranslate(0, 0);
		}
	}
	
	function onClick(e) {
		var target = e.target;
	
		selectedDevice = target.tagName === "image"? target: undefined;
		
		if (selectedDevice) {
			x = Number(selectedDevice.getAttributeNS(null, "x"));
			y = Number(selectedDevice.getAttributeNS(null, "y"));
			
			showSelectionMark(x, y);
			
			topDevice(selectedDevice);
		}
		else {
			clearSelectionMark();
		}
	
	}
	
	function cancelClick(e) {
		canvas.addEventListener("click", onClick);
		canvas.removeEventListener("click", cancelClick);
	}
	
	// public
	window.resetStage = function () {
		rect = canvas.getBoundingClientRect();
		
		base.setTranslate(rect.width /2, rect.height /2);
	};
	
	window.moveStage = function (x, y) {
		translate.setTranslate(- x, - y);
	};
	
	window.getSelectedDeviceID = function () {
		return selectedDevice.getAttributeNS(null, "id");
	};
	
	window.editDevice = function () {
	
	};
	
	window.adjustStage = function () {
		var adjust = {
				x: translate.matrix.e,
				y: translate.matrix.f
			};
		
		translate.setTranslate(0, 0);
		
		return adjust;
	};
	
	window.initStage = function () {
		resetStage();
		
		clearSelectionMark();
		
		document.body.classList.remove("loading");
	};
	
	initialize();

}) (window);

// svg device group
(function (window, undefined) {
	
	var canvas = document.getElementById("device"),
		selectionMark = document.getElementById("selection_mark"),
		fragment = document.createDocumentFragment(),
		iconMap = {},
		labelMap = {},
		alertMap = {},
		device;

	function initialize() {
	}
	
	window.addDevice = function (device, icon) {
		var svgDevice = document.createElementNS(svgNS, "image"),
			svgLabel = document.createElementNS(svgNS, "text"),
			svgAddr = document.createElementNS(svgNS, "tspan"),
			svgName = document.createElementNS(svgNS, "tspan");
		
		svgDevice.setAttributeNS(null, "id", device.id);
		svgDevice.setAttributeNS(null, "x", device.x);
		svgDevice.setAttributeNS(null, "y", device.y);
		svgDevice.setAttributeNS(xlinkNS, "xlink:href",  icon);
		svgDevice.setAttributeNS(null, "width", "40px");
		svgDevice.setAttributeNS(null, "height", "40px");
		svgDevice.setAttributeNS(null, "transform", "translate(-20, -20)");
		
		canvas.appendChild(svgDevice);
		
		svgName.textContent = device.name;
		svgAddr.textContent = device.ip;
		
		svgLabel.appendChild(svgName);
		svgLabel.appendChild(svgAddr);
		
		svgLabel.setAttributeNS(null, "x", device.x);
		svgLabel.setAttributeNS(null, "y", device.y);
		// text baseline이 글자의 밑을 기준으로 하므로 글자 크기만큼 내려준다.
		// 아이콘 크기 + 글자 크기 = 20 + 16 = 36
		svgLabel.setAttributeNS(null, "transform", "translate(0, 36)");
		
		canvas.appendChild(svgLabel);
		
		iconMap[device.id] = svgDevice;
		labelMap[device.id] = svgLabel;
		
		if (device.id < 1) {
			var svgAlert = document.createElementNS(svgNS, "use");
			
			svgAlert.setAttributeNS(xlinkNS, "xlink:href", "#circle");
			svgAlert.setAttributeNS(null, "class", "alert");
			svgAlert.setAttributeNS(null, "x", device.x);
			svgAlert.setAttributeNS(null, "y", device.y);
			
			canvas.appendChild(svgAlert);
			
			alertMap[device.id] = svgAlert;
		}
	};
	
	window.moveSelectedDevice = function (x, y) {
		var id = getSelectedDeviceID(),
			svgDevice = iconMap[id],
			svgLabel = labelMap[id],
			svgAlert = alertMap[id];
		
		svgDevice.setAttributeNS(null, "x", x);
		svgDevice.setAttributeNS(null, "y", y);
		
		svgLabel.setAttributeNS(null, "x", x);
		svgLabel.setAttributeNS(null, "y", y);
		
		if (svgAlert) {
			svgAlert.setAttributeNS(null, "x", x);
			svgAlert.setAttributeNS(null, "y", y);
		}
		
		moveLine(id, x, y);
	};
	
	window.topDevice = function (svgDevice) {
		canvas.appendChild(svgDevice);
	};
	
	window.moveSelectionMark = function (x, y) {
		var id = getSelectedDeviceID(),
			device = getDevice(id),
			svgDevice = getSelectedDevice();
		
		selectionMark.setAttributeNS(null, "cx", x);
		selectionMark.setAttributeNS(null, "cy", y);
		
		moveNavigation(x, y);
	};
	
	window.showSelectionMark = function (x, y) {
		canvas.appendChild(selectionMark);
		
		showNavigation(x, y, getSelectedDevice().snmp);
		
		moveSelectionMark(x, y);
	};
	
	window.clearSelectionMark = function () {
		fragment.appendChild(selectionMark);
		
		hideNavigation();
	};
	
	window.getSvgDevice= function (id) {
		return iconMap[id];
	};
	
	window.centerDevice = function (id) {
		var svgDevice = iconMap[id];
		
		x = Number(svgDevice.getAttributeNS(null, "x"));
		y = Number(svgDevice.getAttributeNS(null, "y"));
		
		moveStage(x, y);
	}
	
	initialize();
	
}) (window);

// svg navigation group
(function (window, undefined) {
	
	var canvas = document.getElementById("navigation"),
		navigation = document.getElementById("tool"),
		linkToken = document.getElementById("link_token"),
		svgLink = document.getElementById("link_line"),
		chartAnchor = document.getElementById("chart_anchor"),
		editAnchor = document.getElementById("edit_anchor"),
		fragment = document.createDocumentFragment();
	
	function initialize() {
		chartAnchor.onclick = function (e) {
			e.stopPropagation();
			
			showChart();
		};
		
		editAnchor.onclick = function (e) {
			var device = getSelectedDevice();
			
			if (device.snmp) {
				sendRequest({
					command: "select",
					ip: device.ip
				}, onResponse, true);
			}
			else {
				onLoadDeviceDialog();
			}
			
			e.stopPropagation();
		};
	}
	
	function onResponse(data) {
		if (data) {
			onLoadDeviceDialog(data);
		}
		else {
			window.close();
		}
	}
	
	function onLoadDeviceDialog(snmp) {
		var device = getSelectedDevice(id);
		
		showDeviceDialog(function (dialog) {
			dialog.initialize(iconData);
			
			dialog.setDevice(device, snmp);
		});
	}
	
	window.showNavigation = function (x, y, chart) {
		document.body.classList[chart? "add": "remove"]("snmp");
		
		canvas.appendChild(navigation);
		
		moveNavigation(x, y);
	};
	
	window.moveNavigation = function (x, y) {
		svgLink.setAttributeNS(null, "x1", x);
		svgLink.setAttributeNS(null, "y1", y);
		svgLink.setAttributeNS(null, "x2", x);
		svgLink.setAttributeNS(null, "y2", y);
		
		linkToken.setAttributeNS(null, "cx", x);
		linkToken.setAttributeNS(null, "cy", y -32);
		
		chartAnchor.setAttributeNS(null, "x", x);
		chartAnchor.setAttributeNS(null, "y", y);
		
		editAnchor.setAttributeNS(null, "x", x);
		editAnchor.setAttributeNS(null, "y", y);
	}
	
	window.isLinkToken = function (target) {
		return target === linkToken;
	};
	
	window.hideNavigation = function () {
		fragment.appendChild(navigation);
	};
	
	window.moveLinkToken = function (x, y) {
		linkToken.setAttributeNS(null, "cx", x);
		linkToken.setAttributeNS(null, "cy", y);
		
		svgLink.setAttributeNS(null, "x2", x);
		svgLink.setAttributeNS(null, "y2", y);
	};
	
	initialize();
	
}) (window);

// svg line group
(function (window, undefined) {
	
	var canvas = document.getElementById("line"),
		lineMap = {};
	
	window.addLine = function (device) {
		var ifEntry = device.ifEntry,
			peerMap = {},
			peer, data, lineSvg,
			labelSvg;
		
		lineMap[device.id] = peerMap;
		
		for (var name in ifEntry) {
			peer = getDevice(ifEntry[name]);
			
			labelSvg = createLabel(name, device.x, device.y, peer.x, peer.y);
			
			data = lineMap[peer.id];
			
			if (data) {
				data = data[device.id];
				
				data.name2 = labelSvg;
			}
			else {
				lineSvg = document.createElementNS(svgNS, "line");
				
				lineSvg.setAttributeNS(null, "x1", device.x);
				lineSvg.setAttributeNS(null, "y1", device.y);
				lineSvg.setAttributeNS(null, "x2", peer.x);
				lineSvg.setAttributeNS(null, "y2", peer.y);
				
				data = {
					peer1: device.id,
					name1: labelSvg,
					peer2: peer.id,
					svg: canvas.appendChild(lineSvg)
				};
			}
			
			// label이 선보다 위에 그려지도록 나중에 붙여줌
			canvas.appendChild(labelSvg);
			
			peerMap[peer.id] = data;
		}
	};
	
	window.moveLine = function (id, x, y) {
		var peerMap = lineMap[id],
			data, svgDevice,
			x1, y1, x2, y2;
		
		for (var peerID in peerMap) {
			data = peerMap[peerID];
			svgDevice = data.svg;
			
			if (data.peer1 === id) {
				svgDevice.setAttributeNS(null, "x1", x);
				svgDevice.setAttributeNS(null, "y1", y);
				
				x1 = x;
				y1 = y;
				x2 = Number(svgDevice.getAttributeNS(null, "x2"));
				y2 = Number(svgDevice.getAttributeNS(null, "y2"));
			}
			else {
				svgDevice.setAttributeNS(null, "x2", x);
				svgDevice.setAttributeNS(null, "y2", y);
				
				x1 = Number(svgDevice.getAttributeNS(null, "x1"));
				y1 = Number(svgDevice.getAttributeNS(null, "y1"));
				x2 = x;
				y2 = y;
			}
			
			moveLabel(data.name1, x1, y1, x2, y2);
			moveLabel(data.name2, x2, y2, x1, y1);
		}
	};
	
	function createLabel(name, x1, y1, x2, y2) {
		var labelSvg = document.createElementNS(svgNS, "text");
		
		labelSvg.textContent = name;
		
		moveLabel(labelSvg, x1, y1, x2, y2);
		
		return labelSvg;
	};
	
	function moveLabel(labelSvg, x1, y1, x2, y2) {
		labelSvg.setAttributeNS(null, "x", (x1 *2 + x2) /3);
		labelSvg.setAttributeNS(null, "y", (y1 *2 + y2) /3);
	};
	
}) (window);

// dialog
(function (window, undefined) {
	
	var dialog = document.getElementById("dialog");
	
	function showDialog(onload) {
		document.body.classList.add("dialog");
		
		onload(dialog.contentWindow);
	}
	
	window.showDeviceDialog = function (onload) {
		dialog.onload = showDialog.bind(undefined, onload);
		
		dialog.src = "device.html";
	};
	
	window.showLinkDialog = function (onload) {
		dialog.onload = showDialog.bind(undefined, onload);
		
		dialog.src = "link.html";
	};
	
	window.closeDialog = function () {
		document.body.classList.remove("dialog");
		
		dialog.onload = undefined;
		
		dialog.src = "about:blank";
	};
	
}) (window);

//chart
(function (window, undefined) {
	
	var chart = document.getElementById("chart"),
		device;
	
	function onResponse(data) {
		if (data) {
			chart.onload = function () {
				chart.contentWindow.initialize(device, data);
			};
			
			chart.src = "chart.html";
		}
		else {
			window.close();
		}
		
		document.body.classList.add("chart");
	}
	
	window.showChart = function () {
		device = getSelectedDevice();
		
		sendRequest({
			command: "select",
			ip: device.ip
		}, onResponse);
	};
	
	window.closeChart = function () {
		document.body.classList.remove("chart");
		
		chart.onload = undefined;
		
		dialog.src = "about:blank";
	};
	
}) (window);

//data
(function (window, undefined) {
	
	var deviceData,
		iconData,
		tmpID = -1;
	
	window.createDevice = function () {
		var device = {},
			id = tmpID--;
		
		device.id = id;
		device.x = 0;
		device.y = 0;
		
		deviceData[id] = device;
		
		return device;
	};
	
	window.getSelectedDevice = function () {
		return deviceData[getSelectedDeviceID()];
	}
	
	window.getDevice = function (id) {
		return deviceData[id];
	};

	window.forEachDevice = function (f) {
		for (var id in deviceData) {
			f(deviceData[id]);
		}
	};
	
	window.getDeviceData = function () {
		return deviceData;
	};
	
	// 페이지의 시작
	opener.onLoadingCompleted(function (d, i, f) {
		var device;
		
		deviceData = d;
		iconData = i;
		window.sendRequest = f;
		
		for (var id in deviceData) {
			device = deviceData[id];
			
			addDevice(device, iconData[device.type].src);
			addLine(device);
		}
		
		initStage();
	});
	
}) (window);

function sendRequest(request, callback) {
	opener.sendRequest(request, callback);
}

		</script>
	
	</body>
	
</html>