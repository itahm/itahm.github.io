<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM</title>
		
		<style>
@import "css/itahm.css";

body, input, button {
	margin: 0;
	padding: 0; 
}

#map {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	width: 100%; height: 100%;
}

/* svg*/

text::selection {
	background: none;
}

text {
	font-family: tahoma, arial, "맑은 고딕";
	font-size: 10px;
	fill: #000;
	text-anchor: middle;
}

#line line {
	stroke: #836953;
	stroke-width: 2;
}

#line text {
	font-size: 11px;
	fill: #333;
}

#link line {
	stroke: #800;
	stroke-width: 2;
	stroke-dasharray: 2, 2;
}

#device text {
	font-size: 12px;
	/*alignment-baseline: hanging;*/
	fill: #000;
}

#selection_mark {
	/*stroke: #fdd400;*/
	stroke: rgba(0, 132, 255, .5);
	stroke-width: 5px;
	fill: #fff;
}
/*
#tool circle {
	stroke: #800;
	stroke-width: 1px;
	fill: #f00;
}
*/
use.shutdown {
	stroke-width: 5;
	stroke: rgba(255, 0, 0, .5);
	fill: none;
	animation: alert 2s infinite;
}

@keyframes alert {
    from {
    	opacity: 0;
    }
    to {
    	opacity: 1;
    }
}

/* dialog */
body:not(.dialog) #dialog {
	display: none;
}

/* chart */
#chart {
	background-color: #fff;
}

body:not(.chart) #chart {
	display: none;
}

/* 공통 */
.fullscreen {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
}

body:not(.ifname) #line text {
	display: none;
}

		</style>
		
	</head>
	
	<body class="loading">

		<svg id="map">
			<defs>
				<circle r="35" id="circle"></circle>
			</defs>
			<g id="transform" transform="translate(0, 0) scale(1, 1) translate(0, 0)">
				<g id="line"></g>
				<g id="link"></g>
				<g id="device">
					<circle r="30" id="selection_mark"></circle>
				</g>
				<g id="tool">
					<g id="anchor" transform="translate(0, 0)">
						<image xlink:href="img/svg/remove.svg" id="remove_anchor"
							transform="translate(34, 0) translate(-8, -8)" width="16" height="16" cursor="pointer">
							<title>이 장비를 삭제합니다.</title>
						</image>
						<image xlink:href="img/svg/anchor.svg" id="link_anchor"
							transform="translate(0, -34) translate(-8, -8)" width="16" height="16" cursor="pointer">
							<title>이 앵커를 드래그하여 다른 장비와 연결합니다.</title>
						</image>
					</g>
				</g>
			</g>
		</svg>
		
		<script src="js/ITAhM.js"></script>
		<script src="js/Draggable.js"></script>
		<script src="js/Communicator.js"></script>
		<script>

var svgNS = "http://www.w3.org/2000/svg",
	xlinkNS = "http://www.w3.org/1999/xlink";

var mapCanvas = document.getElementById("map"),
	mapTransform = document.getElementById("transform").transform.baseVal,
	deviceCanvas = document.getElementById("device"),
	toolCanvas = document.getElementById("tool"),
	linkCanvas = document.getElementById("link"),
	lineCanvas = document.getElementById("line"),
	selectionMark = document.getElementById("selection_mark"),
	anchor = document.getElementById("anchor"),
	ancorTransform = anchor.transform.baseVal,
	linkAnchor = document.getElementById("link_anchor"),
	linkAnchorTransform = linkAnchor.transform.baseVal,
	linkSVG = document.createElementNS(svgNS, "line"),
	documentFragment = document.createDocumentFragment(),
	linkData = {},
	deviceData = {},
	labelData = {},
	alertData = {},
	scale = 1,
	cancelSelect = false,
	dragOrigin;

new Draggable(mapCanvas);

mapCanvas.addEventListener("click", onCancelSelect);
mapCanvas.addEventListener("dragon", onDragStart);
mapCanvas.addEventListener("drag", onDragMove);
mapCanvas.addEventListener("dragoff", onDragEnd);

document.onselectstart = function () {
	return false;
};

document.getElementById("remove_anchor").onclick = function (e) {
	e.stopPropagation();
	
	removeDevice(window.selected.ip);
};

function zoom(ratio) {
	window.scale = ratio;
	
	mapTransform.getItem(1).setScale(ratio, ratio);
}
	
function resize() {
	rect = mapCanvas.getBoundingClientRect();
	
	mapTransform.getItem(0).setTranslate(rect.width /2, rect.height /2);
}
	
function moveMap(x, y) {
	mapTransform.getItem(2).setTranslate(x, y);
}
	
function restoreMap() {
	var matrix = mapTransform.getItem(2).matrix;

	moveAllDevice(matrix.e, matrix.f);

	moveMap(0, 0);
}
	
function onDragStart(e) {
	var data = e.detail,
		target = data.target,
		device;
	
	if (window.selected) {
		window.dragOrigin = {
			x: window.selected.x,
			y: window.selected.y
		};
		
		if (target === linkAnchor) {
			setLinkAnchor(window.dragOrigin.x, window.dragOrigin.y, window.dragOrigin.x, window.dragOrigin.y -34);
		}
	}
	
	window.cancelSelect = true;
}
	
function onDragMove(e) {
	var data = e.detail,
		target = data.target,
		selectedSvgDevice = window.deviceData[window.selected.ip];
	
	if (target === selectedSvgDevice) {
		var x = window.dragOrigin.x + Math.round(data.dragX / window.scale /10) *10,
			y = window.dragOrigin.y + Math.round(data.dragY / window.scale /10) *10;
		
		moveSelectionMark(x, y);
		
		moveDevice(window.selected, x, y);
	}
	else if (target === linkAnchor) {
		var destination = data.destination,
			x = window.dragOrigin.x + Math.round(data.dragX / window.scale),
			y = window.dragOrigin.y + Math.round(data.dragY / window.scale);
		
		if (isDevice(destination) &&  destination !== selectedSvgDevice) {
			moveLinkAnchor(Number(destination.getAttributeNS(null, "x")), Number(destination.getAttributeNS(null, "y")));
		}
		else {
			moveLinkAnchor(x, y - 34);
		}
	}
	else {
		var x = Math.round(data.dragX / window.scale /10) *10,
			y = Math.round(data.dragY / window.scale /10) *10;
		
		moveMap(x, y);
	}
}

function onDragEnd(e) {
	var data = e.detail,
		target = data.target,
		destination = data.destination,
		eventData = {},
		event = ITAhM.util.createCustomEvent("link", eventData),
		selectedSvgDevice = window.deviceData[window.selected.ip];
	
	if (target === selectedSvgDevice) {
	}
	else if (target === linkAnchor) {
		mapCanvas.appendChild(linkAnchor);
		
		restoreLinkAnchor();
		
		if (isDevice(destination) &&  destination !== selectedSvgDevice) {
			eventData.peer = window.selected;
			
			destination.dispatchEvent(event);
		}
	}
	else {
		restoreMap();
	}
}
	
function moveAllDevice(x, y) {
	var device;
	
	if (window.selected) {
		moveSelectionMark(window.selected.x + x, window.selected.y + y);
	}
	
	for (var ip in getDevice()) {
		device = getDevice(ip);
		
		moveDevice(device, device.x + x, device.y + y);
	}
}
	
function onCancelSelect() {
	if (window.cancelSelect) {
		window.cancelSelect = false;
	}
	else {
		clearSelectionMark();
		
		window.selected = undefined;
	}
}
	
function selectDevice(ip) {
	if (window.cancelSelect) {
		window.cancelSelect = false;
	}
	else {
		var device = getDevice(ip);
		
		window.selected = device;
		
		showSelectionMark(device.x, device.y);
		
		topDevice(window.deviceData[ip]);
	}
}

function moveLine(x, y, data, direct) {
	var device, svgDevice,
		x1, y1, x2, y2;

	svgDevice = data.svg;
	
	if (direct) {
		device = getDevice[data.peer2];
		
		svgDevice.setAttributeNS(null, "x1", x);
		svgDevice.setAttributeNS(null, "y1", y);
		
		x1 = x;
		y1 = y;
		x2 = device.x;
		y2 = device.y;
	}
	else {
		device = getDevice(data.peer1);
		
		svgDevice.setAttributeNS(null, "x2", x);
		svgDevice.setAttributeNS(null, "y2", y);
		
		x1 = device.x;
		y1 = device.y;
		x2 = x;
		y2 = y;
	}
}

function addDevice(ip) {
	var device = getDevice(ip),
		svgDevice = document.createElementNS(svgNS, "image"),
		svgLabel = document.createElementNS(svgNS, "text"),
		svgAddr = document.createElementNS(svgNS, "tspan"),
		svgDelay = document.createElementNS(svgNS, "tspan");

	svgDevice.setAttributeNS(null, "x", device.x);
	svgDevice.setAttributeNS(null, "y", device.y);
	svgDevice.setAttributeNS(null, "width", "40px");
	svgDevice.setAttributeNS(null, "height", "40px");
	svgDevice.setAttributeNS(null, "transform", "translate(-20, -20)");
	
	svgDevice.onclick = onSelectDevice.bind(undefined, ip);
	svgDevice.addEventListener("link", onLink.bind(undefined, ip));
	
	window.deviceCanvas.appendChild(svgDevice);
	
	svgAddr.textContent = device.ip;
	
	svgLabel.appendChild(svgAddr);
	svgLabel.appendChild(svgDelay);
	
	svgLabel.setAttributeNS(null, "x", device.x);
	svgLabel.setAttributeNS(null, "y", device.y);
	// text baseline이 글자의 밑을 기준으로 하므로 글자 크기만큼 내려준다.
	// 아이콘 크기 + 글자 크기 = 20 + 16 = 36
	svgLabel.setAttributeNS(null, "transform", "translate(0, 36)");
	
	window.deviceCanvas.appendChild(svgLabel);
	
	window.deviceData[ip] = svgDevice;
	window.labelData[ip] = svgLabel;
	
	resetDevice(ip);
}

function resetDevice(ip) {
	var device = getDevice(ip),
		svgDevice = window.deviceData[ip],
		svgDelay = window.labelData[ip].lastChild,
		svgAlert = window.alertData[ip];
	
	svgDevice.setAttributeNS(xlinkNS, "xlink:href", "/img/svg/unknown.svg");
	
	if (device.delay < 0) {
		if (!svgAlert) {
			svgAlert = document.createElementNS(svgNS, "use");
			
			svgAlert.setAttributeNS(xlinkNS, "xlink:href", "#circle");
			svgAlert.setAttributeNS(null, "x", device.x);
			svgAlert.setAttributeNS(null, "y", device.y);
			
			window.deviceCanvas.appendChild(svgAlert);
			
			window.alertData[ip] = svgAlert;
		}
		
		svgDelay.textContent = "";
	}
	else {
		if (svgAlert) {
			delete window.alertData[ip];
			
			window.deviceCanvas.removeChild(svgAlert);
		}
		
		svgDelay.textContent = getDelay(ip) && getDelay(ip).delay || "";
	}
}

function isDevice(node) {
	return node.parentNode === window.deviceCanvas && node.tagName === "image";
}

function moveDevice(device, x, y) {
	var link = window.linkData[device.ip],
		data;
			
	device.x = x;
	device.y = y;		

	var svgDevice = window.deviceData[device.ip],
		svgLabel = window.labelData[device.ip],
		svgAlert = window.alertData[device.ip];
	
	svgDevice.setAttributeNS(null, "x", x);
	svgDevice.setAttributeNS(null, "y", y);
	
	svgLabel.setAttributeNS(null, "x", x);
	svgLabel.setAttributeNS(null, "y", y);
	
	if (svgAlert) {
		svgAlert.setAttributeNS(null, "x", x);
		svgAlert.setAttributeNS(null, "y", y);
	}
	
	for (var peerIP in link) {
		data = link[peerIP];
	
		moveLine(x, y, data, data.peer1 === ip);
	}
}

function onSelectDevice(ip, e) {
	e.stopPropagation();
	
	selectDevice(ip);
}

function topDevice(svgDevice) {
	window.deviceCanvas.appendChild(svgDevice);
}

function moveSelectionMark(x, y) {
	window.selectionMark.setAttributeNS(null, "cx", x);
	window.selectionMark.setAttributeNS(null, "cy", y);
	
	moveAnchor(x, y);
}

function showSelectionMark(x, y) {
	window.deviceCanvas.appendChild(window.selectionMark);
	
	showTool(x, y);
	
	moveSelectionMark(x, y);
}

function clearSelectionMark() {
	documentFragment.appendChild(window.selectionMark);
	
	hideAnchor();
}

function moveAnchor(x, y) {
	ancorTransform.getItem(0).setTranslate(x, y);
}

function showTool(x, y) {
	toolCanvas.appendChild(anchor);
	
	moveAnchor(x, y);
}

function hideAnchor() {
	documentFragment.appendChild(anchor);
}

function setLinkAnchor(x1, y1, x2, y2) {
	linkCanvas.appendChild(linkSVG);
	
	linkCanvas.appendChild(linkAnchor);
	
	linkAnchorTransform.getItem(0).setTranslate(0, 0);
	
	linkAnchor.setAttributeNS(null, "x", x2);
	linkAnchor.setAttributeNS(null, "y", y2);
	
	linkSVG.setAttributeNS(null, "x1", x1);
	linkSVG.setAttributeNS(null, "y1", y1);
	linkSVG.setAttributeNS(null, "x2", x2);
	linkSVG.setAttributeNS(null, "y2", y2);
}
	
function moveLinkAnchor(x, y) {
	linkAnchor.setAttributeNS(null, "x", x);
	linkAnchor.setAttributeNS(null, "y", y);
	
	linkSVG.setAttributeNS(null, "x2", x);
	linkSVG.setAttributeNS(null, "y2", y);
}
	
function restoreLinkAnchor() {
	anchor.appendChild(linkAnchor);
	
	linkAnchorTransform.getItem(0).setTranslate(0, -34);
	
	linkAnchor.setAttributeNS(null, "x", 0);
	linkAnchor.setAttributeNS(null, "y", 0);
	
	documentFragment.appendChild(linkSVG);
}

function addLine(ip) {
	var device = getDevice(ip),
		ifEntry = device.ifEntry,
		peerList = {},
		peer, peerPos, peerIP, link, lineSvg;
	
	window.linkData[ip] = peerList;
	
	for (var peerIP in ifEntry) {
		peer = window.getDevice(peerIP);
		
		if (!peer) {
			delete ifEntry[peerIP];
			
			continue;
		}
		
		// peer가 먼저 svg 만들었다면 공유
		if (window.linkData[peerIP]) {
			link = linkData[peerIP][ip];
		}
		else {
			lineSvg = document.createElementNS(svgNS, "line");
			
			lineSvg.setAttributeNS(null, "x1", device.x);
			lineSvg.setAttributeNS(null, "y1", device.y);
			lineSvg.setAttributeNS(null, "x2", peer.x);
			lineSvg.setAttributeNS(null, "y2", peer.y);
			
			link = {
				peer1: ip,
				peer2: peerIP,
				svg: lineCanvas.appendChild(lineSvg)
			};
		}
		
		peerList[peerIP] = link;
	}
}

function initialize() {
	resize();
	
	for (var ip in getDevice()) {
		addDevice(ip);
		addLine(ip);
	}
	
	setInterval(invalidate, 1000);
}

function invalidate() {
	var svgDevice, delay;
	
	for (var ip in getDevice()) {
		delay = getDelay(ip);
		
		if (delay === undefined) {
			svgDevice = window.deviceData[ip];
			
			svgDevice.setAttributeNS(xlinkNS, "xlink:href", "/img/svg/disabled/unknown.svg");
			device.delay = 0;
		}
		
		resetDevice(ip);
	}
}

function onLink(ip, e) {
	link(ip, e.detail.peer.ip);
	
	location.reload();
}

//abstract
function getDevice(ip) {	
}

//abstract
function removeDevice(ip) {	
}

//abstract
function link(ip, peerIP) {
}

clearSelectionMark();

		</script>
	
	</body>
	
</html>