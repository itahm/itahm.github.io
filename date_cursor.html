<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM</title>
		
		<style>
@import "css/itahm.css";

body {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	margin: 0; padding: 0;
}

svg {
	display: flex;
	justify-content: center;
}

line {
	stroke: #0084ff;
	stroke-width: 2;
}

rect {
	fill: rgba(0, 132, 255, .2);
}

image:hover,
body.move image{
	cursor: e-resize;
}
/*
#top_text {
	alignment-baseline: text-after-edge;
}

#bottom_text {
	alignment-baseline: text-before-edge;
}
*/
#top_text,
#bottom_text {
	text-anchor: start;
}

body.top_reverse #top_text,
body.bottom_reverse #bottom_text {
	text-anchor: end;
}

body:not(.initialized) {
	/*display: none;*/
}

		</style>
		
	</head>
	
	<body>

		<svg width="100%" height="100%">
			<g id="base" transform="translate(0, 0)">
				<rect y="-30" height="60"></rect>
				<g>
					<text id="top_text" transform="translate(0, -12)" />
					<image id="top_cursor" xlink:href="img/cursor_top.png" transform="translate(-10, -12)" x="0" y="0" width="20" height="10" />
				</g>
				<line x1="0" y1="0" y2="0"/>
				<g>
					<text id="bottom_text" transform="translate(0, 12) translate(0, 10)" />
					<image id="bottom_cursor" xlink:href="img/cursor_bottom.png" transform="translate(-10, 2)" x="0" y="0" width="20" height="10" />
				</g>
			</g>
		</svg>
		
		<script src="js/Draggable.js"></script>		
		<script>

var MARGIN = 16,
	MONTH = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

var svg = document.querySelector("svg"),
	base = document.getElementById("base"),
	line = document.querySelector("line"),
	cursorArea = document.querySelector("rect")
	cursorTop = document.getElementById("top_cursor"),
	topText = document.getElementById("top_text"),
	cursorBottom = document.getElementById("bottom_cursor"),
	bottomText = document.getElementById("bottom_text");
	
document.onselectstart = function () {
	return false;
}

new Draggable(document.body);

(function (window, undefined) {
	window.addEventListener("resize", function () {
		if (window.resizeTimer) {
			clearTimeout(window.resizeTimer);
		}
		
		window.resizeTimer = setTimeout(resize, 300);
	});
	
	resize();
	
	function resize() {
		var rect = svg.getBoundingClientRect(),
			max = rect.width - MARGIN *2,
			ratio = (window.max || max) / max,
			topX, bottomX;
		
		base.transform.baseVal.getItem(0).setTranslate(MARGIN, rect.height /2);
		
		topX = Math.round(parseInt(cursorTop.getAttributeNS(null, "x")) / ratio);
		cursorTop.setAttributeNS(null, "x", topX);
		topText.setAttributeNS(null, "x", topX);
		
		bottomX = Math.round(parseInt(cursorBottom.getAttributeNS(null, "x")) / ratio);
		cursorBottom.setAttributeNS(null, "x", bottomX);
		bottomText.setAttributeNS(null, "x", bottomX);
		
		line.setAttributeNS(null, "x2", window.max = max);
	}
	
	document.body.addEventListener("dragstart", function (e) {
		var event = e.detail;
		
		window.target = event.target;
		
		window.topOrigin = parseInt(window.cursorTop.getAttributeNS(null, "x"));
		window.bottomOrigin = parseInt(window.cursorBottom.getAttributeNS(null, "x"));
		window.areaOrigin = parseInt(window.cursorArea.getAttributeNS(null, "x"));
		
		document.body.classList.add("move");
	});
	
	document.body.addEventListener("dragmove", function (e) { 
		if (moveCursor(Math.round(e.detail.dragX / window.days) * window.days)) {
			onResetDate();
		}
		
		moveCursorArea();
	});
	
	document.body.addEventListener("dragend", function (e) {
		document.body.classList.remove("move");
	});
	
	function onResetDate() {
		if (window.topDate === window.bottomDate) {
			return;
		}

		var handler = window.onResetDate || function () {};
		
		if (window.topDate > window.bottomDate) {
			handler(window.bottomDate, window.topDate);
		}
		else {
			handler(window.topDate, window.bottomDate);
		}
	}
	
}) (window);

function calcDate(x) {
	var date = new Date(window.start + (x / window.max) * window.period);
	
	return date.setHours(0, 0, 0, 0);
}

function calcPosition(mills) {
	return window.max * (mills - window.start) / window.period;
}

function setDate(text, x) {
	var date = new Date(start + (x / max) * period),
		dateText = MONTH[date.getMonth()] +" "+ date.getDate();
	
	text.textContent = dateText;
	
	return date.setHours(0, 0, 0, 0);
}

function getPosition(mills) {
	return Math.ceil(window.max * (mills - window.start) / window.period);
}

function moveCursor(dragX) {	
	if (window.target === window.cursorTop) {
		var topDate = window.topDate,
			x = window.topOrigin + dragX;
		
		if (dragX < 0) {
			x = Math.max(0, x);
		}
		else if (dragX > 0) {
			x = Math.min(window.max, x);
		}
		
		moveCursorTop(x);
		
		if (topDate != window.topDate) {
			return true;
		}
	}
	else if (window.target === window.cursorBottom) {
		var bottomDate = window.bottomDate,
			x = window.bottomOrigin + dragX;
		
		if (dragX < 0) {
			x = Math.max(0, x);
		}
		else if (dragX > 0) {
			x = Math.min(window.max, x);
		}
		
		moveCursorBottom(x);
		
		if (bottomDate != window.bottomDate) {
			return true;
		}
	}
	else if (window.target === window.cursorArea) {
		var topDate = window.topDate,
			bottomDate = window.bottomDate;
		
		if (dragX < 0) {
			dragX = - Math.min(Math.abs(dragX), Math.min(window.topOrigin, window.bottomOrigin))
		}
		else if (dragX > 0) {
			dragX = Math.min(dragX, window.max - Math.max(window.topOrigin, window.bottomOrigin))
		}
		
		moveCursorTop(window.topOrigin + dragX);
		moveCursorBottom(window.bottomOrigin + dragX);
		
		if (topDate != window.topDate || bottomDate != window.bottomDate) {
			return true;
		}
	}
}

function moveCursorTop(x) {
	//x = calcPosition(calcDate(x));
	//console.log(x, calcPosition(calcDate(x)));
	window.topText.setAttributeNS(null, "x", x);
	window.cursorTop.setAttributeNS(null, "x", x);
	window.topDate = setDate(window.topText, x);
	
	document.body.classList[x > window.max /2? "add": "remove"]("top_reverse");
}

function moveCursorBottom(x) {
	//x = calcPosition(calcDate(x));
	
	window.bottomText.setAttributeNS(null, "x", x);
	window.cursorBottom.setAttributeNS(null, "x", x);
	window.bottomDate = setDate(bottomText, x);
	
	document.body.classList[x > window.max /2? "add": "remove"]("bottom_reverse");
}

function moveCursorArea() {
	var x1 = parseInt(window.cursorTop.getAttributeNS(null, "x")),
		x2 = parseInt(window.cursorBottom.getAttributeNS(null, "x"));
	
	window.cursorArea.setAttributeNS(null, "x", Math.min(x1, x2));
	window.cursorArea.setAttributeNS(null, "width", Math.abs(x1 - x2));
}

function initialize(start, end, top, bottom) {
	var date = new Date();
	
	window.start = start;
	window.period = end - start;
	
	window.days = period / (date.getTime() - date.setDate(date.getDate() -1));
	console.log(days);
	moveCursorTop(getPosition(top));
	moveCursorBottom(getPosition(bottom));
	moveCursorArea();
	
	document.body.classList.add("initialized");
}
		</script>
	
	</body>
	
</html>