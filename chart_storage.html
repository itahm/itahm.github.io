<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM</title>
		
		<style>
		
@import "css/itahm.css";
@import "css/chart.css";

		</style>
		
	</head>
	
	<body>
		
		<header>
			<h2 id="storage_name"></h2>
			<div id="legend"></div>
		</header>
		
		<iframe id="chart" src="chart_base.html" class="chart"></iframe>
		
		<script src="js/ITAhM.js"></script>	
		<script src="js/object.js"></script>
		<script>

var chart = document.getElementById("chart"),
	chartWindow = chart.contentWindow,
	deviceIP = top.databases.device.selected,
	resourceIndex = top.databases.device.resourceIndex,
	snmp = top.databases.snmp;

if(!deviceIP || !snmp) {
	throw "!";
}

window.chart.onload = function () {
	window.chartWindow.onValueToString = onValueToString;
};
/**
 * public
 */
function initialize(from, to, start, end) {
	var entry = snmp.hrStorageEntry[resourceIndex],
		request = {
			command: "query",
			ip: window.deviceIP,
			summary: true,
			database: "hrStorageUsed",
			index: resourceIndex,
			start: from,
			end: to
		};
	
	window.max = entry.hrStorageSize * entry.hrStorageAllocationUnits;
	
	top.sendRequest(request, onResponse);
	
	window.start = start;
	window.end = end;
	
	document.getElementById("storage_name").textContent = entry.hrStorageDescr;
	document.getElementById("legend").textContent = "Storage volume : "+ ITAhM.util.toBytesString(max);
}

function onResponse(data) {
	window.summaryData = new ITAhM.ChartSummaryData(data);
	chartWindow.initialize(window.summaryData, window.max, "#9d9789");
	chartWindow.draw(window.start, window.end);
}

function onValueToString(value) {
	return ITAhM.util.toBytesString(value).replace("ytes", "");
}

/**
 * public
 */
function draw(start, end) {
	if (start === end || (start === window.start && end === window.end)) {
		return;
	}
	
	window.start = start;
	window.end = end;
	
	window.chartWindow.draw(window.start, window.end);
}

/**
 * public
 */
function getFile() {
	var chartData = window.chartWindow.chartData,
		blocks = chartData.keys,
		row, block, date, mills, value, k = 0;
	
	if (false) {
	}
	//if (date.setDate(date.getDate() +1) === window.end) {}
	else {
		row = ["index,date,max,avg,min"];
		
		for (var i=0, _i=blocks.length; i<_i; i++) {
			block = blocks[i];
			
			for (var j=0, _j=block.length; j<_j; j++) {
				mills = block[j];
				value = window.summaryData.get(mills);
				
				date = new Date(mills);
				
				row[row.length] = [k++, ITAhM.util.toDateTimeString(date), value.max, value.avg, value.min].join(",");
			}
		}
		
		ITAhM.util.download(new Blob([row.join("\n")] ,{
				type: "text/csv;charset=utf-8;"
			}), "chart_storage.csv");
	}
}
		</script>
	
	</body>
	
</html>