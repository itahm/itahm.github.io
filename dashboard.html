<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>Dashboard @ ITAhM</title>
		
		<style>
@import "css/itahm.css";

body {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	padding: 1em; margin: 0;
	display: flex;
	background-color: #4d525a;
	color: #fff;
}

aside {
	width: 400px;
	display: flex;
	flex-direction: column;
}

aside .aside {
	flex: 2;
	display: flex;
	flex-direction: column;
}

aside section {
	flex: 1;
}

article {
	flex: 1;
	height: 100%;
	display: flex;
	flex-direction: column;
}

.extra {
	width: 600px;
	box-sizing: border-box;
	display: flex;
	flex-direction: column;
}

@media (max-width: 1720px) {
  .extra {
  	display: none;
  }
}

.extra iframe {
	flex: 1;
	border: none;
}

aside .head {
	display: flex;
}

aside .agent {
	width: 200px;
}

aside .statistic {
	flex: 1;
	overflow: auto;
}

.statistic ul {
	background-color: #fff;
	color: #000;
}

article> :not(header) {
	display: flex;
	flex: 1;
	overflow-y: auto;
}

section {
	margin: 0 .5em;
	flex: 1;
	display: flex;
	flex-direction: column;
}

.title {
	padding: .5em 2em;
	border-radius: 5px;
	
	border-bottom: none;
	font-weight: bold;
	color: #fff;
	background-color: #0084ff;
	text-shadow: 1px 1px 1px #00f;
}


section> div:last-child {
	flex: 1;
	overflow: auto;
}

ul {
	list-style: none;
	padding: 0; margin: 0;
}

.list {
	padding: .5em; 1em;
}

.summary {
	display: flex;
}

.summary li {
	flex: 1;
	padding: .5em;
	text-align: center;
}

.summary:first-child,
.summary li:first-child {
	font-weight: bold;
}

.summary li:nth-child(1) {
	flex: 1.5;
	border-right: 1px solid #fff;
	background-color: #ddd;
}

.summary li:nth-child(2) {
	background-color: rgba(255, 204, 0, .5);
}

.summary li:nth-child(3) {
	background-color: rgba(255, 0, 0, .5);
}

.summary li:nth-child(4) {
	background-color: rgba(119, 221, 119, .5);
}

.summary li:last-child {
	color: #000;
	background-color: #ddd;
}

.summary:first-child {
	border-bottom: 1px solid #fff; 
}

#summary_list {
	transform: scaleY(0);
	transition: transform .5s cubic-bezier(.9, .1, .9, .1);
}

#summary_list.initialized {
	transform: scaleY(1);
}

.list_item ul {
	display: flex;
	cursor: pointer;
	padding: .5em;
}

.list_item ul.default {
	transition-duration: .5s;
}

.list_item ul.default:hover {
	text-decoration: underline;
	border-radius: 0 0 .5em .5em;
	box-shadow: 0 .3em #999;
	padding: .2em .5em .5em .5em;
	margin-bottom: .3em;
}

.list_item ul.simple:hover {
	background-color: #fff;
	color: #0084ff;
	border-radius: 1em;
}

.list_item li {
	flex: 1;
}

.list_item li:last-child {
	text-align: right;
	flex: 2;
}

.agent_status {
	display: flex;
}

.agent_status li {
	flex: 1;
	padding: .5em;
	text-align: right;
}

.agent_status li:first-child {
	text-align: center;
}

#counter {
	margin: 1em;
	position: relative;
	width: 10em;
	height: 10em;
}

#counter div {
	position: absolute; top: 0; left: 0;
	width: 10em; height: 10em;
}

#counter div:nth-child(1) {
	border-radius: 50%;
	border: 1em solid #00f;
	box-sizing: border-box;
	display: flex;
	flex-direction: column;
	justify-content: center;
	align-items: center;
}

#counter div:nth-child(3) {
 	transform-origin: 5em 5em;
 	animation: count 10s infinite linear;
}

#counter span {
	margin: 0 auto;
	display: block;
	width: 1em; height: 1em;
	border-radius: 50%;
	background-color: #fff;
}

#counter hr {
	margin: 0 auto;
	width: 4px; height: 1em;
	background-color: #fff;
	border: none;
}

@keyframes count {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.layout {
	display: none;
}

		</style>
		
		<script>

		
function update() {
	top.sendRequest({
		command: "top",
		ip: "127.0.0.1"
	}, function (response) {
		window.updateTime.textContent = getTime();
		
		setTop(response.responseTime, window.responseTime, toMillsString);
		setTop(response.failureRate, window.responseRate, toPercentageString);
		setTop(response.processor, window.processor, toPercentageString);
		setTop(response.memory, window.memory, ITAhM.util.toBytesString);
		setTop(response.memoryRate, window.memoryRate, toPercentageString);
		setTop(response.storage, window.storage, ITAhM.util.toBytesString);
		setTop(response.storageRate, window.storageRate, toPercentageString);
		setTop(response.throughput, window.throughput, ITAhM.util.toBPSString);
		setTop(response.throughputRate, window.throughputRate, toPercentageString);
		setTop(response.throughputErr, window.throughputErr, toErrorString);
	});
	
	top.sendRequest({
		command: "agent",
	}, function (response) {
		connections.textContent = response.connections;
		waiters.textContent = response.waiters;
		space.textContent = ITAhM.util.toBytesString(response.space);
	});
}

function initStats() {
	var deviceData = top.databases.device,
		monitorData = top.databases.monitor,
		df = document.createDocumentFragment(),
		monitor,
		shutdown = 0,
		critical = 0,
		normal = 0,
		labelData = {},
		device, count;
	
	for (var ip in deviceData) {
		device = deviceData[ip];
		monitor = monitorData[ip];
	
		if (!monitor) {
			continue;
		}
		
		if (device.label) {
			labels = device.label.split(",");
			
			for (var i=0, length=labels.length; i<length; i++) {
				if (!labelData[labels[i]]) {
					labelData[labels[i]] = {
						shutdown: 0,
						critical: 0,
						normal: 0
					}
				}
				
				if (monitor.shutdown) {
					labelData[labels[i]].shutdown++;
				}
				else if (monitor.critical) {
					labelData[labels[i]].critical++;
				}
				else {
					labelData[labels[i]].normal++;
				}
			}
		}
		
		if (monitor.shutdown) {
			shutdown++;
		}
		else if (monitor.critical) {
			critical++;
		}
		else {
			normal++;
		}		
	}
	
	df.appendChild(createStatusItem("전체", critical, shutdown, normal, critical + shutdown + normal));
	
	var ls //labeledSummary;
	for (var label in labelData) {
		ls = labelData[label];
		
		df.appendChild(createStatusItem(label, ls.critical, ls.shutdown, ls.normal, ls.critical + ls.shutdown + ls.normal));
	}
	
	summaryList.appendChild(df);
}

function toErrorString(value) {
	return (value /10).toFixed(0);
}

function toMillsString(value) {
	return value +"ms";
}

function toPercentageString(value) {
	return value +"%";
}

function clear(list) {
	var child;
	
	while(child = list.firstChild) {
		list.removeChild(child);
	}
}

function getTime() {
	var date = new Date(),
		h = date.getHours(),
		m = date.getMinutes(),
		s = date.getSeconds();
	
	return (h > 9? "": "0") + h +" : "+ (m > 9? "": "0") + m +" : "+ (s > 9? "": "0") + s;
}

function setTop(top, list, toString) {
	var ipList = Object.keys(top).sort(function (a, b) {
			return top[b] - top[a];
		}),
		ip;
	
	clear(list);
	
	for (var i=0, length=ipList.length; i< length; i++) {
		ip = ipList[i];
		
		list.appendChild(createTopItem(ip, toString(top[ip])));
	}
}

function onSelectTopItem(ip) {
	top.databases.local.selected = ip;
	
	location.href = "status.html";
}

function createStatusItem(label, critical, shutdown, normal, sum) {
	var clone = summaryItem.cloneNode(true);
	
	clone.children[0].textContent = label;
	clone.children[1].textContent = critical;
	clone.children[2].textContent = shutdown;
	clone.children[3].textContent = normal;
	clone.children[4].textContent = sum;
	
	return clone;
}

function createTopItem(ip, value) {
	var clone = listItem.cloneNode(true),
		item = clone.children[0];
	
	item.children[0].textContent = ip;
	item.children[1].textContent = value;
	item.title = top.databases.device[ip].name || ip;
	
	clone.onclick = onSelectTopItem.bind(window, ip);
	
	return clone;
}

// public
function onEvent(ip) {
	document.getElementById("event").contentWindow.location.reload();
	document.getElementById("map").contentWindow.location.reload();
}
		
		</script>
		
	</head>
	
	<body class="loading">
		<aside>
			<div class="aside">
				<div class="head">
					<section class="agent">
						<div class="title">에이전트</div>
						<div class="list">
							<ul>
								<li>
									<ul class="agent_status">
										<li>접속 연결수
										<li id="connections">
									</ul>
								<li>
									<ul class="agent_status">
										<li>이벤트 대기
										<li id="waiters">
									</ul>
								<li>
									<ul class="agent_status">
										<li>저장공간 여유
										<li id="space">
									</ul>
								<li>
									<ul class="agent_status">
										<li>에이전트 버전
										<li id="version">
									</ul>
							</ul>
						</div>
					</section>
					<div id="counter">
						<div>
							갱신시간
							<p id="update"></p>
						</div>
						<div>
							<hr></hr>
						</div>
						<div>
							<span></span>
						</div>
					</div>
				</div>
				<div class="statistic">
					<ul class="summary">
						<li>구분
						<li>임계 초과
						<li>응답 없음
						<li>정상
						<li>합계
					</ul>
					<ul id="summary_list">
					</ul>
				</div>
			</div>
			<section>
				<div class="title">SNMP 실패 Top</div>
				<div class="list">
					<ul id="failure_rate"></ul>
				</div>
			</section>
		</aside>
		<article>
			<div class="top">
				<section>
					<div class="title">응답 시간 Top</div>
					<div class="list">
						<ul id="response_time"></ul>
					</div>
				</section>
				<section>
					<div class="title">물리적 메모리 사용량 Top</div>
					<div class="list">
						<ul id="memory"></ul>
					</div>
				</section>
				<section>
					<div class="title">물리적 메모리 사용율 Top</div>
					<div class="list">
						<ul id="memoryRate"></ul>
					</div>
				</section>
			</div>
			
			<div class="top">
				<section>
					<div class="title">프로세서 로드 Top</div>
					<div class="list">
						<ul id="processor"></ul>
					</div>
				</section>
				<section>
					<div class="title">저장공간 사용량 Top</div>
					<div class="list">
						<ul id="storage"></ul>
					</div>
				</section>
				<section>
					<div class="title">저장공간 사용율 Top</div>
					<div class="list">
						<ul id="storageRate"></ul>
					</div>
				</section>
			</div>
			
			<div class="top">
				<section>
					<div class="title green">통신 에러 Top</div>
					<div class="list">
						<ul id="throughputErr"></ul>
					</div>
				</section>
				<section>
					<div class="title green">통신 사용량 Top</div>
					<div class="list">
						<ul id="throughput"></ul>
					</div>
				</section>
				<section>
					<div class="title green">통신 사용율 Top</div>
					<div class="list">
						<ul id="throughputRate"></ul>
					</div>
				</section>
			</div>
		</article>
		
		<div class="extra">
			<div class="title">이벤트</div>
			<iframe src="event_extra.html" id="event" width="100%" height="100%"></iframe>
			<div class="title">구성도</div>
			<iframe src="map_extra.html" id="map" width="100%" height="100%"></iframe>
		</div>
			
		<div class="layout">
			<ul>
				<li class="list_item">
					<ul class="simple">
						<li>
						<li>
					</ul>
			</ul>
		</div>
		
		<div class="bg_loading"></div>
		<script src="/js/ITAhM.js"></script>
		<script>

var summaryList = document.getElementById("summary_list"),
	summaryItem = document.querySelector(".summary"),
	listItem = document.querySelector(".list_item"),
	responseTime = document.getElementById("response_time"),
	responseRate = document.getElementById("failure_rate"),
	processor = document.getElementById("processor"),
	memory = document.getElementById("memory"),
	memoryRate = document.getElementById("memoryRate"),
	storage = document.getElementById("storage"),
	storageRate = document.getElementById("storageRate"),
	throughput = document.getElementById("throughput"),
	throughputRate = document.getElementById("throughputRate"),
	throughputErr = document.getElementById("throughputErr"),
	updateTime = document.getElementById("update"),
	connections = document.getElementById("connections"),
	waiters = document.getElementById("waiters"),
	space = document.getElementById("space");

initStats();

update();

document.getElementById("counter").addEventListener("animationiteration", update);

document.getElementById("version").textContent = sessionStorage.version;

document.body.classList.remove("loading");

setTimeout(function () {
	summaryList.classList.add("initialized");
}, 500);

		</script>
	
	</body>
	
</html>