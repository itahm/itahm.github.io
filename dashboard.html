<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>Dashboard @ ITAhM</title>
		
		<style>
@import "css/itahm.css";

body {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	padding: 0; margin: 0;
	display: flex;
	align-items: stretch;
	background-color: #4d525a;
	color: #fff;
}

aside {
	width: 300px;
	display: flex;
	box-sizing: border-box;
	padding: .5em;
	flex-direction: column;
	text-shadow: 1px 1px 1px #000;
}

aside> .top {
	height: 140px;
	display: flex;
	justify-content: space-around;
	align-items: center;
}

#summary_list {
	position: relative;
	flex: 1;
	overflow-y: auto;
}

article {
	flex: 1;
	display: flex;
	flex-direction: column;
}

article> div:first-child {
	flex: 1;
	margin: 1em;
}

article> div:last-child {
	flex: none;
	height: 120px;
}

iframe {
	border: none;
}

#map {
	border: 5px solid #0084ff;
	box-sizing: border-box;
	border-radius: 5px;
	margin-bottom: 5px;
}

section {
	display: flex;
	flex: 1 1 auto;
	min-width: 260px;
	margin: 0 .5em;
	flex-direction: column;
}

.title,
section div:first-child {
	padding: .5em 2em;
	border-radius: 3px 3px 0 0;
	border-bottom: none;
	font-weight: bold;
	color: #fff;
	background-color: #0084ff;
	text-shadow: 1px 1px 1px #00f;
}

section> div:last-child {
	flex: 1;
	overflow: auto;
}

ul {
	list-style: none;
	padding: 0; margin: 0;
}

.list {
	padding: .5em; 1em;
}

.right {
	width: 320px;
	overflow-y: auto;
}

#top_list {
	flex: 1;
}

.summary {
	display: flex;
	font-weight: bold;
}

.summary> li {
	flex: 1;
	padding: 3px;
}

.summary> li:first-child {
	flex: 2;
}

header {
	margin-bottom: 1em;
	text-align: center;
}

header> ul {
	display: flex;
}

header> ul> li {
	padding: .5em;
	border-radius: 10px 10px 0 0;
	box-shadow: 0 0 5px #fff inset;
	flex: 1;
}

header> ul> li:nth-child(1) {
	background-color: #f00;
}

header> ul> li:nth-child(2) {
	background-color: #fc0;
}

header> ul> li:nth-child(3) {
	background-color: #0f0;
}

#summary_list> .summary> li:first-child {
	display: flex;
	justify-content: center;
	align-items: center;
}

#summary_list> .summary> li:not(:first-child)::after {
	margin: auto;
	content: attr(data-value);
	width: 40px; height: 40px;
	border-radius: 50%;
	background: linear-gradient(to top,  rgba(187,187,187,1) 0%,rgba(119,119,119,1) 99%);
	box-shadow: inset 0 -5px 15px rgba(255,255,255,0.4), inset -2px -1px 40px rgba(0,0,0,0.4), 0 0 1px #000;
	display: flex;
	justify-content: center;
	align-items: center;
}

#summary_list> .summary> li:nth-child(2)::after {
	background: linear-gradient(to top,  hsla(0, 75%, 50%, 1) 0%, hsla(0, 75%, 30%,1) 99%);
}

#summary_list> .summary> li:nth-child(3)::after {
	background: linear-gradient(to top,  hsla(30, 75%, 50%, 1) 0%, hsla(30, 75%, 30%,1) 99%);
}

#summary_list> .summary> li:nth-child(4)::after {
	background: linear-gradient(to top,  hsla(120, 75%, 50%, 1) 0%, hsla(120, 75%, 30%,1) 99%);
}

.list_item {
	border-bottom: 1px solid #777;
	display: flex;
	cursor: pointer;
	padding: 3px;
}

.list_item:hover {
	background-color: #fff;
	color: #0084ff;
	outline: 1px solid #0084ff;
}

.list_item> li {
	flex: 1;
	overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}

select[name=option] {
	background-color: #0084ff;
	border: none;
	outline: none;
	color: #fff;
	float: right;
}

body:not(.name) .list_item> li:nth-child(1),
body.name .list_item> li:nth-child(2) {
	display: none;
}

.list_item> li:last-child {
	text-align: right;
	flex: .5;
	overflow: hidden;
}

.list_item> li:last-child::after {
	content: attr(data-value);
	display: inline-block;
	animation: flow 1s;
}

.agent_status {
	display: flex;
	padding: .5em;
}

.agent_status li:first-child {
	flex: none;
}

.agent_status li:last-child {
	flex: 1;
	text-align: right;
}

.agent_status li:first-child {
	text-align: center;
}

@keyframes flow {
	0% {
		transform: translateY(0);
	}
	100% {
		transform: translateY(-100%);
	}
}

.layout {
	display: none;
}

/* bounce >> */
.ball {
	position: relative;
	width: 60px;
	height: 120px;
	color: #fff;
	font-weight: bold;
}

.ball div:first-child {
	position: absolute; top: 0; left: 0;
	width: 100%;
	height: 50%;
	border-radius: 50%;
	background: linear-gradient(to top,  rgba(187,187,187,1) 0%,rgba(119,119,119,1) 99%);
	box-shadow: inset 0 -5px 15px rgba(255,255,255,0.4), inset -2px -1px 40px rgba(0,0,0,0.4), 0 0 1px #000;
	display: flex;
	justify-content: center;
	align-items: center;
	animation: bounce 10s infinite;
}

.green.ball div:first-child {
	background: linear-gradient(to top,  hsla(120, 75%, 50%,1) 0%, hsla(120, 75%, 30%,1) 99%);
}

.orange.ball div:first-child {
	background: linear-gradient(to top,  hsla(30, 75%, 50%,1) 0%, hsla(30, 75%, 30%,1) 99%);
	animation-delay: .5s;
}

.red.ball div:first-child {
	background: linear-gradient(to top,  hsla(0, 75%, 50%,1) 0%, hsla(0, 75%, 30%,1) 99%);
	animation-delay: 1s;
}

.ball div:first-child:before {
	content: "";
	position: absolute;
	width: 50%;
	height: 25%;
	border-radius: 50%;
	left: 25%;
	top: 5%;
	background: linear-gradient(to bottom,  rgba(232,232,232,1) 0%,rgba(232,232,232,1) 1%,rgba(255,255,255,0) 100%);
}

.ball div:first-child::after {
	content: attr(data-value);
}

.ball div:last-child {
	position: absolute; bottom: 0;
	width: 100%;
	height: 20%;
	display: flex;
	justify-content: center;
	align-items: center;
}

.ball div:last-child::after {
	content: "";
	width: 100%;
	height: 80%;
	border-radius: 50%;
	background: rgba(20, 20, 20, 0.1);
	animation: shadow 1s;
}

@keyframes bounce {
	0% {
		top: 0;
		animation-timing-function: ease-in;
	}
	4% {
		top: 40%;
		height: 50%;
		animtion-timing-function: ease-out;
	}
	5% {
		top: 45%;
		height: 45%;
		animation-timing-function: ease-in;
	}
	6% {
		top: 30%;
		height: 50%;
		animation-timing-function: ease-out;
	}
	10% {
		top: 0;
		animation-timing-function: ease-in;
	}
}

@keyframes shadow {
	0% {
		background: rgba(20, 20, 20, .1);
		animation-timing-function: ease-in;
	}
	50% {
		background: rgba(20, 20, 20, .3);
		height: 40%;
		width: 80%;
		animation-timing-function: ease-out;
	}
	100% {
		background: rgba(20, 20, 20, .1);
		animation-timing-function: ease-in;
	}
}

/* << bounce */
		</style>
		
		<script>

function initialize() {
	var df = document.createDocumentFragment();
	
	if ("dashboard" in top.databases.config) {
		var resources = top.databases.config.dashboard,
			order = Object.keys(resources),
			resource;
		
		[].sort.call(order, function (a, b) {
			return parseInt(a) - parseInt(b);
		})
		
		for (var i=0, _i=order.length; i<_i; i++) {
			df.appendChild(createTopList(resources[order[i]]));
		}
	}
	else {
		for (var id in window.resources) {
			df.appendChild(createTopList(id));
		}
	}

	document.getElementById("top_list").appendChild(df);
	
	update();
	
	document.body.classList.remove("loading");
	
	window.setInterval(update, 10000);
}

function createTopList(resource) {
	var section = document.createElement("section"),
		list = document.createElement("div");

	section.appendChild(document.createElement("div")).textContent = window.resources[resource].title;
	section.appendChild(list).className = "list";
	
	window.topList[resource] = list;
	
	return section;
}

function update() {
	document.body.classList.remove("update");
	
	top.sendRequest({
		command: "extra",
		extra: "top",
		ip: "127.0.0.1"
	}, function (response) {
		var list;
		
		for (var resource in window.topList) {
			list = window.topList[resource];
			
			if (resource in response) {
				setTop(response[resource], list, window.resources[resource].toString, window.resources[resource].skipZero);
			}
		}
	
		document.body.classList.add("update");
	});
	
	initStats();
}

function initStats() {
	var deviceData = top.databases.device,
		monitorData = top.databases.monitor,
		df = document.createDocumentFragment(),
		monitor,
		shutdown = 0,
		critical = 0,
		normal = 0,
		labelData = {},
		device, count;
	
	while (window.summaryList.firstChild) {
		window.summaryList.removeChild(window.summaryList.firstChild);
	}
	
	for (var ip in deviceData) {
		device = deviceData[ip];
		monitor = monitorData[ip];
	
		if (!monitor) {
			continue;
		}
		
		if (device.label) {
			labels = device.label.split(",");
			
			for (var i=0, length=labels.length; i<length; i++) {
				if (!labelData[labels[i]]) {
					labelData[labels[i]] = {
						shutdown: 0,
						critical: 0,
						normal: 0
					}
				}
				
				if (monitor.shutdown) {
					labelData[labels[i]].shutdown++;
				}
				else if (monitor.critical) {
					labelData[labels[i]].critical++;
				}
				else {
					labelData[labels[i]].normal++;
				}
			}
		}
		
		if (monitor.shutdown) {
			shutdown++;
		}
		else if (monitor.critical) {
			critical++;
		}
		else {
			normal++;
		}		
	}
	
	window.alert.dataset.value = shutdown;
	window.critical.dataset.value = critical;
	window.normal.dataset.value = normal;
	
	var ls;
	for (var label in labelData) {
		ls = labelData[label];
		
		df.appendChild(createStatusItem(label, ls.critical, ls.shutdown, ls.normal, ls.critical + ls.shutdown + ls.normal));
	}
	
	window.summaryList.appendChild(df);
}

function toErrorString(value) {
	return (value /10).toFixed(0);
}

function toMillsString(value) {
	return value +"ms";
}

function toPercentageString(value) {
	return value +"%";
}

function clear(list) {
	var child;
	
	while(child = list.firstChild) {
		list.removeChild(child);
	}
}

function getTime() {
	var date = new Date(),
		h = date.getHours(),
		m = date.getMinutes(),
		s = date.getSeconds();
	
	return (h > 9? "": "0") + h +" : "+ (m > 9? "": "0") + m +" : "+ (s > 9? "": "0") + s;
}

function setTop(list, eList, toString, skipZero) {
	var ipList = Object.keys(list).sort(function (a, b) {
			return list[b] - list[a];
		}),	ip;
	
	clear(eList);
	
	for (var i=0, _i=ipList.length, j=0, max=top.databases.config.top; i< _i; i++) {
		ip = ipList[i];
		
		if (list[ip] || !skipZero) {
			eList.appendChild(createTopItem(ip, toString(list[ip])));
			
			if (++j >= max) {
				break;
			}
		}
	}
}

function createStatusItem(label, critical, alert, normal, sum) {
	var ul = document.createElement("ul");
	
	ul.appendChild(document.createElement("li")).textContent = label;
	ul.appendChild(document.createElement("li")).dataset.value = alert;
	ul.appendChild(document.createElement("li")).dataset.value = critical;
	ul.appendChild(document.createElement("li")).dataset.value = normal;
	
	ul.className = "summary";
	
	return ul;
}

function createTopItem(ip, value) {
	var item = document.createElement("ul");
	
	item.appendChild(document.createElement("li")).textContent = top.databases.device[ip].name || ip;
	item.appendChild(document.createElement("li")).textContent = ip;
	item.appendChild(document.createElement("li")).dataset.value = value;
	
	item.onclick = top.showChart.bind(window, ip);
	
	item.className = "list_item";
	
	return item;
}

// public
function onEvent(ip) {
	window.eventFrame.contentWindow.location.reload();
	window.mapFrame.contentWindow.location.reload();
}

		</script>
		
	</head>
	
	<body class="loading name">
		<aside>
			<header>
				<ul>
					<li>장애
					<li>임계
					<li>정상
				</ul>
			</header>
			
			<div class="top">
				<div class="ball red">
					<div id="alert"></div>
					<div></div>
				</div>
				<div class="ball orange">
					<div id="critical"></div>
					<div></div>
				</div>
				<div class="ball green">
					<div id="normal"></div>
					<div></div>
				</div>
			</div>

			<div id="summary_list"></div>
			
		</aside>
		
		<article>
			<div>
				<iframe src="map_extra.html" id="map" width="100%" height="100%"></iframe>
			</div>
			<div>
				<iframe src="event_extra.html" id="event" width="100%" height="100%"></iframe>
			</div>
		</article>
		
		<div class="right">
			<div id="top_list"></div>
		</div>
			
		<div class="bg_loading"></div>
		<script src="/js/ITAhM.js"></script>
		<script>

var summaryList = document.getElementById("summary_list"),
	eventFrame = document.getElementById("event"),
	mapFrame = document.getElementById("map"),
	topList = {},
	alert = document.getElementById("alert"),
	critical = document.getElementById("critical"),
	normal = document.getElementById("normal"),
	resources = {
		responseTime: {
			title: "응답시간",
			toString: toMillsString
		},
		processor: {
			title: "프로세서 로드",
			toString: toPercentageString
		},
		memory: {
			title: "메모리 사용량",
			toString: ITAhM.util.toBytesString
		},
		memoryRate: {
			title: "메모리 사용율(%)",
			toString: toPercentageString
		},
		storage: {
			title: "저장공간 사용량",
			toString: ITAhM.util.toBytesString
		},
		storageRate: {
			title: "저장공간 사용율(%)",
			toString: toPercentageString
		},
		throughput: {
			title: "통신 사용량",
			toString: ITAhM.util.toBPSString
		},
		throughputRate: {
			title: "통신 사용율(%)",
			toString: toPercentageString
		},
		throughputErr: {
			title: "통신 오류",
			toString: toErrorString,
			skipZero: true
		},
		failureRate: {
			title: "SNMP 오류",
			toString: toPercentageString,
			skipZero: true
		}
	};

if ("display" in top.databases.config) {
	document.body.classList[top.databases.config.display == "name"? "add": "remove"]("name");
}

initialize();

		</script>
	
	</body>
	
</html>