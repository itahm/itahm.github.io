<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		
		<title>List @ ITAhM</title>
		
		<style>
@import "css/itahm.css";

body {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	margin: 0; padding: 0;
}

article {
	display: flex;
	flex-direction: column;
	margin: auto;
	height: 99%;
}

aside {
	margin: 5px 0;
	display: flex;
	justify-content: space-between;
}

#list {
	flex: 1;
	background-color: #fff;
	overflow-y: scroll;
}

header {
	margin: 5px 0;
	background-color: #0084ff;
	color: #fff;
	font-weight: bold;
	text-align: center;
	box-shadow: 0 0 5px #fff inset;
}

header ul::after {
	content: "";
	display: inline-block;
	width: 16px;
}

header li:nth-child(2),
header li:nth-child(3),
header li:nth-child(4) {
	border-right-color: #ddd;
}

aside input,
aside select {
	padding: .5em;
}

form input[type="text"] {
	flex: 1;
	min-width: 0;
}

nav {
	display: flex;
	align-items: center;
}
nav> div {
	margin-right: 5px;
}

ul {
	margin: 0;
	padding: 3px 0;
	list-style: none;
	display: flex;
}

li {
	flex: 1;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
	font-size: 12px;
	border: 1px solid transparent;
}

li:nth-child(1) {
	flex: none;
	width: 3em;
}

label {
	color: #fff;
}

#list ul {
	border-bottom: 1px solid #ddd;
}

#list ul:hover {
	background-color: #fff;
	box-shadow: 0 0 5px gray inset;
}

#list li:nth-child(1) {
	background: transparent center no-repeat;
	background-size: 16px;
}

#list ul[data-shutdown] li:nth-child(1) {
	background-image: url("img/ball_red.png");
}

#list ul[data-critical] li:nth-child(1) {
	background-image: url("img/ball_orange.png");
}

#list ul[data-normal] li:nth-child(1) {
	background-image: url("img/ball_green.png");
}

#list ul[data-disabled] li:nth-child(1) {
	background-image: url("img/ball_gray.png");
}

li:nth-child(5),
li:nth-child(6),
li:nth-child(7),
li:nth-child(8) {
	flex: none;
	width: 3em;
	background-size: 16px;
	background-repeat: no-repeat;
	background-position: center;
}

#list ul[data-disabled] {
	color: #999;
}

#list ul:hover li:nth-child(5) {
	background-image: url("img/location.png");
	
}

#list ul:hover li:nth-child(6) {
	background-image: url("img/edit.png");
	cursor: pointer;
}

#list ul[data-snmp]:hover li:nth-child(7) {
	background-image: url("img/alarm_gray.png");
	cursor: pointer;
}

#list ul[data-alarm]:hover li:nth-child(7) {
	background-image: url("img/alarm.png");
	cursor: pointer;
}

#list ul[data-snmp]:hover li:nth-child(8) {
	background-image: url("img/chart.png");
	cursor: pointer;
}

#list ul:nth-child(odd) {
	background-color: #fafafa;
}

#count {
	border: 2px ridge #fff;
	width: 100px; height: 100%;
	position: relative;
	color: #fff;
	font-size: 18px; font-weight: bold;
}

#count::after {
	content: attr(data-value);
	position: absolute; top: 50%; left: 50%;
	transform: translateX(-50%) translateY(-50%);
}

li {
	padding: 3px;
}

div.selector {
	font-size: 10px;
	display: inline-block;
}

div.selector span {
	border: 2px solid transparent;
	border-radius: 20px;
	display: inline-block; height: 18px; width: 18px;
	animation: slide .5s ease-in;
}

div.selector span.selected {
	transform: scale(1.5);
	animation: grow .5s ease-in;
}

div.selector span[data-status] {
	background-color: black;
	border-color: gray;
}

div.selector span[data-status=normal] {
	background-color: green;
	border-color: yellow;
}

div.selector span[data-status=shutdown] {
	background-color: red;
	border-color: pink;
}

div.selector span[data-status=critical] {
	background-color: orange;
	border-color: yellow;
}

div.selector span[data-status=disabled] {
	background-color: gray;
	border-color: white;
}

@keyframes grow {
	from {
		transform: scale(1);
	}
	to {
		transform: scale(1.5);
	}
}

body.normal #list>ul:not([data-normal]),
body.critical #list>ul:not([data-critical]),
body.shutdown #list>ul:not([data-shutdown]),
body.disabled #list>ul:not([data-disabled]),
body.unlabeled #list>ul:not([data-unlabeled]) {
	display: none;
}

		</style>
		
		<script>

function onEdit(ip) {
	top.showDialog.call(window, "device_dialog.html", ip);
}

function onSetAlarm(ip){
	top.showDialog.call(window, "critical_dialog.html", ip);
}

function onMap(ip) {
	window.location.href = "map.html?"+ip;
}

function initList() {
	var df = document.createDocumentFragment(),
		monitorData = top.databases.monitor;
		criticalData = top.databases.critical;
	
	var deviceData = window.top.databases.device;
	
	for (var ip in deviceData) {
		df.appendChild(createRow(deviceData[ip], monitorData[ip], criticalData[ip]));
	}
	
	document.getElementById("count").dataset.value = df.children.length;
	
	list.appendChild(df);
	
	document.body.classList.remove("loading");
}

function createRow(device, monitor, set) {
	var row = document.createElement("ul"),
		location, alarm, edit, status, labels, label;
	
	row.appendChild(document.createElement("li"));
	row.appendChild(document.createElement("li")).textContent = device.name;
	row.appendChild(document.createElement("li")).textContent = device.type;
	row.appendChild(document.createElement("li")).textContent = device.ip;
	
	location = row.appendChild(document.createElement("li"));
	edit = row.appendChild(document.createElement("li"));
	alarm = row.appendChild(document.createElement("li"));
	status = row.appendChild(document.createElement("li"));
	
	location.title = "구성도에서 장비 보기";
	edit.title = "장비의 정보 편집";
	
	location.onclick = onMap.bind(undefined, device.ip);
	edit.onclick = onEdit.bind(undefined, device.ip);
	
	window.deviceMapping[device.ip] = row;
	
	if (device.label) {
		labels = device.label.split(",");
		
		for (var i=0, length=labels.length; i<length; i++) {
			label = labels[i];
			
			row.classList.add(label);
			
			window.labelData[label] = null;
		}
	}
	else {
		row.dataset.unlabeled = true;
	}
	
	if (monitor) {
		if (monitor.protocol === "snmp") {
			row.dataset.snmp = true;
			
			alarm.title = "장비의 성능 임계 설정";
			alarm.onclick = onSetAlarm.bind(undefined, device.ip);
			
			status.title = "장비의 상태 보기";
			status.onclick = top.showChart.bind(undefined, device.ip);
			
			if (set) {
				row.dataset.alarm = true;
			}
		}
			
		if (monitor.shutdown) {
			row.dataset.shutdown = true;
		}
		else if (monitor.critical) {
			row.dataset.critical = true;
		}
		else {
			row.dataset.normal = true;
		}
	}
	else {
		row.dataset.disabled = true;
	}
	
	return row;
}

function initLabel() {
	var option = document.createElement("option");

	// label select 초기화
	window.label.length = 0;
	
	option.value = "";
	option.text = "모두 보기";
	option.selected = true;
	
	window.label.add(option);
	
	for (var label in window.labelData) {
		option = document.createElement("option");
		
		option.text = label;
		
		window.label.add(option);
	}
}

function onSearch(e) {
	e.preventDefault();
	
	search();
}

function onReset(e) {
	e.preventDefault();
	
	this.elements.keyword.value = "";
	
	search();
}

function onChangeLabel(e) {
	form.elements.keyword.value = "";
	
	selectLabel(window.label.value);
}

function search() {
	document.body.classList.add("loading");
	// search 결과를 초기화 하기 위해
	selectLabel(window.label.value);

	filterDeviceList(form.elements.keyword.value);
	
	document.body.classList.remove("loading");
}

function clearDeviceList() {
	var df = document.createDocumentFragment(),
		row;
	
	while (row = list.firstChild) {
		df.appendChild(row);
	}
	
	return df;
}

function filterDeviceList(keyword) {
	var row = clearDeviceList().firstChild,
		next, cols,
		df = document.createDocumentFragment(),
		device;
	
	while (row) {
		next = row.nextSibling;
		
		cols = row.children;
		
		for (var i=0, length=cols.length; i<length; i++) {
			if (cols[i].textContent.indexOf(keyword) !== -1) {
				df.appendChild(row);
				
				break;
			}
		}
		
		row = next;
	}
	
	document.getElementById("count").dataset.value = df.children.length;
	
	list.appendChild(df);
}

function selectLabel(label) {
	var df = document.createDocumentFragment(),
		rows;
	
	for (var ip in window.deviceMapping) {
		df.appendChild(window.deviceMapping[ip]);
	}
	
	if (label) {
		rows = [].slice.call(df.querySelectorAll("."+ label), 0);
		
		df = document.createDocumentFragment();
		
		for (var i=0, length=rows.length; i<length; i++) {
			df.appendChild(rows[i]);
		}
	}
	
	document.getElementById("count").dataset.value = df.children.length;
	
	list.appendChild(df);
}

		</script>
		
	</head>
	
	<body class="loading">
		<article class="content_width">
			<aside>
				<nav>
					<div id="count"></div>
					<div>
						<select id="label"></select>
					</div>
					<div class="selector">
						<span title="모든 장비 보기" class="selected" data-status="">
						</span><span title="정상 장비 보기" data-status="normal">
						</span><span title="임계 장비 보기" data-status="critical">
						</span><span title="장애 장비 보기" data-status="shutdown">
						</span><span title="비활성 장비 보기" data-status="disabled"></span>
					</div>
					<div>
						<label>
							<input type="checkbox" id="unlabeled">라벨 없는 장비만 보기
						</label>
					</div>
				</nav>
				<form id="form">
					<input type="text" name="keyword" placeholder="이름, 유형, IP주소 ">
					<input type="submit" value="찾기">
					<input type="reset" value="초기화">
				</form>
			</aside>
			
			<header>
				<ul>
					<li>
					<li>장비 이름
					<li>장비 유형
					<li>IP 주소
					<li>
					<li>
					<li>
					<li>
				</ul>
			</header>
			
			<div id="list"></div>
		</article>
		
		<div class="bg_loading"></div>
		<script>

var form = document.getElementById("form"),
	label = document.getElementById("label"),
	list = document.getElementById("list"),
	selector = document.querySelector(".selector")
	cache = document.createDocumentFragment(),
	deviceMapping = {},
	labelData = {};

label.addEventListener("change", onChangeLabel);

window.form.addEventListener("submit", onSearch);
window.form.addEventListener("reset", onReset);

window.selector.onclick = function (e) {
	var element = e.target;
	
	if (element.nodeName.toLowerCase() === "span") {
		element.parentNode.querySelector(".selected").classList.remove("selected");
		
		element.classList.add("selected");
		
		document.body.classList.remove("normal", "critical", "shutdown", "disabled", "all");
		
		if (element.dataset.status) {
			document.body.classList.add(element.dataset.status);
		}
	}
};

document.getElementById("unlabeled").onclick = function () {
	document.body.classList[this.checked? "add": "remove"]("unlabeled");
};

initList();

initLabel();

		</script>
	
	</body>
	
</html>