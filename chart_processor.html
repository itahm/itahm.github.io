<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM</title>
		
		<style>

@import "css/itahm.css";
@import "css/chart.css";

		</style>
		
	</head>
	
	<body>
		
		<script src="js/ITAhM.js"></script>	
		<script src="js/object.js"></script>
		<script>

var deviceIP = top.databases.device.selected,
	snmp = top.databases.snmp,
	chartList = {},
	dataList = {},
	colorList = [
		"#6d8764",
		"#f0a30a",
		"#6a00ff",
		"#825a2c",
		"#a20025",
		"#1ba1e2",
		"#008a00",
		"#1ba1e2",
	],
	chartIndex,
	colorLength = colorList.length,
	colorIndex = 0,
	max = 100;

if(!window.deviceIP || !window.snmp) {
	throw "!";
}

/**
 * public
 */
function initialize(from, to, start, end) {
	var entry = window.snmp.hrProcessorEntry,
		df = document.createDocumentFragment(),
		request = {
			command: "query",
			ip: window.deviceIP,
			summary: true,
			database: "hrProcessorLoad",
			start: from,
			end: to
		},
		chart;
	
	for (var index in entry) {
		chart = document.createElement("iframe");
		
		chart.className = "chart";
		
		window.chartList[index] = chart;
		
		df.appendChild(chart);
	}
	
	document.body.appendChild(df);
	
	for (var index in entry) {
		request.index = index;
		
		top.sendRequest(request, onResponse.bind(undefined, index));
	}
	
	window.start = start;
	window.end = end;
}

function onResponse(index, data) {
	var chart = window.chartList[index];
	
	window.dataList[index] = new ITAhM.ChartSummaryData(data);
	
	chart.onload = onLoadChart.bind(undefined, index);
	
	chart.src = "chart_base.html";
}

function onLoadChart(index) {
	var chartWindow = window.chartList[index].contentWindow;
	
	chartWindow.onValueToString = onValueToString;
	
	chartWindow.initialize(window.dataList[index], window.max, window.colorList[window.colorIndex++ % window.colorLength]);
	chartWindow.draw(window.start, window.end);
}

function onValueToString(value) {
	return value.toFixed(2) +"%";
}

/**
 * public
 */
function draw(start, end) {
	if (start === end || (start === window.start && end === window.end)) {
		return;
	}
	
	window.start = start;
	window.end = end;
	
	window.chartWindow.draw(window.start, window.end);
}

/**
 * public
 */
function getFile() {
	for (var index in window.dataList) {
		buildFile(window.dataList[index], window.chartList[index].contentWindow.chartData, "chart_processor_"+ index +".csv");
	}
}

function buildFile(summaryData, chartData, fileName) {
	var blocks = chartData.keys,
		row, block, date, mills, value, k = 0;
	
	row = ["index,date,max,avg,min"];
	
	for (var i=0, _i=blocks.length; i<_i; i++) {
		block = blocks[i];
		
		for (var j=0, _j=block.length; j<_j; j++) {
			mills = block[j];
			value = summaryData.get(mills);
			
			date = new Date(mills);
			
			row[row.length] = [k++, ITAhM.util.toDateTimeString(date), value.max, value.avg, value.min].join(",");
		}
	}
	
	ITAhM.util.download(new Blob([row.join("\n")] ,{
		type: "text/csv;charset=utf-8;"
	}), fileName);
}

		</script>
	
	</body>
	
</html>