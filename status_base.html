<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>@ ITAhM</title>

		<style>
@import "css/itahm.css";

.summary {
	display: flex;
	flex-wrap: wrap;
}

.resource {
	display: flex;
	flex-direction: column;
	padding: 10px;
	border: 1px solid #0084ff;
	border-radius: 5px;
	margin: 10px;
	flex: none;
}

.resource:hover {
	background-color: rgba(0, 132, 255, .1);
	cursor: pointer;
}

.summary >.resource:first-child {
	flex: 1;
}


#response_time {
	font-size: 2em;
}

/* title */
.resource >h2 {
}

/* body */
/*.resource >div {
	flex: 1;
	display: flex;
	justify-content: center;
	align-items: center;
}*/

.processor_item {
	margin: 10px;
}

.memory_item .bar {
	display: flex;
	width: 80px;
	height: 100px;
	justify-content: center;
	align-items: center;
	border: 1px solid #999;
	border-radius: 10px;
	position: relative;
	overflow: hidden;
}

.memory_item .color {
	position: absolute;
	bottom: 0;
	left: 0;
	width: 100%;
	background-color: #b8860b;
	z-index: -1;
}

.memory_item {
	display: flex;
}

.memory_item,
.memory_item ul {
	list-style: none;
	margin: 0; padding: 0;
}

.memory_item ul li {
	margin: .5em;
}

/* storage 영역 css */
#storage,
#storage ul {
	list-style: none;
	padding: 0;
}

#storage ul {
	display: flex;
}

#storage ul> li {
	text-align: center;
	padding: .5em; margin: 3px;
	flex: 1;
}

#storage .title {
	border-bottom: 1px solid #ddd;
	margin-bottom: 3px;
}

#storage .title .usage {
	flex: 2;
}

#storage .title li {
	font-weight: bold;
}

#storage .bar {
	position: relative;
	border: 1px solid #999;
	box-sizing: border-box;
}

#storage .color {
	position: absolute; top: 0; left: 0;
	height: 100%;
	z-index: -1;
	background-color: #9d9789;
}
/**/

#storage,
#i_face {
	width: 100%;
}

#i_face,
#i_face ul {
	list-style: none;
	padding: 0;
}

#i_face ul {
	display: flex;
}

#i_face ul> li {
	text-align: center;
	padding: .5em; margin: 3px;
	flex: 1;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

#i_face .i_face_item li:last-child {
	display: flex;
}

#i_face .i_face_item li:last-child:hover {
	background-color: rgba(0, 132, 255, .2);
}

#i_face .i_face_item li:last-child div{
	flex: 1;
}

#i_face .i_face_item li:first-child {
	background: transparent url("img/ball_green.png") center no-repeat;
}

#i_face .i_face_item li:first-child.shutdown {
	background: transparent url("img/ball_orange.png") center no-repeat; 
}

#i_face .title {
	border-bottom: 1px solid #ddd;
	margin-bottom: 3px;
}

#i_face .title li:nth-child(5),
#i_face .title li:nth-child(6) {
	flex: 2;
}

#i_face .title li {
	font-weight: bold;
}

#i_face .bar {
	position: relative;
	border: 1px solid #999;
	box-sizing: border-box;
}

#i_face .color {
	position: absolute; top: 0; left: 0;
	height: 100%;
	z-index: -1;
}

#i_face .color.input {
	background-color: #7d7;
}

#i_face .color.output {
	background-color: #f60;
}

/**/

.layout {
	display: none;
}

#status {
	color: #0084ff;
}

#status.down {
	color: #f00;
}

.response_time {
	text-align: center;
}

li.storage_item:hover,
li.i_face_item:hover {
	outline: solid 3px #0084ff;
	cursor: pointer;
}

#memory {
	display: inline-block;
	padding: 10px;
}

body:not(.response_time) .resource.response_time,
body:not(.processor) .resource.processor,
body:not(.storage) .resource.storage,
body:not(.memory) .resource.memory,
body:not(.throughput) .resource.throughput {
	display: none;
}

		</style>
	</head>

	<body class="loading">
		
		<header>
			<h3 id="status"></h3>
		</header>
		
		<div class="summary">
			<section class="resource response_ime">
				<h2>응답 속도</h2>
				<div>
					<h2>
						<img src="img/synchronize.png" width="24" height="24">
						<span id="response_time"></span>
					</h2>
				</div>
			</section>
			
			<section class="resource processor">
				<h2>프로세서 로드</h2>
				<div>
					<div id="processor"></div>
				</div>
			</section>
			
			<section class="resource memory">
				<h2>물리적 메모리</h2>
				<div>
					<div id="memory"></div>
				</div>
			</section>
		</div>
		
		<section class="resource storage">
			<h2>스토리지 사용</h2>
			<div>
				<ul id="storage">
					<li class="title">
						<ul>
							<li>이름
							<li>크기
							<li class="usage">사용
						</ul>
				</ul>
			</div>
		</section>
	
		<section class="resource throughput">
			<h2>통신</h2>
			<div>
				<ul id="i_face">
					<li class="title">
						<ul>
							<li>상태
							<li>이름
							<li>설명
							<li>대역폭
							<li>사용량(송신/수신)
							<li>사용률(송신/수신)
							<li>초당에러량(송신/수신)
						</ul>
				</ul>
			</div>
		</section>
		
		<div class="layout">
			<canvas width="100" height="100" class="processor_item"></canvas>
			
			<ul class="memory_item">
				<li class="bar">
					<span class="label"></span>
					<div class="color"></div>
				<li>
					<ul>
						<li>용량
						<li>value
						<li>사용
						<li>value
					</ul>
			</ul>
			
			<ul>
				<li class="storage_item">
					<ul>
						<li>
						<li>
						<li>
						<li class="bar">
							<span class="label"></span>
							<div class="color"></div>
					</ul>
			</ul>
			
			<ul>
				<li class="i_face_item">
					<ul>
						<li>
						<li>
						<li>
						<li>
						<li>
						<li>
						<li class="bar">
							<span class="label"></span>
							<div class="color input"></div>
						<li class="bar">
							<span class="label"></span>
							<div class="color output"></div>
						<li>
							<div></div>
							<div></div>
					</ul>
			</ul>
		</div>
		
		<div class="bg_loading"></div>
	</body>
	
	<script src="js/ITAhM.js"></script>
	<script>

	var processorArea = document.getElementById("processor"),
		storageArea = document.getElementById("storage"),
		memoryArea = document.getElementById("memory"),
		interfaceArea = document.getElementById("i_face"),
		gauge = document.querySelector(".gauge"),
		processorGauge = document.querySelector(".processor_item"),
		memoryGauge = document.querySelector(".memory_item"),
		storageGauge = document.querySelector(".storage_item"),
		iFaceGauge = document.querySelector(".i_face_item");
	
	document.querySelector(".resource.response_ime").onclick = function () {
		onSelectResource("responseTime");
	}
	
	function createProcGauge(value) {
		var clone = processorGauge.cloneNode(true),
			ctx = clone.getContext("2d"),
			origin = Math.PI *1.5,
			x = clone.width /2,
			y = clone.height /2,
			r = Math.min(x, y);

		ctx.beginPath();
		ctx.arc(x, y, r, 0, 2* Math.PI);
		ctx.fillStyle = "#ffe63b";
		ctx.fill();
		
		ctx.beginPath();
		ctx.moveTo(x, y);
		ctx.lineTo(x, 0);
		ctx.arc(x, y, r, origin, origin + 2* Math.PI * value /100);
		ctx.closePath();

		ctx.fillStyle = "#e60000";
		ctx.fill();
		
		ctx.fillStyle = "#000";
		ctx.font = "10pt arial";
		ctx.textAlign = "center";
		ctx.textBaseline = "middle"; 
		ctx.fillText(value +"%", x, y);
		
		return clone;
	}
	
	function createMemoryGuage(used, size) {
		var clone = memoryGauge.cloneNode(true),
			bar = clone.children[0],
			info = clone.children[1].children[0];

		bar.children[0].textContent
		= bar.children[1].style.height
		= Math.round(100* used / size) +"%";
		
		info.children[1].textContent = ITAhM.util.toBytesString(size);
		info.children[3].textContent = ITAhM.util.toBytesString(used);
		
		return clone;
	}
	
	function createStorageGuage(used, size, label) {
		var clone = storageGauge.cloneNode(true),
			ul = clone.children[0];
		
		ul.children[0].textContent = label;
		ul.children[1].textContent = ITAhM.util.toBytesString(size);
		ul.children[2].textContent = ITAhM.util.toBytesString(used);
		
		ul.children[3].children[0].textContent
		= ul.children[3].children[1].style.width
		= (100* used / size).toFixed(2) +"%";
		
		return clone;
	}
		
	function createIFaceGuage(status, index, name, descr, alias, bandwidth, inBPS, outBPS, inErr, outErr) {
		var clone = iFaceGauge.cloneNode(true),
			ul = clone.children[0];
		
		if (status !== 1) {
			ul.classList.add("shutdown");
		}
		
		ul.children[1].textContent = name;
		ul.children[2].textContent = alias;
		ul.children[3].textContent = ITAhM.util.toBPSString(bandwidth);
		ul.children[4].textContent = ITAhM.util.toBPSString(inBPS);
		ul.children[5].textContent = ITAhM.util.toBPSString(outBPS);		
		ul.children[6].children[0].textContent
		= ul.children[6].children[1].style.width
		= (100* inBPS / bandwidth).toFixed(2) +"%";
		ul.children[7].children[0].textContent
		= ul.children[7].children[1].style.width
		= (100* outBPS / bandwidth).toFixed(2) +"%";
		ul.children[8].children[0].textContent = Math.round(inErr /10);
		ul.children[8].children[1].textContent = Math.round(outErr /10);
		
		ul.children[8].onclick = function (index, e) {
			onSelectResource("error", index);
			
			e.stopPropagation();
		}.bind(undefined, index);
		
		ul.title = descr;
		
		clone.onclick = onSelectResource.bind(undefined, "throughput", index);
		
		return clone;
	}
	
	function initialize(device, snmp) {
		var entry;
		
		if (!snmp.lastResponse) {
			return;
		}
			
		document.getElementById("response_time").textContent = snmp.responseTime +"ms.";
		document.body.classList.add("response_time");
		
		entry = snmp.hrProcessorEntry;
		for (var index in entry) {
			initProcessor(entry[index]);
		}
		
		document.querySelector(".resource.processor").onclick = function () {
			onSelectResource("processor");
		};
		
		entry = snmp.hrStorageEntry;
		for (var index in entry) {
			parseStorage(entry[index], index);
		}
		
		entry = snmp.ifEntry;
		for (var index in entry) {
			initIFace(entry[index], index)
		}
		
		if (top.databases.snmp[device.ip].shutdown) {
			var status = document.getElementById("status");
			console.log(snmp);
			status.textContent
				= "Last response "+ new Date(snmp.lastResponse).toLocaleString();
			status.className = "down";
		}
		
		document.body.classList.remove("loading");
	}
	
	function initProcessor(load) {
		processorArea.appendChild(createProcGauge(load));
		
		document.body.classList.add("processor");
	}
	
	function parseStorage(storage, index) {
		switch(storage.hrStorageType) {
		case 4:
			if (storage.hrStorageSize > 0) {
				initStorage(storage, index);
			}
			
			break;
		case 2:
			initMemory(storage);
			document.querySelector(".resource.memory").onclick = function () {
				onSelectResource("memory", index);
			};
			
			return true;
		}
		
		return false;
	}
	
	function initStorage(storage, index) {
		storageArea.appendChild(
			createStorageGuage(storage.hrStorageUsed * storage.hrStorageAllocationUnits
				, storage.hrStorageSize * storage.hrStorageAllocationUnits, storage.hrStorageDescr)
			).onclick = function () {
				onSelectResource("storage", index);
			};
		
		document.body.classList.add("storage");
	}
	
	function initMemory(memory) {
		var used = memory.hrStorageUsed * memory.hrStorageAllocationUnits,
			size = memory.hrStorageSize * memory.hrStorageAllocationUnits;
		
		memoryArea.appendChild(createMemoryGuage(used, size));
		
		document.body.classList.add("memory");
	}
	
	function initIFace(iFace, index) {
		var bandwidth = iFace.ifHighSpeed || iFace.ifSpeed;
		
		if (bandwidth > 0) {
			var inBPS = iFace.ifInBPS || 0,
				outBPS = iFace.ifOutBPS || 0;
			
			interfaceArea
				.appendChild(createIFaceGuage(iFace.ifAdminStatus, index, iFace.ifName, iFace.ifDescr, iFace.ifAlias, bandwidth, inBPS, outBPS, iFace.ifInErrors, iFace.ifOutErrors));
				
		}
		
		document.body.classList.add("throughput");
	}
	
	// abstract
	function onSelectResource(resource, index) {
	}
	
	</script>
</html>