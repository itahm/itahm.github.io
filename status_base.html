<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Status @ ITAhM</title>

		<style>
@import "css/itahm.css";

article {
	page-break-inside: avoid;
}

h2 {
	margin: 0;
	text-align: center;
}
.summary {
	display: flex;
	flex-wrap: wrap;
}

.resource,
.information {
	padding: 5px;
	border: 1px solid #0084ff;
	border-radius: 5px;
	margin: 5px;
}

.resource:hover {
	background-color: rgba(0, 132, 255, .1);
	cursor: pointer;
}

.resource.response_time,
.resource.storage {
	flex: 1;
}

.processor_item {
	margin: 10px;
}

.circular_bar {
	width: 100px;
	height: 100px;
	position: relative;
	display: inline-block;
}

.circular_bar svg {
	width: 100%;
	height: 100%;
}

.circular_bar .bar {
	fill: none;
	stroke-width: 10;
	stroke: rgba(128, 128, 128, .5);
	stroke-cap: round;
}

.circular_bar .progress.bar{
	transition: stroke-dashoffset .5s ease-out;
}

.circular_bar.green .progress.bar {
	stroke: #0f0;
}

.circular_bar.red .progress.bar {
	stroke: #f00;
}

.circular_bar.orange .progress.bar {
	stroke: #fc0;
}

.circular_bar::after {
	content: attr(data-value);
	position: absolute; top: 50px; left: 50px;
	transform: translateX(-50%) translateY(-50%);
	font-size: 15px;
	font-weight: bold;
}

.memory_item .bar {
	display: flex;
	width: 100px;
	height: 100px;
	justify-content: center;
	align-items: center;
	border: 1px solid #999;
	border-radius: 50%;
	position: relative;
	overflow: hidden;
}

.memory_item .label {
	font-size: 15px;
	font-weight: bold;
}

.memory_item .color {
	position: absolute; bottom: 0; left: 0;
	width: 100%; height: 0;
	transition: height .5s ease-out;
	z-index: -1;
}

.memory_item {
	display: flex;
}

ul {
	list-style: none;
	margin: 0; padding: 0;
}

.memory_item ul li {
	margin: .5em;
}

.resource li {
	text-align: center;
	padding: .5em; margin: 3px;
	flex: 1;
}

.title {
	border-bottom: 1px solid #ddd;
	margin-bottom: 3px;
}

.resource.storage.title .usage {
	flex: 2;
}

.title li {
	font-weight: bold;
}

.resource.storage .bar {
	position: relative;
	border: 1px solid #999;
	box-sizing: border-box;
}

.resource.storage .color {
	position: absolute; top: 0; left: 0;
	width: 0; height: 100%;
	z-index: -1;
	transition: width .5s ease-out;
}

.resource.response_time {
	min-width: 250px;
	min-height: 150px;
}

#i_face ul {
	display: flex;
}

#i_face ul> li {
	text-align: center;
	padding: .5em; margin: 3px;
	flex: 1;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

.i_face_item li:last-child {
	display: flex;
}

.i_face_item li:first-child {
	flex: .2;
}

.i_face_item li:last-child:hover {
	background-color: rgba(0, 132, 255, .2);
}

.i_face_item li:last-child div{
	flex: 1;
}

.i_face_item li:first-child::after {
	content: url("img/ball_green.png");
}

.i_face_item.shutdown li:first-child::after {
	content: url("img/ball_orange.png"); 
}

.i_face_item.disabled {
	color: #aaa;
}

.i_face_item.disabled li:first-child::after {
	content: url("img/ball_gray.png"); 
}

#i_face li:nth-child(1) {
	flex: .2;
}

#i_face .title li:nth-child(5),
#i_face .title li:nth-child(6) {
	flex: 2;
}

#i_face .title li {
	font-weight: bold;
}

#i_face .bar {
	position: relative;
	border: 1px solid #999;
	box-sizing: border-box;
}

#i_face .color {
	position: absolute; top: 0; left: 0;
	height: 100%;
	transition: width .5s ease-out;
	z-index: -1;
}

/**/

.layout {
	display: none;
}

.storage_item:hover,
.i_face_item:hover {
	outline: solid 3px #0084ff;
	cursor: pointer;
}

.i_face_item,
.storage_item,
.title {
	display: flex;
}

#memory {
	display: inline-block;
}

.resource.response_time {
	display: flex; flex-direction: column;
}

#response {
	position: relative;
	flex: 1;
}

#response iframe {
	position: absolute; top: 0; right: 0; bottom:0; left: 0;
	width: 100%; height: 100%;
	border: none; 
}

#realtime_response {
	pointer-events: none;
}

ul.table ul {
	display: flex;
}

ul.table ul li {
	padding: 5px;
}

ul.table ul li:first-child {
	width: 80px;
	border-right: 1px solid #ddd;
	text-align: right;
}

#status::before {
	font-weight: bold;
	color: #0f0;
	content: "정상 ";
}

body.shutdown #status::before {
	color: #f00;
	content: "응답 없음 ";
}

body:not(.processor) .resource.processor,
body:not(.storage) .resource.storage,
body:not(.memory) .resource.memory,
body:not(.throughput) .resource.throughput {
	display: none;
}

		</style>
		
		<script>
		
function createProcGauge(value) {
	var circularBar = document.querySelector(".circular_bar").cloneNode(true);
	
	if (parseInt(value) > 90) {
		circularBar.classList.add("red");
	}
	else if (parseInt(value) > 70) {
		circularBar.classList.add("orange");
	}
	else {
		circularBar.classList.add("green");
	}
	
	circularBar.dataset.value = value +"%";
	
	setTimeout(function () {
		circularBar.children[0].children[0].children[1].setAttributeNS(null, "stroke-dashoffset", 2* Math.PI*(1 - value /100)*45);
	}, 500);
	
	return circularBar;
}

function createMemoryGuage(used, size) {
	var clone = memoryGauge.cloneNode(true),
		bar = clone.children[0],
		info = clone.children[1].children[0],
		usage = Math.round(100* used / size) +"%";

	setTimeout(function () {
		bar.children[0].style.height = usage;
	}, 500);
	
	bar.children[1].textContent = usage;
	
	info.children[0].textContent = ITAhM.util.toBytesString(used);
	info.children[1].textContent = "/ "+ ITAhM.util.toBytesString(size);
	
	return clone;
}

function createStorageGuage(used, size, label) {
	var clone = storageGauge.cloneNode(true),
		usage = (100* used / size).toFixed(2) +"%";;
	
	clone.children[0].textContent = label;
	clone.children[1].textContent = ITAhM.util.toBytesString(size);
	clone.children[2].textContent = ITAhM.util.toBytesString(used);
	
	clone.children[3].children[0].textContent = usage;
	
	setTimeout(function () {
		clone.children[3].children[1].style.width = usage;
	}, 500);
	
	return clone;
}
	
function createIFaceGuage(admin, oper, index, name, descr, alias, bandwidth, inBPS, outBPS, inErr, outErr) {
	var clone = iFaceGauge.cloneNode(true),
		usageIn, usageOut;
	
	if (admin != 1) {
		clone.classList.add("disabled");
	}
	else if (oper !== 1) {
		clone.classList.add("shutdown");
	}
	
	usageIn = 100* inBPS / bandwidth;
	usageOut = 100* outBPS / bandwidth;
	
	usageIn = (isNaN(usageIn)? 0: usageIn).toFixed(2) +"%";
	usageOut = (isNaN(usageOut)? 0: usageOut).toFixed(2) +"%";
	
	clone.children[1].textContent = name;
	clone.children[2].textContent = alias;
	clone.children[3].textContent = ITAhM.util.toBPSString(bandwidth);
	clone.children[4].textContent = ITAhM.util.toBPSString(inBPS);
	clone.children[5].textContent = ITAhM.util.toBPSString(outBPS);		
	clone.children[6].children[0].textContent = usageIn; 
	clone.children[7].children[0].textContent = usageOut;
	clone.children[8].children[0].textContent = Math.round(inErr /10);
	clone.children[8].children[1].textContent = Math.round(outErr /10);
	
	setTimeout(function () {
		clone.children[6].children[1].style.width = usageIn;
		clone.children[7].children[1].style.width = usageOut;
	}, 500);
	
	
	clone.children[8].onclick = function (index, e) {
		onSelectResource("error", index);
		
		e.stopPropagation();
	}.bind(undefined, index);
	
	clone.title = descr;
	
	clone.onclick = onSelectResource.bind(undefined, "throughput", index);
	
	return clone;
}

function initHistory(history) {/*
	document.getElementById("response_time").textContent = "N/A";
	document.body.classList.add("response_time");
	
	for (var index in history.hrProcessorLoad) {
		processorArea.appendChild(document.createElement("p")).textContent = index;
		
		document.body.classList.add("processor");
	}
	
	document.querySelector(".resource.processor").onclick = function () {
		onSelectResource("processor");
	};
	
	document.body.classList.remove("loading");
	
	return;
	
	entry = history.hrStorageEntry;
	for (var index in entry) {
		parseStorage(entry[index], index);
	}
	
	entry = history.ifEntry;
	for (var index in entry) {
		initIFace(entry[index], index)
	}
	
	document.body.classList.remove("loading");*/
}

function initialize(ip) {
	var snmp = top.databases.local.node,
		entry;
	
	document.getElementById("reset").onclick = function () {
		top.sendRequest({
			command: "extra",
			extra: "reset",
			ip: ip
		}, function () {
			parent.location.reload();
		});
	};
	
	document.getElementById("sys_name").textContent = snmp.sysName;
	document.getElementById("sys_name").title = snmp.sysDescr;
	document.getElementById("sys_enterprise").textContent = ITAhM.util.enterpriseFromOID(snmp.sysObjectID);
	document.getElementById("ip").textContent = ip;
	document.getElementById("failure").textContent = 100 - snmp.failure;
	document.getElementById("last_response").textContent = (function (date) {
		var text = date.getFullYear() +"-",
			month = date.getMonth() +1,
			d = date.getDate(),
			h = date.getHours(),
			m = date.getMinutes()
			s = date.getSeconds();
		
		if (month < 10) {
			text += "0";
		}
		
		text += (month +"-");
		
		if (d < 10) {
			text += "0";
		}
		
		text += (d +" ");
		
		if (h < 10) {
			text += "0";
		}
		
		text += (h +":");
		
		if (m < 10) {
			text += "0";
		}
		
		text += (m +":");
		
		if (s < 10) {
			text += "0";
		}
		
		return text + s;
	})(new Date(snmp.lastResponse));
	
	if (top.databases.monitor[ip].shutdown) {
		document.body.classList.add("shutdown");
	}
	else {
		document.getElementById("realtime_response").src="realtime_response.html"
	}
	
	entry = snmp.hrProcessorEntry;
	for (var index in entry) {
		initProcessor(entry[index]);
	}
	
	document.querySelector(".resource.processor").onclick = function () {
		onSelectResource("processor");
	};
	
	entry = snmp.hrStorageEntry;
	for (var index in entry) {
		parseStorage(entry[index], index);
	}
	
	entry = snmp.ifEntry;
	for (var index in entry) {
		initIFace(entry[index], index);
	}
	
	document.body.classList.remove("loading");
}

function initProcessor(load) {
	processorArea.appendChild(createProcGauge(load));
	
	document.body.classList.add("processor");
}

function parseStorage(storage, index) {
	switch(storage.hrStorageType) {
	case 4:
		if (storage.hrStorageSize > 0) {
			initStorage(storage, index);
		}
		
		break;
	case 2:
		initMemory(storage);
		document.querySelector(".resource.memory").onclick = function () {
			onSelectResource("memory", index);
		};
		
		return true;
	}
	
	return false;
}

function initStorage(storage, index) {
	storageArea.appendChild(
		createStorageGuage(storage.hrStorageUsed * storage.hrStorageAllocationUnits
			, storage.hrStorageSize * storage.hrStorageAllocationUnits, storage.hrStorageDescr)
		).onclick = function () {
			onSelectResource("storage", index);
		};
	
	document.body.classList.add("storage");
}

function initMemory(memory) {
	var used = memory.hrStorageUsed * memory.hrStorageAllocationUnits,
		size = memory.hrStorageSize * memory.hrStorageAllocationUnits;
	
	memoryArea.appendChild(createMemoryGuage(used, size));
	
	document.body.classList.add("memory");
}

function initIFace(iFace, index) {
	/*
	if (iFace.ifType == 24) {// loopback
		return;
	}
	else if (iFace.ifType == 1) {// other
		return;
	}*/
	
	interfaceArea
		.appendChild(createIFaceGuage(
				iFace.ifAdminStatus,
				iFace.ifOperStatus,
				index,
				iFace.ifName,
				iFace.ifDescr,
				iFace.ifAlias,
				iFace.ifHighSpeed || iFace.ifSpeed,
				iFace.ifInBPS || 0,
				iFace.ifOutBPS || 0,
				iFace.ifInErrors,
				iFace.ifOutErrors));
	
	document.body.classList.add("throughput");
}

// abstract
function onSelectResource(resource, index) {
}
		
		</script>
	</head>

	<body class="loading">
		
		<article class="summary">
			<section class="information">
				<ul class="table">
					<li>
						<ul>
							<li>장비명
							<li id="sys_name">
						</ul>
					<li>
						<ul>
							<li>공급자
							<li id="sys_enterprise">
						</ul>
					<li>
						<ul>
							<li>IP 주소
							<li id="ip">
						</ul>
					<li>
						<ul>
							<li>마지막 응답
							<li id="last_response">
						</ul>
					<li>
						<ul>
							<li>상태
							<li id="status">(<span id="failure"></span>%) <input type="button" id="reset" value="초기화">
						</ul>
				</ul>
			</section>
			
			<section class="resource processor">
				<h2>프로세서 로드</h2>
				<div>
					<div id="processor"></div>
				</div>
			</section>
			
			<section class="resource response_time">
				<h2>응답 속도</h2>
				<div id="response">
					<iframe id="realtime_response"></iframe>
				</div>
			</section>
			
		</article>
		
		<article class="summary">
			<section class="resource storage">
				<h2>스토리지 사용</h2>
				<div>
					<ul class="storage title">
						<li>이름
						<li>크기
						<li class="usage">사용
					</ul>
					<div id="storage">
					</div>
				</div>
			</section>
			<section class="resource memory">
				<h2>물리적 메모리</h2>
				<div>
					<div id="memory"></div>
				</div>
			</section>
		</article>
		<article class="resource throughput">
			<h2>통신</h2>
			<div>
				<ul class="throughput title">
					<li>상태
					<li>이름
					<li>설명
					<li>대역폭
					<li>사용량(송신/수신)
					<li>사용률(송신/수신)
					<li>초당에러량(송신/수신)
				</ul>
				<div id="i_face">
				</div>
			</div>
		</article>
		
		<div class="layout">
			<canvas width="100" height="100" class="processor_item"></canvas>
			
			<div class="circular_bar" data-value="0%">
				<svg>
					<g transform = "translate(50, 50) rotate(-90)">
						<circle class="bar" cx="0" cy="0" r="45" />
						<circle class="progress bar" cx="0" cy="0" r="45" stroke-dasharray="282.74333882308139146163790449516" stroke-dashoffset="282.74333882308139146163790449516" />
					</g>
				</svg>
			</div>
			
			<ul class="memory_item">
				<li class="bar">
					<img src="img/line_y.png" width="100px" class="color">
					<span class="label"></span>
				<li>
					<ul>
						<li>용량
						<li>사용
					</ul>
			</ul>
			
			<ul class="storage_item">
				<li>
				<li>
				<li>
				<li class="bar">
					<span class="label"></span>
					<img src="img/dot_gray.png" class="color">
			</ul>		
	
			<ul class="i_face_item">
				<li>
				<li>
				<li>
				<li>
				<li>
				<li>
				<li class="bar">
					<span class="label"></span>
					<img src="img/dot_green.png" width="0" height="0" class="color">
				<li class="bar">
					<span class="label"></span>
					<img src="img/dot_orange.png" width="0" height="0" class="color">
				<li>
					<div></div>
					<div></div>
			</ul>
		</div>
		
		<div class="bg_loading"></div>
	</body>
	
	<script src="js/ITAhM.js"></script>
	<script src="js/snmp.js"></script>
	<script>

	var processorArea = document.getElementById("processor"),
		storageArea = document.getElementById("storage"),
		memoryArea = document.getElementById("memory"),
		interfaceArea = document.getElementById("i_face"),
		gauge = document.querySelector(".gauge"),
		processorGauge = document.querySelector(".processor_item"),
		memoryGauge = document.querySelector(".memory_item"),
		storageGauge = document.querySelector(".storage_item"),
		iFaceGauge = document.querySelector(".i_face_item");
	
	document.querySelector(".resource.response_time").onclick = function () {
		onSelectResource("responseTime");
	};
	
	document.getElementById("realtime_response").onload = function () {
		this.contentWindow.initialize(top.databases.local.selected);
	};
	
	</script>
</html>