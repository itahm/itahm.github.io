<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>@ ITAhM</title>

		<style>
@import "css/itahm.css";

.resource {
	display: flex;
	flex-wrap: wrap;
}

section {
	padding: 10px;
	border: 1px solid #0084ff;
	border-radius: 5px;
}

body> section {
	margin-top: 10px;
}

.merge {
	display: flex;
	margin-top: 10px;
}

.merge section:last-child {
	/*margin-left: 10px;*/
	flex: 1;
}

.processor {
	margin: 10px;
}

.memory .bar {
	display: flex;
	width: 80px;
	height: 100px;
	justify-content: center;
	align-items: center;
	border: 1px solid #999;
	border-radius: 10px;
	position: relative;
	overflow: hidden;
}

.memory .color {
	position: absolute;
	bottom: 0;
	left: 0;
	width: 100%;
	background-color: #b8860b;
	z-index: -1;
}

.memory {
	display: flex;
}

.memory,
.memory ul {
	list-style: none;
	margin: 0; padding: 0;
}

.memory ul li {
	margin: .5em;
}

/* storage 영역 css */
#storage,
#storage ul {
	list-style: none;
	padding: 0;
}

#storage ul {
	display: flex;
}

#storage ul> li {
	text-align: center;
	padding: .5em; margin: 3px;
	flex: 1;
}

#storage .title {
	border-bottom: 1px solid #ddd;
	margin-bottom: 3px;
}

#storage .title .usage {
	flex: 2;
}

#storage .title li {
	font-weight: bold;
}

#storage .bar {
	position: relative;
	border: 1px solid #999;
	box-sizing: border-box;
}

#storage .color {
	position: absolute; top: 0; left: 0;
	height: 100%;
	z-index: -1;
	background-color: #9d9789;
}
/**/

/* interface 영역 css */
#iFace {
	width: 100%;
}

#iFace,
#iFace ul {
	list-style: none;
	padding: 0;
}

#iFace ul {
	display: flex;
}

#iFace ul> li {
	text-align: center;
	padding: .5em; margin: 3px;
	flex: 1;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

#iFace .i_face li:last-child {
	display: flex;
}

#iFace .i_face li:last-child:hover {
	background-color: rgba(0, 132, 255, .2);
}

#iFace .i_face li:last-child div{
	flex: 1;
}

#iFace .title {
	border-bottom: 1px solid #ddd;
	margin-bottom: 3px;
}

#iFace .title li:nth-child(4),
#iFace .title li:nth-child(5) {
	flex: 2;
}

#iFace .title li {
	font-weight: bold;
}

#iFace .bar {
	position: relative;
	border: 1px solid #999;
	box-sizing: border-box;
}

#iFace .color {
	position: absolute; top: 0; left: 0;
	height: 100%;
	z-index: -1;
}

#iFace .color.input {
	background-color: #7d7;
}

#iFace .color.output {
	background-color: #f60;
}

/**/

.layout {
	display: none;
}

#status {
	color: #0084ff;
}

#status.down {
	color: #f00;
}

#processor:hover,
#memory:hover,
#responseTime:hover,
li.storage:hover,
li.i_face:hover {
	outline: solid 3px #0084ff;
	cursor: pointer;
}

#memory {
	display: inline-block;
	padding: 10px;
}

		</style>
	</head>

	<body class="loading">
		
		<header>
			<h3 id="status"></h3>
		</header>
		
		<div class="merge">
			<section>
				<h2>응답 속도</h2>
				<div class="resource" id="responseTime">
					<h3>
						<img src="img/synchronize.png" width="16" height="16">
						<span id="response_time"></span>
					</h3>
				</div>
			</section>
			<section>
				<h2>프로세서 로드</h2>
				<div class="resource" id="processor"></div>
			</section>
			<section>
				<h2>물리적 메모리</h2>
				<div class="resource" id="memory"></div>
			</section>
		</div>
		
		<section>
			<h2>스토리지 사용</h2>
			<ul id="storage">
				<li class="title">
					<ul>
						<li>이름
						<li>크기
						<li class="usage">사용
					</ul>
			</ul>
		</section>
	
		<section>
			<h2>통신</h2>
			<ul id="iFace">
				<li class="title">
					<ul>
						<li>이름
						<li>설명
						<li>대역폭
						<li>사용량(송신/수신)
						<li>사용률(송신/수신)
						<li>초당에러량(송신/수신)
					</ul>
			</ul>
		</section>
		
		<div class="layout">
			<canvas width="100" height="100" class="processor"></canvas>
			
			<ul class="memory">
				<li class="bar">
					<span class="label"></span>
					<div class="color"></div>
				<li>
					<ul>
						<li>용량
						<li>value
						<li>사용
						<li>value
					</ul>
			</ul>
			
			<ul>
				<li class="storage">
					<ul>
						<li>
						<li>
						<li>
						<li class="bar">
							<span class="label"></span>
							<div class="color"></div>
					</ul>
			</ul>
			
			<ul>
				<li class="i_face">
					<ul>
						<li>
						<li>
						<li>
						<li>
						<li>
						<li class="bar">
							<span class="label"></span>
							<div class="color input"></div>
						<li class="bar">
							<span class="label"></span>
							<div class="color output"></div>
						<li>
							<div></div>
							<div></div>
					</ul>
			</ul>
		</div>
		
		<div class="bg_loading"></div>
	</body>
	
	<script src="js/ITAhM.js"></script>
	<script>

	var processorArea = document.getElementById("processor"),
		storageArea = document.getElementById("storage"),
		memoryArea = document.getElementById("memory"),
		interfaceArea = document.getElementById("iFace"),
		gauge = document.querySelector(".gauge"),
		processorGauge = document.querySelector(".processor"),
		memoryGauge = document.querySelector(".memory"),
		storageGauge = document.querySelector(".storage"),
		iFaceGauge = document.querySelector(".i_face");
	
	document.getElementById("responseTime").onclick = function () {
		onSelectResource("responseTime");
	}
	
	function createProcGauge(value) {
		var clone = processorGauge.cloneNode(true),
			ctx = clone.getContext("2d"),
			origin = Math.PI *1.5,
			x = clone.width /2,
			y = clone.height /2,
			r = Math.min(x, y);

		ctx.beginPath();
		ctx.arc(x, y, r, 0, 2* Math.PI);
		ctx.fillStyle = "#ffe63b";
		ctx.fill();
		
		ctx.beginPath();
		ctx.moveTo(x, y);
		ctx.lineTo(x, 0);
		ctx.arc(x, y, r, origin, origin + 2* Math.PI * value /100);
		ctx.closePath();

		ctx.fillStyle = "#e60000";
		ctx.fill();
		
		ctx.fillStyle = "#000";
		ctx.font = "10pt arial";
		ctx.textAlign = "center";
		ctx.textBaseline = "middle"; 
		ctx.fillText(value +"%", x, y);
		
		return clone;
	}
	
	function createMemoryGuage(used, size) {
		var clone = memoryGauge.cloneNode(true),
			bar = clone.children[0],
			info = clone.children[1].children[0];

		bar.children[0].textContent
		= bar.children[1].style.height
		= Math.round(100* used / size) +"%";
		
		info.children[1].textContent = ITAhM.util.toBytesString(size);
		info.children[3].textContent = ITAhM.util.toBytesString(used);
		
		return clone;
	}
	
	function createStorageGuage(used, size, label) {
		var clone = storageGauge.cloneNode(true),
			ul = clone.children[0];
		
		ul.children[0].textContent = label;
		ul.children[1].textContent = ITAhM.util.toBytesString(size);
		ul.children[2].textContent = ITAhM.util.toBytesString(used);
		
		ul.children[3].children[0].textContent
		= ul.children[3].children[1].style.width
		= (100* used / size).toFixed(2) +"%";
		
		return clone;
	}
	
	function createIFaceGuage(index, name, descr, alias, bandwidth, inBPS, outBPS, inErr, outErr) {
		var clone = iFaceGauge.cloneNode(true),
			ul = clone.children[0];
		
		ul.children[0].textContent = name;
		ul.children[1].textContent = alias;
		ul.children[2].textContent = ITAhM.util.toBPSString(bandwidth);
		ul.children[3].textContent = ITAhM.util.toBPSString(inBPS);
		ul.children[4].textContent = ITAhM.util.toBPSString(outBPS);		
		ul.children[5].children[0].textContent
		= ul.children[5].children[1].style.width
		= (100* inBPS / bandwidth).toFixed(2) +"%";
		ul.children[6].children[0].textContent
		= ul.children[6].children[1].style.width
		= (100* outBPS / bandwidth).toFixed(2) +"%";
		ul.children[7].children[0].textContent = Math.round(inErr /10);
		ul.children[7].children[1].textContent = Math.round(outErr /10);
		
		ul.children[7].onclick = function (index, e) {
			onSelectResource("error", index);
			
			e.stopPropagation();
		}.bind(undefined, index);
		
		ul.title = descr;
		
		clone.onclick = onSelectResource.bind(undefined, "throughput", index);
		
		return clone;
	}
	
	function initialize(device, snmp) {
		var entry;
		
		entry = snmp.hrProcessorEntry;
		for (var index in entry) {
			initProcessor(entry[index]);
		}
		
		window.processorArea.onclick = function () {
			onSelectResource("processor");
		};
		
		entry = snmp.hrStorageEntry;
		for (var index in entry) {
			parseStorage(entry[index], index);
		}
		
		entry = snmp.ifEntry;
		for (var index in entry) {
			initIFace(entry[index], index)
		}
		
		if (device.shutdown) {
			var status = document.getElementById("status");
			
			status.textContent
				= "Last response "+ new Date(snmp.lastResponse).toLocaleString();
			status.className = "down";
		}
		
		document.getElementById("response_time").textContent = snmp.responseTime +"ms.";
		
		document.body.classList.remove("loading");
	}
	
	function initProcessor(load) {
		processorArea.appendChild(createProcGauge(load));
	}
	
	function parseStorage(storage, index) {
		switch(storage.hrStorageType) {
		case 4:
			if (storage.hrStorageSize > 0) {
				initStorage(storage).onclick = function () {
					onSelectResource("storage", index);
				};
			}
			
			break;
		case 2:
			initMemory(storage);
			window.memoryArea.onclick = function () {
				onSelectResource("memory", index);
			};
			
			return true;
		}
		
		return false;
	}
	
	function initStorage(storage) {
		return storageArea.appendChild(
			createStorageGuage(storage.hrStorageUsed * storage.hrStorageAllocationUnits
				, storage.hrStorageSize * storage.hrStorageAllocationUnits, storage.hrStorageDescr));
	}
	
	function initMemory(memory) {
		var used = memory.hrStorageUsed * memory.hrStorageAllocationUnits,
			size = memory.hrStorageSize * memory.hrStorageAllocationUnits;
		
		memoryArea.appendChild(createMemoryGuage(used, size));
	}
	
	function initIFace(iFace, index) {
		var bandwidth = iFace.ifHighSpeed || iFace.ifSpeed;
		
		if (bandwidth > 0) {
			var inBPS = iFace.ifInBPS || 0,
				outBPS = iFace.ifOutBPS || 0;
			
			interfaceArea
				.appendChild(createIFaceGuage(index, iFace.ifName, iFace.ifDescr, iFace.ifAlias, bandwidth, inBPS, outBPS, iFace.ifInErrors, iFace.ifOutErrors));
				
		}
	}
	
	// abstract
	function onSelectResource(resource, index) {
	}
	
	</script>
</html>