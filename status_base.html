<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>@ ITAhM</title>

		<style>
@import "css/itahm.css";

.summary {
	display: flex;
	flex-wrap: wrap;
}

.resource {
	/*display: flex;
	flex-direction: column;*/
	padding: 5px;
	border: 1px solid #0084ff;
	border-radius: 5px;
	margin: 5px;
	flex: none;
}

.resource:hover {
	background-color: rgba(0, 132, 255, .1);
	cursor: pointer;
}

.summary >.resource:first-child {
	flex: 1;
}

/* title */
.resource >h2 {
	margin: 5px;
	text-align: center;
}

/* body */
.resource >div {
	/*flex: 1;*/
}

.processor_item {
	margin: 10px;
}

.circular_bar {
	width: 100px;
	height: 100px;
	position: relative;
	display: inline-block;
}

.circular_bar svg {
	width: 100%;
	height: 100%;
}

.circular_bar .bar {
	fill: none;
	stroke-width: 10;
	stroke: rgba(128, 128, 128, .5);
	stroke-cap: round;
}

.circular_bar .progress.bar{
	transition: stroke-dashoffset .5s ease-out;
}

.circular_bar.green .progress.bar {
	stroke: #0f0;
}

.circular_bar.red .progress.bar {
	stroke: #f00;
}

.circular_bar.orange .progress.bar {
	stroke: #fc0;
}

.circular_bar::after {
	content: attr(data-value);
	position: absolute; top: 50px; left: 50px;
	transform: translateX(-50%) translateY(-50%);
	font-size: 15px;
	font-weight: bold;
}

.memory_item .bar {
	display: flex;
	width: 100px;
	height: 100px;
	justify-content: center;
	align-items: center;
	border: 1px solid #999;
	border-radius: 50px;
	position: relative;
	overflow: hidden;
}

.memory_item .label {
	font-size: 15px;
	font-weight: bold;
}

.memory_item .color {
	position: absolute;
	bottom: 0;
	left: 0;
	width: 100%; height: 0;
	background-color: #b8860b;
	z-index: -1;
	transition: height .5s ease-out;
}

.memory_item {
	display: flex;
}

ul {
	list-style: none;
	margin: 0; padding: 0;
}

.memory_item ul li {
	margin: .5em;
}

/* storage 영역 css */
#storage,
#storage ul {
	list-style: none;
	padding: 0;
}

#storage ul {
	display: flex;
}

#storage ul> li {
	text-align: center;
	padding: .5em; margin: 3px;
	flex: 1;
}

#storage .title {
	border-bottom: 1px solid #ddd;
	margin-bottom: 3px;
}

#storage .title .usage {
	flex: 2;
}

#storage .title li {
	font-weight: bold;
}

#storage .bar {
	position: relative;
	border: 1px solid #999;
	box-sizing: border-box;
}

#storage .color {
	position: absolute; top: 0; left: 0;
	width: 0; height: 100%;
	z-index: -1;
	background-color: #9d9789;
	transition: width .5s ease-out;
}
/**/

#storage,
#i_face {
	width: 100%;
}

#i_face,
#i_face ul {
	list-style: none;
	padding: 0;
}

#i_face ul {
	display: flex;
}

#i_face ul> li {
	text-align: center;
	padding: .5em; margin: 3px;
	flex: 1;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

#i_face .i_face_item li:last-child {
	display: flex;
}

#i_face .i_face_item li:first-child {
	flex: .2;
}

#i_face .i_face_item li:last-child:hover {
	background-color: rgba(0, 132, 255, .2);
}

#i_face .i_face_item li:last-child div{
	flex: 1;
}

#i_face .i_face_item li:first-child {
	background: transparent url("img/ball_green.png") center no-repeat;
}

#i_face .i_face_item li:first-child.shutdown {
	background: transparent url("img/ball_orange.png") center no-repeat; 
}

#i_face .title {
	border-bottom: 1px solid #ddd;
	margin-bottom: 3px;
}

#i_face .title li:nth-child(1) {
	flex: .2;
}
#i_face .title li:nth-child(5),
#i_face .title li:nth-child(6) {
	flex: 2;
}

#i_face .title li {
	font-weight: bold;
}

#i_face .bar {
	position: relative;
	border: 1px solid #999;
	box-sizing: border-box;
}

#i_face .color {
	position: absolute; top: 0; left: 0;
	height: 100%;
	z-index: -1;
}

#i_face .color.input {
	background-color: #7d7;
}

#i_face .color.output {
	background-color: #f60;
}

/**/

.layout {
	display: none;
}

#status {
	color: #0084ff;
}

#status.down {
	color: #f00;
}

li.storage_item:hover,
li.i_face_item:hover {
	outline: solid 3px #0084ff;
	cursor: pointer;
}

#memory {
	display: inline-block;
}

section.resource.response_ime {
	display: flex; flex-direction: column;
}

#response {
	position: relative;
	flex: 1;
}

#response iframe {
	position: absolute; top: 0; right: 0; bottom:0; left: 0;
	width: 100%; height: 100%;
	border: none; 
}

#realtime_response {
	pointer-events: none;
}

body:not(.processor) .resource.processor,
body:not(.storage) .resource.storage,
body:not(.memory) .resource.memory,
body:not(.throughput) .resource.throughput {
	display: none;
}

		</style>
	</head>

	<body class="loading">
		
		<header>
			<h3 id="status"></h3>
		</header>
		
		<div class="summary">
			<section class="resource response_ime">
				<h2>응답 속도</h2>
				<div id="response">
					<iframe id="realtime_response" src="realtime_response.html"></iframe>
				</div>
			</section>
			
			<section class="resource processor">
				<h2>프로세서 로드</h2>
				<div>
					<div id="processor"></div>
				</div>
			</section>
			
			<section class="resource memory">
				<h2>물리적 메모리</h2>
				<div>
					<div id="memory"></div>
				</div>
			</section>
		</div>
		
		<section class="resource storage">
			<h2>스토리지 사용</h2>
			<div>
				<ul id="storage">
					<li class="title">
						<ul>
							<li>이름
							<li>크기
							<li class="usage">사용
						</ul>
				</ul>
			</div>
		</section>
	
		<section class="resource throughput">
			<h2>통신</h2>
			<div>
				<ul id="i_face">
					<li class="title">
						<ul>
							<li>상태
							<li>이름
							<li>설명
							<li>대역폭
							<li>사용량(송신/수신)
							<li>사용률(송신/수신)
							<li>초당에러량(송신/수신)
						</ul>
				</ul>
			</div>
		</section>
		
		<div class="layout">
			<canvas width="100" height="100" class="processor_item"></canvas>
			
			<div class="circular_bar" data-value="0%">
				<svg>
					<g transform = "translate(50, 50) rotate(-90)">
						<circle class="bar" cx="0" cy="0" r="45" />
						<circle class="progress bar" cx="0" cy="0" r="45" stroke-dasharray="282.74333882308139146163790449516" stroke-dashoffset="282.74333882308139146163790449516" />
					</g>
				</svg>
			</div>
			
			<ul class="memory_item">
				<li class="bar">
					<span class="label"></span>
					<div class="color"></div>
				<li>
					<ul>
						<li>용량
						<li>사용
					</ul>
			</ul>
			
			<ul>
				<li class="storage_item">
					<ul>
						<li>
						<li>
						<li>
						<li class="bar">
							<span class="label"></span>
							<div class="color"></div>
					</ul>
			</ul>
			
			<ul>
				<li class="i_face_item">
					<ul>
						<li>
						<li>
						<li>
						<li>
						<li>
						<li>
						<li class="bar">
							<span class="label"></span>
							<div class="color input"></div>
						<li class="bar">
							<span class="label"></span>
							<div class="color output"></div>
						<li>
							<div></div>
							<div></div>
					</ul>
			</ul>
		</div>
		
		<div class="bg_loading"></div>
	</body>
	
	<script src="js/ITAhM.js"></script>
	<script>

	var processorArea = document.getElementById("processor"),
		storageArea = document.getElementById("storage"),
		memoryArea = document.getElementById("memory"),
		interfaceArea = document.getElementById("i_face"),
		gauge = document.querySelector(".gauge"),
		processorGauge = document.querySelector(".processor_item"),
		memoryGauge = document.querySelector(".memory_item"),
		storageGauge = document.querySelector(".storage_item"),
		iFaceGauge = document.querySelector(".i_face_item");
	
	document.querySelector(".resource.response_ime").onclick = function () {
		onSelectResource("responseTime");
	};
	
	document.getElementById("realtime_response").onload = function () {
		this.contentWindow.initialize(top.databases.local.selected);
	};
	
	function createProcGauge(value) {
		var circularBar = document.querySelector(".circular_bar").cloneNode(true);
		
		if (parseInt(value) > 90) {
			circularBar.classList.add("red");
		}
		else if (parseInt(value) > 70) {
			circularBar.classList.add("orange");
		}
		else {
			circularBar.classList.add("green");
		}
		
		circularBar.dataset.value = value +"%";
		
		setTimeout(function () {
			circularBar.children[0].children[0].children[1].setAttributeNS(null, "stroke-dashoffset", 2* Math.PI*(1 - value /100)*45);
		}, 500);
		
		return circularBar;
	}
	
	function createMemoryGuage(used, size) {
		var clone = memoryGauge.cloneNode(true),
			bar = clone.children[0],
			info = clone.children[1].children[0],
			usage = Math.round(100* used / size) +"%";

		setTimeout(function () {
			bar.children[1].style.height = usage;
		}, 500);
		
		bar.children[0].textContent = usage;
		
		info.children[0].textContent = ITAhM.util.toBytesString(used);
		info.children[1].textContent = "/ "+ ITAhM.util.toBytesString(size);
		
		return clone;
	}
	
	function createStorageGuage(used, size, label) {
		var clone = storageGauge.cloneNode(true),
			ul = clone.children[0],
			usage = (100* used / size).toFixed(2) +"%";;
		
		ul.children[0].textContent = label;
		ul.children[1].textContent = ITAhM.util.toBytesString(size);
		ul.children[2].textContent = ITAhM.util.toBytesString(used);
		
		ul.children[3].children[0].textContent = usage;
		
		setTimeout(function () {
			ul.children[3].children[1].style.width = usage;
		}, 500);
		
		return clone;
	}
		
	function createIFaceGuage(status, index, name, descr, alias, bandwidth, inBPS, outBPS, inErr, outErr) {
		var clone = iFaceGauge.cloneNode(true),
			ul = clone.children[0],
			usageIn, usageOut;
		
		if (status !== 1) {
			ul.classList.add("shutdown");
		}
		
		usageIn = (100* inBPS / bandwidth).toFixed(2) +"%";
		usageOut = (100* outBPS / bandwidth).toFixed(2) +"%";
		
		ul.children[1].textContent = name;
		ul.children[2].textContent = alias;
		ul.children[3].textContent = ITAhM.util.toBPSString(bandwidth);
		ul.children[4].textContent = ITAhM.util.toBPSString(inBPS);
		ul.children[5].textContent = ITAhM.util.toBPSString(outBPS);		
		ul.children[6].children[0].textContent = usageIn; 
		ul.children[7].children[0].textContent = usageOut;
		ul.children[8].children[0].textContent = Math.round(inErr /10);
		ul.children[8].children[1].textContent = Math.round(outErr /10);
		
		setTimeout(function () {
			ul.children[6].children[1].style.width = usageIn;
			ul.children[7].children[1].style.width = usageOut;
		}, 500);
		
		
		ul.children[8].onclick = function (index, e) {
			onSelectResource("error", index);
			
			e.stopPropagation();
		}.bind(undefined, index);
		
		ul.title = descr;
		
		clone.onclick = onSelectResource.bind(undefined, "throughput", index);
		
		return clone;
	}
	
	function initHistory(history) {/*
		document.getElementById("response_time").textContent = "N/A";
		document.body.classList.add("response_time");
		
		for (var index in history.hrProcessorLoad) {
			processorArea.appendChild(document.createElement("p")).textContent = index;
			
			document.body.classList.add("processor");
		}
		
		document.querySelector(".resource.processor").onclick = function () {
			onSelectResource("processor");
		};
		
		document.body.classList.remove("loading");
		
		return;
		
		entry = history.hrStorageEntry;
		for (var index in entry) {
			parseStorage(entry[index], index);
		}
		
		entry = history.ifEntry;
		for (var index in entry) {
			initIFace(entry[index], index)
		}
		
		document.body.classList.remove("loading");*/
	}
	
	function initialize(device, snmp) {
		var entry;
		
		if (!snmp.lastResponse) {
			alert("에이전트가 실행된 이후 응답이 없는 장비입니다.\n"
				+"성능정보를 불러올 수 없습니다.");
			return;
	/*		
			top.sendRequest({
				command: "history",
				ip: device.ip
			}, function (history) {
				initHistory(history);
			});
			
			return;*/
		}
		
		entry = snmp.hrProcessorEntry;
		for (var index in entry) {
			initProcessor(entry[index]);
		}
		
		document.querySelector(".resource.processor").onclick = function () {
			onSelectResource("processor");
		};
		
		entry = snmp.hrStorageEntry;
		for (var index in entry) {
			parseStorage(entry[index], index);
		}
		
		entry = snmp.ifEntry;
		for (var index in entry) {
			initIFace(entry[index], index)
		}
		
		if (top.databases.monitor[device.ip].shutdown) {
			var status = document.getElementById("status");
			
			status.textContent
				= "Last response "+ new Date(snmp.lastResponse).toLocaleString();
			
			status.className = "down";
		}
		
		document.body.classList.remove("loading");
	}
	
	function initProcessor(load) {
		processorArea.appendChild(createProcGauge(load));
		
		document.body.classList.add("processor");
	}
	
	function parseStorage(storage, index) {
		switch(storage.hrStorageType) {
		case 4:
			if (storage.hrStorageSize > 0) {
				initStorage(storage, index);
			}
			
			break;
		case 2:
			initMemory(storage);
			document.querySelector(".resource.memory").onclick = function () {
				onSelectResource("memory", index);
			};
			
			return true;
		}
		
		return false;
	}
	
	function initStorage(storage, index) {
		storageArea.appendChild(
			createStorageGuage(storage.hrStorageUsed * storage.hrStorageAllocationUnits
				, storage.hrStorageSize * storage.hrStorageAllocationUnits, storage.hrStorageDescr)
			).onclick = function () {
				onSelectResource("storage", index);
			};
		
		document.body.classList.add("storage");
	}
	
	function initMemory(memory) {
		var used = memory.hrStorageUsed * memory.hrStorageAllocationUnits,
			size = memory.hrStorageSize * memory.hrStorageAllocationUnits;
		
		memoryArea.appendChild(createMemoryGuage(used, size));
		
		document.body.classList.add("memory");
	}
	
	function initIFace(iFace, index) {
		var bandwidth = iFace.ifHighSpeed || iFace.ifSpeed;
		
		if (bandwidth > 0) {
			var inBPS = iFace.ifInBPS || 0,
				outBPS = iFace.ifOutBPS || 0;
			
			interfaceArea
				.appendChild(createIFaceGuage(iFace.ifAdminStatus, index, iFace.ifName, iFace.ifDescr, iFace.ifAlias, bandwidth, inBPS, outBPS, iFace.ifInErrors, iFace.ifOutErrors));
				
		}
		
		document.body.classList.add("throughput");
	}
	
	// abstract
	function onSelectResource(resource, index) {
	}
	
	</script>
</html>