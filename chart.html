<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM</title>
		
		<style>

@import url("css/itahm.css");

body {
	position: fixed; top: 10px; right: 10px; bottom: 10px; left: 10px;
	margin: 0; padding: 0;
	display: flex;
	flex-direction: column;
}

header {
	position: absolute; top: 0; right: 0; 
}

#chart {
	border: none;
	width: 100%; height: 100%;
	flex: 1;
}

nav {
	float: right;
}

nav img {
	cursor: pointer;
}

circle {
	fill: #777;
}

svg image:hover,
body.move {
	cursor: e-resize;
}

footer {
	height: 40px;
	position: relative;
	margin: 0 16px;
	background-color: rgba(99, 99, 99, .1);
	border: solid #999;
	border-width: 1px 0;
}

footer #grid {
	position: absolute; top: 0; bottom: 0; left: 0; right: 0;
	width: 100%;
	display: flex;
	justify-content: space-between;
	align-items: center;
}

footer .dot {
	position: relative;
}

footer .dot::after {
	content: "";
	position: absolute; top: 0; left: 0;
	transform: translateX(-50%) translateY(-50%);
	border: 2px solid #777;
	border-radius: 50%;
}

footer #selector {
	position: absolute; top: 0; bottom: 0; left: 0; right: 0;
	overflow: hidden;
}

#top_text,
#bottom_text {
	text-anchor: start;
}

#area {
	position: absolute;	top: 0; right: 0; bottom: 0; left: 0;
	border : double #999;
	border-width: 0 5px;
}

#area span:first-child {
	position: absolute;	top: 0; right: 0;
}

#area span:last-child {
	position: absolute;	bottom: 0; left: 0;
}

#area span:first-child::after,
#area span:last-child::after {
	content: attr(title);
}

.layout {
	display: none;
}

		</style>
		<script>
		
function resize() {
	window.sRect = selector.getBoundingClientRect();
	window.blockWidth =  window.sRect.width / (window.dayCount -1);
	
	resetArea();
}

/**
 * public
 */
function onSelectDevice(ip) {
	if (top.databases.monitor[ip]) {
		top.databases.local.selected = ip;
	
		top.sendRequest({
			command: "select",
			ip: ip
		}, function (response) {
			top.databases.local.node = response;
		
			location.reload();
		});
	}
	else {
		alert("SNMP is not enabled for "+ ip);
	}
}

function getDateText(mills) {
	var date = new Date(mills),
		dd = date.getDate();
	
	return MONTHS[date.getMonth()] +","+ (dd >9? "": "0") + dd;
}

function initialize() {
	var date = new Date(window.start);
	
	window.dateList = [];
	window.dayCount = 0;
	
	for (; date <= window.end; date.setDate(date.getDate() +1)) {
		window.grid.appendChild(window.dot.cloneNode(true));
		
		window.dateList[window.dayCount] = date.getTime();
		
		window.dayCount++;
	}
	
	window.leftPos = window.dayCount -2;
	window.rightPos = window.dayCount -1;
	
	resize();
}

function onSelectStart(e) {
	var target = e.detail.target;
	
	if (target != window.area) {
		return;
	}
	
	var rect = window.area.getBoundingClientRect();
	
	window.target = e.detail.target;
	window.isDragging = true;
	window.left = rect.left - window.sRect.left;
	window.right = window.sRect.width - rect.width - window.left;
}

function onSelect(e) {
	switch(window.move) {
	case "left":
		var x = window.left + e.detail.dragX;
		
		if (x < 0) {
			return;
		}
		
		onChange(x, window.right);
		
		break;
		
	case "right":
		var x = window.right - e.detail.dragX;
		
		if (x < 0) {
			return;
		}
		
		onChange(window.left, x);
		
		break;
	
	case "area":
		var x1 = window.left + e.detail.dragX,
			x2 = window.right - e.detail.dragX;
		
		if (x1 < 0 || x2 < 0) {
			return;
		}
		
		onChange(x1, x2);
		
		break;
	}
}

function onSelectEnd(e) {
	window.isDragging = false;
	window.target = undefined;
}

function onMove(e) {
	if (window.isDragging) {
		return;
	}
	
	var rect = area.getBoundingClientRect(),
		x = e.clientX - rect.left;
	
	if (x < MARGINS) {
		window.move = "left";
		window.area.style.cursor = 'ew-resize';
	}
	else if (rect.width - x < MARGINS) {
		window.move = "right";
		window.area.style.cursor = 'ew-resize';
	}
	else {
		window.move = "area";
		area.style.cursor = 'move';
	}
}

function onChange(left, right) {
	var leftPos = Math.round(left / window.blockWidth),
		rightPos = Math.round((window.sRect.width - right) / window.blockWidth);
	
	if (isNaN(leftPos) || isNaN(rightPos)) {
		throw "NaN";
	}
	
	if (leftPos >= rightPos) {
		return;
	}
	
	if (window.leftPos == leftPos && window.rightPos == rightPos) {
		return;
	}
	
	window.leftPos = leftPos;
	window.rightPos = rightPos;
	
	resetArea();
	
	window.chartWindow.draw(window.dateList[leftPos], window.dateList[rightPos]);
}

function resetArea() {
	window.area.style.left = window.leftPos * blockWidth + "px";
	window.area.style.right = (window.dayCount -1 - window.rightPos) * blockWidth + "px";
	
	window.startDate.title = getDateText(window.dateList[window.leftPos]);
	window.endDate.title = getDateText(window.dateList[window.rightPos]);
}

		</script>
	</head>
	
	<body>
		
		<header>
			<nav>
				<img width="16" height="16" src="img/realtime.png" id="realtime" title="실시간 차트">
				<img width="16" height="16" src="img/save.png" id="save" title="CSV 파일로 저장">
				<a href="status.html"><img width="16" height="16" src="img/close.png" title="차트 닫기"></a>
			</nav>
		</header>
		
		<iframe id="chart" class="chart"></iframe>
		
		<footer>
			<div id="grid">
			</div>
			<div id="selector">
				<div id="area">
					<span></span>
					<span></span>
				</div>
			</div>
		</footer>
		
		<div class="layout">
			<span class="dot"></span>
		</div>
		
		<script src="js/ITAhM.js"></script>
		<script src="js/Draggable.js"></script>
		<script>

if (parent === window) throw "";		

var chart = document.getElementById("chart"),
	chartWindow = chart.contentWindow,
	deviceIP = top.databases.local.selected,
	resourceIndex = top.databases.local.resourceIndex,
	node = top.databases.local.node;

var 
	MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
	MONTH = ["1 월", "2 월", "3 월", "4 월", "5 월", "6 월", "7 월", "8 월", "9 월", "10월", "11월", "12월"],
	MARGINS = 5;

var svg = document.querySelector("svg"),
	base = document.getElementById("base"),
	dot = document.querySelector(".dot"),
	footer = document.querySelector("footer"),
	area = document.querySelector(".area"),
	grid = document.getElementById("grid"),
	left, right, dayCount, blockWidth, sRect,
	selector = document.getElementById("selector"),
	area = document.getElementById("area"),
	endDate = document.querySelector("#area>:first-child"),
	startDate = document.querySelector("#area>:last-child");

(function (date) {
	date.setHours(0, 0, 0, 0);
	
	window.today = date.getTime();
	window.end = date.setDate(date.getDate() +1);
	window.start = date.setMonth(date.getMonth() -1);
})(new Date());

document.onselectstart = function (e) {
	return false;
};

document.getElementById("save").onclick = function () {
	window.chartWindow.getFile();
};

document.getElementById("realtime").onclick = function () {
	open("realtime.html", "_blank", "width=600, height=300, resizable=yes", false);
};

window.addEventListener("resize", function () {
	if (window.resizeTimer) {
		clearTimeout(window.resizeTimer);
	}
	
	window.resizeTimer = setTimeout(resize, 300);
});

selector.addEventListener("mousemove", onMove);
selector.addEventListener("dragon", onSelectStart);
selector.addEventListener("drag", onSelect);
selector.addEventListener("dragoff", onSelectEnd);

window.chart.onload = function () {
	window.chartWindow.initialize(window.start, window.end, window.today, window.end);
};	

new Draggable(window.selector);

initialize();
	
window.chart.src = "chart_"+ top.databases.local.selectedResource +".html";

		</script>
	
	</body>
	
</html>