<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title></title>
		
		<style>
@import "css/itahm.css";

aside {
	position: fixed; top: 0; bottom: 0; left: 0;
	width: 299px;
	border-right: 1px solid #0084ff;
}

aside form {
	position: absolute; top: 0; right: 0; left: 0;
	padding: 5px;
	box-sizing: border-box;
	height: 49px;
	border-bottom: 1px;
	white-space: nowrap;
	display: flex;
}

aside input[type="text"] {
	flex: 1;
	min-width: 0;
}

#list {
	position: absolute; top: 50px; right: 0; left: 0; bottom: 0;
	padding: 5px;
	overflow: auto;
}

#list ul {
	margin: 0;
	padding: 3px 0;
	list-style: none;
	display: flex;
	cursor: pointer;
}

#list li {
	flex: 1;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
	font-size: 12px;
}

#list ul:hover li:nth-child(2) {
	text-decoration: underline;
	color: #0084ff;
}

#list ul:nth-child(odd) {
	background-color: #fafafa;
}

#list li {
	padding: 3px;
}

#list input,
#list select {
	padding: .5em;
}

section {
	position: fixed; top: 0; right: 0; bottom: 0; left: 300px;
}

iframe {
	border: none;
	width: 100%; height: 100%;
}


		</style>
		
	</head>
	
	<body class="loading">
		<aside>
			<form id="form">
				<select name="label"></select>
				<input type="text" name="keyword">
				<input type="submit" value="search">
			</form>
			
			<div id="list"></div>
		</aside>
		
		<section>
			<iframe id="frame" name="main" src="map.html"></iframe>
		</section>
		
		<div class="bg_loading"></div>
		<script>

(function (window, undefined) {
	var frame = document.getElementById("frame"),
		form = document.getElementById("form"),
		list = document.getElementById("list"),
		rowMap = {},
		labels = {};
	
	frame.addEventListener("load", onLoadFrame);
	form.elements.label.addEventListener("change", onChangeLabel);
	form.addEventListener("submit", onSearch);
	
	initList();
	
	initLabel();
	
	function initList() {
		var df = document.createDocumentFragment();
		
		var deviceData = top.databases.device.data;
		
		for (var id in deviceData) {
			df.appendChild(createRow(deviceData[id]));
		}
		
		list.appendChild(df);
	}
	
	function createRow(device) {
		var row = document.createElement("ul"),
			label;
		
		row.appendChild(document.createElement("li")).textContent = device.name;
		row.appendChild(document.createElement("li")).textContent = device.type;
		row.appendChild(document.createElement("li")).textContent = device.ip;
		
		row.onclick = onSelectDevice.bind(undefined, device.id);
		
		rowMap[device.id] = row;
		
		if (device.label) {
			label = device.label.split(",");
			
			for (var i=0, length=label.length; i<length; i++) {
				row.classList.add(label[i]);
				
				labels[label[i]] = null;
			}
		}
		else {
			row.classList.add("unlabeled");
			
			labels["unlabeled"] = null;
		}
		
		return row;
	}
	
	function initLabel() {
		var select = form.elements.label,
			option = document.createElement("option");
	
		// label select 초기화
		select.length = 0;
		
		option.value = "";
		option.text = "all labels";
		option.selected = true;
		
		select.add(option);
		
		for (var label in labels) {
			option = document.createElement("option");
			
			option.text = label;
			
			select.add(option);
		}
	}
	
	function onLoadFrame(e) {
		document.body.classList.remove("loading");
	}
	
	function onSelectDevice(id) {
		top.databases.device.selected = id;
		
		frame.contentWindow.onSelectDevice(id);
	}
	
	function onStopPropagation(e) {
		e.stopPropagation();
	}
	
	function onSearch(e) {
		e.preventDefault();
		
		// search 결과를 초기화 하기 위해
		selectLabel(form.elements.label.value);

		filterDeviceList(form.elements.keyword.value);
	}
	
	function onChangeLabel(e) {
		form.elements.keyword.value = "";
		
		selectLabel(form.elements.label.value);
	}
	
	function clearDeviceList() {
		var df = document.createDocumentFragment(),
			row;
		
		while (row = list.firstChild) {
			df.appendChild(row);
		}
		
		return df;
	};
	
	function filterDeviceList(keyword) {
		var row = clearDeviceList().firstChild,
			next, cols,
			df = document.createDocumentFragment(),
			device;
		
		while (row) {
			next = row.nextSibling;
			
			cols = row.children;
			
			for (var i=0, length=cols.length; i<length; i++) {
				if (cols[i].textContent.indexOf(keyword) !== -1) {
					df.appendChild(row);
					
					break;
				}
			}
			
			row = next;
		}
		
		list.appendChild(df);
	};
	
	function selectLabel(label) {
		var df = document.createDocumentFragment(),
			rows;
		
		for (var id in rowMap) {
			df.appendChild(rowMap[id]);
		}
		
		if (label) {
			rows = [].slice.call(df.querySelectorAll("."+ label), 0);
			
			df = document.createDocumentFragment();
			
			for (var i=0, length=rows.length; i<length; i++) {
				df.appendChild(rows[i]);
			}
		}
		
		list.appendChild(df);
	};
	
})(window);

		</script>
	
	</body>
	
</html>