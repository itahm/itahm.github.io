<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<title>Manual @ ITAhM</title>
		
		<style>
@import "css/itahm.css";

body {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	display: flex;
	flex-direction: column;
	justify-content: center;
	align-items: center;
}

ol {
	display: inline-block;
	text-align: initial;
}

.bg_loading {
	background-color: rgba(255, 255, 255, 0.6);
}


		</style>
		
	</head>
	
	<body>
		
		<h1>ITAhM Notification!</h1>
		<h2>
			ITAhM 에이전트가 업데이트 되었고 중요한 변화가 있습니다.
		</h2>
		<div>
			<ol>
				<li>아래 최적화 버튼을 눌러 데이터를 최적화 하신후
				<li>에이전트를 업데이트 하세요.
			</ol>
		</div>
		<p>
			<button id="update">데이터 최적화</button>
		</p>
		<p>
			에이전트 다운로드: <a href="http://itahm.com/download/ITAhM.jar" download>http://itahm.com/download/ITAhM.jar</a>
		</p>
		
		<div class="bg_loading"></div>
		
		<script src="js/ITAhM.js"></script>
		<script src="js/object.js"></script>
		<script>

var xhr = new ITAhM.Communicator(sessionStorage.host, sessionStorage.port, 5000);
		
function sendRequest(request, onResponse) {
	xhr.sendRequest(request, function (status, response) {		
		if (status === 200) {
			onResponse(response);
		}
		else {
			alert("오류가 발생하였습니다.");
		}
	});
}

document.getElementById("update").onclick = function () {
	document.body.classList.add("loading");
	
	this.disabled = true;
	
	sendRequest({
		command: "pull",
		database: "device"
	}, function (devData) {
		sendRequest({
			command: "pull",
			database: "position"
		}, function (posData) {
			for (var ip in devData) {
				if (ip in posData) {
					posData[ip].ifEntry = devData[ip].ifEntry;
				}
			}
			
			sendRequest({
				command: "push",
				database: "position",
				data: posData
			}, function (data) {
				alert("데이터를 성공적으로 최적화 하였습니다.\n"
					+"에이전트를 업데이트하고 서비스를 재시작 하십시오.");
				
				
				window.location.href = "itahm.html";
			});
		});
	});
}

		</script>
	
	</body>
	
</html>