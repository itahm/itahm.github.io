<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>Event @ ITAhM</title>
		
		<style>
@import "css/itahm.css";

body {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
}

.content_width {
	height: 100%;
	padding: 10px;
	margin: 0 auto;
	overflow: auto;
}

.network {
	list-style: none;
	padding: .5em 1.5em;
	position: relative;
}

.network input[type="checkbox"] {
	position: absolute; left: 0;
}

.network input[type="checkbox"]:not(:checked) ~ .item {
	display: none;
}

.network:before {
	content: attr(id);
	font-weight: bold;
	font-size: 1.1em;
}

.item {
	display: flex;
	list-style: none;
	padding: .3em; margin: 0;
}

.item li {
	width: 160px;
}


		</style>
	<script>
	
function getNetwork(ip, mask) {
	var ipArray = ip.split("."),
		maskArray = mask.split("."),
		length = ipArray.length;
	
	for (var i=0; i<length; i++) {
		ipArray[i] = ipArray[i] & maskArray[i];
	}
	
	return ipArray.join(".");
}

function getMask(mask) {
	var maskArray = mask.split("."),
		address = 0,
		bits = 0;
	
	while(maskArray.length > 0) {
		address <<= 8;
		address |= maskArray.shift();
	}
	
	while (!(address & 1)) {
		address >>>= 1;
	}
	
	while (address & 1) {
		address >>>= 1;
		
		bits++;
	}
	
	return bits;
}

function getAddressValue(ip) {
	var ipArray = ip.split("."),
		value = 0;

	while(ipArray.length > 0) {
		value <<= 8;
		value |= ipArray.shift();
	}
	
	return value;
}

function createAddrItem(ip, mac) {
	var ul = document.createElement("ul");
	
	ul.appendChild(document.createElement("li")).textContent = ip;
	ul.appendChild(document.createElement("li")).textContent = mac;
	
	ul.className = "item";
	
	return ul;
}

function onSelectNetwork() {
	if (!this.checked) {
		return;
	}
	
	var item = this,
		itemArray = [],
		df = document.createDocumentFragment(),
		count = 0;
	
	while (item = item.nextSibling) {
		itemArray.push(item);
		
		count++;
	}
	
	itemArray.sort(function (a, b) {
		return getAddressValue(a.firstChild.textContent) - getAddressValue(b.firstChild.textContent);
	});
	
	for (var i=0; i<count; i++) {
		df.appendChild(itemArray[i]);
	}
	
	this.parentNode.appendChild(df);
}

	</script>
	
	</head>
	
	<body class="loading">
	
		<div class="content_width">
			<ul id="list"></ul>
		</div>
		
		<div class="bg_loading"></div>
		
		<script src="js/ITAhM.js"></script>
		<script src="js/object.js"></script>
		<script>

if (top === window) {
	location.href = "http://itahm.com";
}

var list = document.getElementById("list"),
	documentFragment = document.createDocumentFragment(),
	items = {};

top.sendRequest({
	command: "network"
}, function (data){
	var item, checkbox;
	
	for (var network in data) {
		item = document.createElement("li");
		
		item.id = network +" /"+ getMask(data[network]);
		item.className = "network";
		
		checkbox = document.createElement("input");
		
		item.appendChild(checkbox).type = "checkbox";
		checkbox.onclick = onSelectNetwork;
		
		items[network] = item;
		
		window.documentFragment.appendChild(item);
	}
	
	top.sendRequest({
		command: "arp"
	}, function (data){
		var address, item;
		
		for (var mac in data) {
			address = data[mac];
			try {
				if (item = items[getNetwork(address.ip, address.mask)]) {
					item.appendChild(createAddrItem(address.ip, mac));
				}
			} catch (e) {
				console.log(address.ip +"는 올바르지 않은 마스크를 가지고 있을 수 있습니다.");
			}
		}
		
		list.appendChild(window.documentFragment);
		
		document.body.classList.remove("loading");
	});
});

		</script>
	
	</body>
	
</html>